create_faceted_forest_plot
head(plot_data)
create_faceted_forest_plot <- function(plot_data) {#
  # Limit to top 16 diseases by dynamic AUC#
  top_diseases <- plot_data %>%#
    filter(model == "Aladynoulli Dynamic") %>%#
    arrange(desc(Events)) %>%#
    head(16) %>%#
    pull(Disease)#
  plot_data_subset <- plot_data %>%#
    filter(Disease %in% top_diseases)#
  plot_data_subset$Disease=factor(plot_data_subset$Disease,levels = top_diseases)#
  # Define colors for models#
  model_colors <- c(#
    "Aladynoulli Dynamic" = "#4285F4",  # Blue#
    "Aladynoulli Static" = "#34A853",   # Green#
    "Cox without Noulli" = "#FBBC05",   # Yellow/Orange#
    "Cox with Noulli" = "#EA4335"       # Red#
  )#
  # Create the faceted plot#
  p <- ggplot(plot_data_subset, aes(x = model, y = auc, color = model)) +#
    geom_point(size = 3) +#
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +#
    facet_wrap(~ Disease, scales = "free_y", ncol = 4) +#
    geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +#
    scale_color_manual(values = model_colors) +#
    scale_y_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Performance across top 16 diseases",#
      y = "AUC (95% CI)",#
      x = NULL#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),#
      strip.text = element_text(face = "bold"),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}
create_faceted_forest_plot
faceted_plot <- create_faceted_forest_plot(plot_data)
facted_plot
faceted_plot
# Alternative approach with facet_wrap for separate panels by disease#
create_faceted_forest_plot <- function(plot_data) {#
  # Limit to top 16 diseases by dynamic AUC#
  top_diseases <- plot_data %>%#
    filter(model == "Aladynoulli Dynamic") %>%#
    arrange(desc(Events)) %>%#
    head(16) %>%#
    pull(Disease)#
  plot_data_subset <- plot_data %>%#
    filter(Disease %in% top_diseases)#
  plot_data_subset$Disease=factor(plot_data_subset$Disease,levels = top_diseases)#
  # Define colors for models#
  model_colors <- c(#
    "Aladynoulli Dynamic" = "#4285F4",  # Blue#
    "Aladynoulli Static" = "#34A853",   # Green#
    "Cox without Noulli" = "#FBBC05",   # Yellow/Orange#
    "Cox with Noulli" = "#EA4335"       # Red#
  )#
  # Create the faceted plot#
  p <- ggplot(plot_data_subset, aes(x = model, y = auc, color = model)) +#
    geom_point(size = 1) +#
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +#
    facet_wrap(~ Disease, scales = "free_y", ncol = 4) +#
    geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +#
    scale_color_manual(values = model_colors) +#
    scale_y_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Performance across top 16 diseases",#
      y = "AUC (95% CI)",#
      x = NULL#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),#
      strip.text = element_text(face = "bold"),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}
faceted_plot <- create_faceted_forest_plot(plot_data)
faceted_plot
model_data
faceted_plot <- create_faceted_forest_plot(plot_data)#
ggsave("multidisease_faceted_plot.pdf", faceted_plot, width = 12, height = 12, dpi = 300)
prescriptions=readRDS("~/Downloads/prescriptions.rds")
head(prescriptions)
write.csv(prescriptions,file="prescriptions.csv",quote=FALSE,row.names=FALSE)
clear()
library(survival)#
library(broom)#
library(dplyr)#
#
FH_processed = read.csv('/Users/sarahurbut/Library/CloudStorage/Dropbox/baselinagefamh.csv')#
#
######
#
disease_names = readRDS("~/aladynoulli2/pyScripts/ukb_model.rds")$disease_names[, 1]#
train_indices = 20001:30000#
major_diseases <- list(#
  ASCVD = c(#
    "Myocardial infarction",#
    "Coronary atherosclerosis",#
    "Other acute and subacute forms of ischemic heart disease",#
    "Unstable angina (intermediate coronary syndrome)",#
    "Angina pectoris",#
    "Other chronic ischemic heart disease, unspecified"#
  ),#
  Diabetes = c("Type 2 diabetes"),#
  Atrial_Fib = c("Atrial fibrillation and flutter"),#
  CKD = c("Chronic renal failure [CKD]", "Chronic Kidney Disease, Stage III"),#
  All_Cancers = c(#
    "Colon cancer",#
    "Malignant neoplasm of rectum, rectosigmoid junction, and anus",#
    "Cancer of bronchus; lung",#
    "Breast cancer [female]",#
    "Malignant neoplasm of female breast",#
    "Cancer of prostate",#
    "Malignant neoplasm of bladder",#
    "Secondary malignant neoplasm",#
    "Secondary malignancy of lymph nodes",#
    "Secondary malignancy of respiratory organs",#
    "Secondary malignant neoplasm of digestive systems",#
    "Secondary malignant neoplasm of liver",#
    "Secondary malignancy of bone"#
  ),#
  Stroke = c(#
    "Cerebral artery occlusion, with cerebral infarction",#
    "Cerebral ischemia"#
  ),#
  Heart_Failure = c("Congestive heart failure (CHF) NOS", "Heart failure NOS"),#
  Pneumonia = c("Pneumonia", "Bacterial pneumonia", "Pneumococcal pneumonia"),#
  COPD = c(#
    "Chronic airway obstruction",#
    "Emphysema",#
    "Obstructive chronic bronchitis"#
  ),#
  Osteoporosis = c("Osteoporosis NOS"),#
  Anemia = c(#
    "Iron deficiency anemias, unspecified or not due to blood loss",#
    "Other anemias"#
  ),#
  Colorectal_Cancer = c(#
    "Colon cancer",#
    "Malignant neoplasm of rectum, rectosigmoid junction, and anus"#
  ),#
  Breast_Cancer = c("Breast cancer [female]", "Malignant neoplasm of female breast"),#
  Prostate_Cancer = c("Cancer of prostate"),#
  Lung_Cancer = c("Cancer of bronchus; lung"),#
  Bladder_Cancer = c("Malignant neoplasm of bladder"),#
  Secondary_Cancer = c(#
    "Secondary malignant neoplasm",#
    "Secondary malignancy of lymph nodes",#
    "Secondary malignancy of respiratory organs",#
    "Secondary malignant neoplasm of digestive systems"#
  ),#
  Depression = c("Major depressive disorder"),#
  Anxiety = c("Anxiety disorder"),#
  Bipolar_Disorder = c("Bipolar"),#
  Rheumatoid_Arthritis = c("Rheumatoid arthritis"),#
  Psoriasis = c("Psoriasis vulgaris"),#
  Ulcerative_Colitis = c("Ulcerative colitis"),#
  Crohns_Disease = c("Regional enteritis"),#
  Asthma = c("Asthma"),#
  Parkinsons = c("Parkinson's disease"),#
  Multiple_Sclerosis = c("Multiple sclerosis"),#
  Thyroid_Disorders = c(#
    "Thyrotoxicosis with or without goiter",#
    "Secondary hypothyroidism",#
    "Hypothyroidism NOS"#
  )#
)#
disease_mapping = list(#
  ASCVD = c('heart_disease', 'heart_disease.1'),#
  Stroke = c('stroke', 'stroke.1'),#
  Diabetes = c('diabetes', 'diabetes.1'),#
  Breast_Cancer = c('breast_cancer', 'breast_cancer.1'),#
  Prostate_Cancer = c('prostate_cancer', 'prostate_cancer.1'),#
  Lung_Cancer = c('lung_cancer', 'lung_cancer.1'),#
  Colorectal_Cancer = c('bowel_cancer', 'bowel_cancer.1'),#
  Depression = character(0),#
  Osteoporosis = character(0),#
  Parkinsons = c('parkinsons', 'parkinsons.1'),#
  COPD = character(0),#
  Anemia = character(0),#
  CKD = character(0),#
  Heart_Failure = c('heart_disease', 'heart_disease.1'),#
  Pneumonia = character(0),#
  Atrial_Fib = character(0),#
  Bladder_Cancer = character(0),#
  Secondary_Cancer = character(0),#
  Anxiety = character(0),#
  Bipolar_Disorder = character(0),#
  Rheumatoid_Arthritis = character(0),#
  Psoriasis = character(0),#
  Ulcerative_Colitis = character(0),#
  Crohns_Disease = character(0),#
  Asthma = character(0),#
  Multiple_Sclerosis = character(0),#
  Thyroid_Disorders = character(0)#
)
Y_train=readRDS("/Users/sarahurbut/Library/CloudStorage/Dropbox/ukb_Y_train.rds")#
FH_processed = read.csv('/Users/sarahurbut/Library/CloudStorage/Dropbox/baselinagefamh.csv')
Y_test=readRDS("/Users/sarahurbut/aladynoulli2/pyScripts/ukb_Y_test.rds")
# Load the time-varying probabilities#
pi_train_full <- readRDS("/Users/sarahurbut/Library/CloudStorage/Dropbox/pi_full_sex_20000_30000.rds")#
pi_test_full <- readRDS("/Users/sarahurbut/Library/CloudStorage/Dropbox/pi_full_sex_0_10000.rds")
train_indices
FH_train <- FH_processed[train_indices, ]
dim(FH_train)
names(major_diseases)[1]
disease_group=names(major_diseases)[1]
fh_cols <- disease_mapping[[disease_group]]
fh_cols
mask_train <- rep(TRUE, nrow(FH_train))
current_FH_train <- FH_train[mask_train, ]
dim(current_FH_train)
dim(current_Y_train)
current_Y_train <- Y_train[mask_train, , , drop = FALSE]
dim(current_Y_train)
disease_indices <- unlist(lapply(major_diseases[[disease_group]], function(disease) {#
      which(tolower(disease_names) == tolower(disease))#
    }))
disease_indices
disease_names[disease_indices]
tdc_data <- data.frame()#
    for (i in seq_len(nrow(current_FH_train))) {#
      age_at_enrollment <- current_FH_train$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_train)[3]) next#
      # Prevalent disease check#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_train[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_train)[3])#
      # Create time intervals for each year#
      for (t in t_enroll:(end_time-1)) {#
        # Check if event occurred in this interval#
        ymat <- current_Y_train[i, disease_indices, t:(t+1), drop = TRUE]#
        event <- if (length(disease_indices) == 1) {#
          any(ymat == 1)#
        } else {#
          any(ymat == 1)#
        }#
        # Create row for this time interval#
        row <- data.frame(#
          id = i,#
          start = t + 29,#
          stop = t + 30,#
          event = event,#
          sex = current_FH_train$sex[i]#
        )#
        if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_train))) {#
          row$fh <- any(current_FH_train[i, fh_cols])#
        }#
        if (!is.null(current_pi_train)) {#
          # Get the noulli prediction for this time point#
          pi_diseases <- current_pi_train[i, disease_indices, t]#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          row$noulli_risk <- yearly_risk#
        }#
        tdc_data <- rbind(tdc_data, row)#
      }#
    }
follow_up_duration_years=10
tdc_data <- data.frame()#
    for (i in seq_len(nrow(current_FH_train))) {#
      age_at_enrollment <- current_FH_train$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_train)[3]) next#
      # Prevalent disease check#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_train[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_train)[3])#
      # Create time intervals for each year#
      for (t in t_enroll:(end_time-1)) {#
        # Check if event occurred in this interval#
        ymat <- current_Y_train[i, disease_indices, t:(t+1), drop = TRUE]#
        event <- if (length(disease_indices) == 1) {#
          any(ymat == 1)#
        } else {#
          any(ymat == 1)#
        }#
        # Create row for this time interval#
        row <- data.frame(#
          id = i,#
          start = t + 29,#
          stop = t + 30,#
          event = event,#
          sex = current_FH_train$sex[i]#
        )#
        if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_train))) {#
          row$fh <- any(current_FH_train[i, fh_cols])#
        }#
        if (!is.null(current_pi_train)) {#
          # Get the noulli prediction for this time point#
          pi_diseases <- current_pi_train[i, disease_indices, t]#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          row$noulli_risk <- yearly_risk#
        }#
        tdc_data <- rbind(tdc_data, row)#
      }#
    }
current_pi_train=pi_train
current_pi_train=pi_train_full
tdc_data <- data.frame()#
    for (i in seq_len(nrow(current_FH_train))) {#
      age_at_enrollment <- current_FH_train$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_train)[3]) next#
      # Prevalent disease check#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_train[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_train)[3])#
      # Create time intervals for each year#
      for (t in t_enroll:(end_time-1)) {#
        # Check if event occurred in this interval#
        ymat <- current_Y_train[i, disease_indices, t:(t+1), drop = TRUE]#
        event <- if (length(disease_indices) == 1) {#
          any(ymat == 1)#
        } else {#
          any(ymat == 1)#
        }#
        # Create row for this time interval#
        row <- data.frame(#
          id = i,#
          start = t + 29,#
          stop = t + 30,#
          event = event,#
          sex = current_FH_train$sex[i]#
        )#
        if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_train))) {#
          row$fh <- any(current_FH_train[i, fh_cols])#
        }#
        if (!is.null(current_pi_train)) {#
          # Get the noulli prediction for this time point#
          pi_diseases <- current_pi_train[i, disease_indices, t]#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          row$noulli_risk <- yearly_risk#
        }#
        tdc_data <- rbind(tdc_data, row)#
      }#
    }
}
}#
}
for (i in seq_len(nrow(current_FH_train))) {#
      age_at_enrollment <- current_FH_train$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_train)[3]) next#
      # Prevalent disease check#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_train[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_train)[3])#
      # Create time intervals for each year#
      for (t in t_enroll:(end_time-1)) {#
        # Check if event occurred in this interval#
        ymat <- current_Y_train[i, disease_indices, t:(t+1), drop = TRUE]#
        event <- if (length(disease_indices) == 1) {#
          any(ymat == 1)#
        } else {#
          any(ymat == 1)#
        }#
        # Create row for this time interval#
        row <- data.frame(#
          id = i,#
          start = t + 29,#
          stop = t + 30,#
          event = event,#
          sex = current_FH_train$sex[i]#
        )#
        if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_train))) {#
          row$fh <- any(current_FH_train[i, fh_cols])#
        }#
        if (!is.null(current_pi_train)) {#
          # Get the noulli prediction for this time point#
          pi_diseases <- current_pi_train[i, disease_indices, t]#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          row$noulli_risk <- yearly_risk#
        }#
        tdc_data <- rbind(tdc_data, row)#
      }}
for (i in seq_len(nrow(current_FH_train))) {#
      age_at_enrollment <- current_FH_train$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_train)[3]) next#
      # Prevalent disease check#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_train[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_train)[3])#
      # Create time intervals for each year#
      for (t in t_enroll:(end_time-1)) {#
        # Check if event occurred in this interval#
        ymat <- current_Y_train[i, disease_indices, t:(t+1), drop = TRUE]#
        event <- if (length(disease_indices) == 1) {#
          any(ymat == 1)#
        } else {#
          any(ymat == 1)#
        }#
        # Create row for this time interval#
        row <- data.frame(#
          id = i,#
          start = t + 29,#
          stop = t + 30,#
          event = event,#
          sex = current_FH_train$sex[i]#
        )#
        if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_train))) {#
          row$fh <- any(current_FH_train[i, fh_cols])#
        }#
        if (!is.null(current_pi_train)) {#
          # Get the noulli prediction for this time point#
          pi_diseases <- current_pi_train[i, disease_indices, t]#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          row$noulli_risk <- yearly_risk#
        }#
        tdc_data <- rbind(tdc_data, row)#
      }#
    }
for (i in seq_len(nrow(current_FH_train))) {#
      age_at_enrollment <- current_FH_train$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_train)[3]) next#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_train[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_train)[3])#
      total_rows <- total_rows + (end_time - t_enroll)#
    }#
    print(paste("Total rows needed:", total_rows))#
    print(paste("Time for row calculation:", Sys.time() - start_time))#
    # Pre-allocate data frame#
    print("Pre-allocating data frame...")#
    start_time <- Sys.time()#
    tdc_data <- data.frame(#
      id = integer(total_rows),#
      start = numeric(total_rows),#
      stop = numeric(total_rows),#
      event = logical(total_rows),#
      sex = integer(total_rows)#
    )#
    if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_train))) {#
      tdc_data$fh <- logical(total_rows)#
    }#
    if (!is.null(current_pi_train)) {#
      tdc_data$noulli_risk <- numeric(total_rows)#
    }#
    print(paste("Time for pre-allocation:", Sys.time() - start_time))#
    # Fill the data frame#
    print("Filling data frame...")#
    start_time <- Sys.time()#
    row_idx <- 1#
    for (i in seq_len(nrow(current_FH_train))) {#
      if (i %% 1000 == 0) {#
        print(paste("Processing individual", i, "of", nrow(current_FH_train)))#
        print(paste("Time so far:", Sys.time() - start_time))#
      }#
      age_at_enrollment <- current_FH_train$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_train)[3]) next#
      # Prevalent disease check#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_train[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_train)[3])#
      # Create time intervals for each year#
      for (t in t_enroll:(end_time-1)) {#
        # Check if event occurred in this interval#
        ymat <- current_Y_train[i, disease_indices, t:(t+1), drop = TRUE]#
        event <- if (length(disease_indices) == 1) {#
          any(ymat == 1)#
        } else {#
          any(ymat == 1)#
        }#
        # Fill row#
        tdc_data$id[row_idx] <- i#
        tdc_data$start[row_idx] <- t + 29#
        tdc_data$stop[row_idx] <- t + 30#
        tdc_data$event[row_idx] <- event#
        tdc_data$sex[row_idx] <- current_FH_train$sex[i]#
        if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_train))) {#
          tdc_data$fh[row_idx] <- any(current_FH_train[i, fh_cols])#
        }#
        if (!is.null(current_pi_train)) {#
          pi_diseases <- current_pi_train[i, disease_indices, t]#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          tdc_data$noulli_risk[row_idx] <- yearly_risk#
        }#
        row_idx <- row_idx + 1#
      }#
    }#
    print(paste("Total time for filling:", Sys.time() - start_time))
head(tdc_data)
head(FH_train[1,])
1-prod(pi_train_full[1,disease_indices,54-29])
if (i == 1) {#
        print("First person details:")#
        print(paste("Age at enrollment:", current_FH_train$age[i]))#
        print(paste("t_enroll:", as.integer(current_FH_train$age[i] - 29)))#
        if (!is.null(current_pi_train)) {#
          pi_diseases <- current_pi_train[i, disease_indices, as.integer(current_FH_train$age[i] - 29)]#
          print("Pi values for diseases:")#
          print(pi_diseases)#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          print(paste("Yearly risk:", yearly_risk))#
        }#
      }
i=1
if (i == 1) {#
        print("First person details:")#
        print(paste("Age at enrollment:", current_FH_train$age[i]))#
        print(paste("t_enroll:", as.integer(current_FH_train$age[i] - 29)))#
        if (!is.null(current_pi_train)) {#
          pi_diseases <- current_pi_train[i, disease_indices, as.integer(current_FH_train$age[i] - 29)]#
          print("Pi values for diseases:")#
          print(pi_diseases)#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          print(paste("Yearly risk:", yearly_risk))#
        }#
      }
if (i == 1) {#
        print("First person details:")#
        print(paste("Age at enrollment:", current_FH_train$age[i]))#
        print(paste("t_enroll:", as.integer(current_FH_train$age[i] - 29)))#
        if (!is.null(current_pi_train)) {#
          pi_diseases <- current_pi_train[i, disease_indices, as.integer(current_FH_train$age[i] - 29)]#
          print("Pi values for diseases:")#
          print(pi_diseases)#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          print(paste("Yearly risk:", yearly_risk))#
        }#
      }
current_pi_train[i, disease_indices, as.integer(current_FH_train$age[i] - 29)]
1-current_pi_train[i, disease_indices, as.integer(current_FH_train$age[i] - 29)]
prod(1-current_pi_train[i, disease_indices, as.integer(current_FH_train$age[i] - 29)])
1-prod(1-current_pi_train[i, disease_indices, as.integer(current_FH_train$age[i] - 29)])
# Function for time-dependent Cox modeling#
fit_time_dependent_cox <- function(Y_train,#
                                 FH_processed,#
                                 train_indices,#
                                 disease_mapping,#
                                 major_diseases,#
                                 disease_names,#
                                 follow_up_duration_years = 10,#
                                 pi_train = NULL) {#
  fitted_models <- list()#
  FH_train <- FH_processed[train_indices, ]#
  for (disease_group in names(major_diseases)) {#
    fh_cols <- disease_mapping[[disease_group]]#
    if (is.null(fh_cols)) fh_cols <- character(0)#
    if (length(fh_cols) == 0)#
      cat(sprintf(" - %s: No FH columns, fitting Sex only.\n", disease_group))#
    cat(sprintf(" - Fitting time-dependent Cox for %s...\n", disease_group))#
    target_sex_code <- NA#
    if (disease_group == "Breast_Cancer")#
      target_sex_code <- 0#
    if (disease_group == "Prostate_Cancer")#
      target_sex_code <- 1#
    if (!is.na(target_sex_code)) {#
      mask_train <- FH_train$sex == target_sex_code#
    } else {#
      mask_train <- rep(TRUE, nrow(FH_train))#
    }#
    current_FH_train <- FH_train[mask_train, ]#
    current_Y_train <- Y_train[mask_train, , , drop = FALSE]#
    if (!is.null(pi_train)) {#
      current_pi_train <- pi_train[mask_train, , , drop = FALSE]#
    } else {#
      current_pi_train <- NULL#
    }#
    if (nrow(current_FH_train) == 0) {#
      cat(sprintf("   Warning: No individuals for target sex code %s in training slice.\n", target_sex_code))#
      fitted_models[[disease_group]] <- NULL#
      next#
    }#
    # Find disease indices#
    disease_indices <- unlist(lapply(major_diseases[[disease_group]], function(disease) {#
      which(tolower(disease_names) == tolower(disease))#
    }))#
    if (length(disease_indices) == 0) {#
      fitted_models[[disease_group]] <- NULL#
      next#
    }#
    # Pre-calculate total number of rows needed#
    total_rows <- 0#
    print("Calculating total rows needed...")#
    start_time <- Sys.time()#
    for (i in seq_len(nrow(current_FH_train))) {#
      age_at_enrollment <- current_FH_train$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_train)[3]) next#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_train[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_train)[3])#
      total_rows <- total_rows + (end_time - t_enroll)#
    }#
    print(paste("Total rows needed:", total_rows))#
    print(paste("Time for row calculation:", Sys.time() - start_time))#
    # Pre-allocate data frame#
    print("Pre-allocating data frame...")#
    start_time <- Sys.time()#
    tdc_data <- data.frame(#
      id = integer(total_rows),#
      start = numeric(total_rows),#
      stop = numeric(total_rows),#
      event = logical(total_rows),#
      sex = integer(total_rows)#
    )#
    if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_train))) {#
      tdc_data$fh <- logical(total_rows)#
    }#
    if (!is.null(current_pi_train)) {#
      tdc_data$noulli_risk <- numeric(total_rows)#
    }#
    print(paste("Time for pre-allocation:", Sys.time() - start_time))#
    # Fill the data frame#
    print("Filling data frame...")#
    start_time <- Sys.time()#
    row_idx <- 1#
    for (i in seq_len(nrow(current_FH_train))) {#
      if (i == 1) {#
        print("First person details:")#
        print(paste("Age at enrollment:", current_FH_train$age[i]))#
        print(paste("t_enroll:", as.integer(current_FH_train$age[i] - 29)))#
        if (!is.null(current_pi_train)) {#
          pi_diseases <- current_pi_train[i, disease_indices, as.integer(current_FH_train$age[i] - 29)]#
          print("Pi values for diseases:")#
          print(pi_diseases)#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          print(paste("Yearly risk:", yearly_risk))#
        }#
      }#
      if (i %% 1000 == 0) {#
        print(paste("Processing individual", i, "of", nrow(current_FH_train)))#
        print(paste("Time so far:", Sys.time() - start_time))#
      }#
      age_at_enrollment <- current_FH_train$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_train)[3]) next#
      # Prevalent disease check#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_train[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_train)[3])#
      # Create time intervals for each year#
      for (t in t_enroll:(end_time-1)) {#
        # Check if event occurred in this interval#
        ymat <- current_Y_train[i, disease_indices, t:(t+1), drop = TRUE]#
        event <- if (length(disease_indices) == 1) {#
          any(ymat == 1)#
        } else {#
          any(ymat == 1)#
        }#
        # Fill row#
        tdc_data$id[row_idx] <- i#
        tdc_data$start[row_idx] <- t + 29#
        tdc_data$stop[row_idx] <- t + 30#
        tdc_data$event[row_idx] <- event#
        tdc_data$sex[row_idx] <- current_FH_train$sex[i]#
        if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_train))) {#
          tdc_data$fh[row_idx] <- any(current_FH_train[i, fh_cols])#
        }#
        if (!is.null(current_pi_train)) {#
          pi_diseases <- current_pi_train[i, disease_indices, t]#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          tdc_data$noulli_risk[row_idx] <- yearly_risk#
        }#
        row_idx <- row_idx + 1#
      }#
    }#
    print(paste("Total time for filling:", Sys.time() - start_time))#
    # Trim any unused rows#
    print(paste("Final row count:", row_idx-1))#
    print("Trimming unused rows...")#
    start_time <- Sys.time()#
    tdc_data <- tdc_data[1:(row_idx-1), ]#
    print(paste("Time for trimming:", Sys.time() - start_time))#
    print("Data frame complete")#
    print(paste("Number of events:", sum(tdc_data$event)))#
    print(paste("Number of unique individuals:", length(unique(tdc_data$id))))#
    if (nrow(tdc_data) == 0 || sum(tdc_data$event) < 5) {#
      cat(sprintf("   Warning: Too few events (%d) for %s\n", sum(tdc_data$event), disease_group))#
      fitted_models[[disease_group]] <- NULL#
      next#
    }#
    # Fit time-dependent Cox model#
    formula_str <- "Surv(start, stop, event) ~ sex"#
    if ("fh" %in% colnames(tdc_data))#
      formula_str <- "Surv(start, stop, event) ~ sex + fh"#
    if (!is.na(target_sex_code)) {#
      formula_str <- if ("fh" %in% colnames(tdc_data))#
        "Surv(start, stop, event) ~ fh"#
      else#
        "Surv(start, stop, event) ~ 1"#
    }#
    if (!is.null(pi_train) && "noulli_risk" %in% colnames(tdc_data))#
      formula_str <- paste(formula_str, "+ noulli_risk")#
    print(formula_str)#
    fit <- try(coxph(as.formula(formula_str), data = tdc_data, id = id), silent = TRUE)#
    if (inherits(fit, "try-error")) {#
      cat(sprintf("   Error fitting %s: %s\n", disease_group, fit))#
      fitted_models[[disease_group]] <- NULL#
    } else {#
      fitted_models[[disease_group]] <- fit#
      cat(sprintf("   Model fitted for %s using %d time intervals.\n", disease_group, nrow(tdc_data)))#
    }#
  }#
  return(fitted_models)#
}
tdc_models <- fit_time_dependent_cox(#
  Y_train = Y_train,#
  FH_processed = FH_processed,#
  train_indices = 20001:30000,#
  disease_mapping = disease_mapping,#
  major_diseases = major_diseases,#
  disease_names = disease_names,#
  follow_up_duration_years = 10,#
  pi_train = pi_train_full#
)
# Function for time-dependent Cox modeling#
fit_time_dependent_cox <- function(Y_train,#
                                 FH_processed,#
                                 train_indices,#
                                 disease_mapping,#
                                 major_diseases,#
                                 disease_names,#
                                 follow_up_duration_years = 10,#
                                 pi_train = NULL) {#
  fitted_models <- list()#
  FH_train <- FH_processed[train_indices, ]#
  for (disease_group in names(major_diseases)) {#
    fh_cols <- disease_mapping[[disease_group]]#
    if (is.null(fh_cols)) fh_cols <- character(0)#
    if (length(fh_cols) == 0)#
      cat(sprintf(" - %s: No FH columns, fitting Sex only.\n", disease_group))#
    cat(sprintf(" - Fitting time-dependent Cox for %s...\n", disease_group))#
    target_sex_code <- NA#
    if (disease_group == "Breast_Cancer")#
      target_sex_code <- 0#
    if (disease_group == "Prostate_Cancer")#
      target_sex_code <- 1#
    if (!is.na(target_sex_code)) {#
      mask_train <- FH_train$sex == target_sex_code#
    } else {#
      mask_train <- rep(TRUE, nrow(FH_train))#
    }#
    current_FH_train <- FH_train[mask_train, ]#
    current_Y_train <- Y_train[mask_train, , , drop = FALSE]#
    if (!is.null(pi_train)) {#
      current_pi_train <- pi_train[mask_train, , , drop = FALSE]#
    } else {#
      current_pi_train <- NULL#
    }#
    if (nrow(current_FH_train) == 0) {#
      cat(sprintf("   Warning: No individuals for target sex code %s in training slice.\n", target_sex_code))#
      fitted_models[[disease_group]] <- NULL#
      next#
    }#
    # Find disease indices#
    disease_indices <- unlist(lapply(major_diseases[[disease_group]], function(disease) {#
      which(tolower(disease_names) == tolower(disease))#
    }))#
    if (length(disease_indices) == 0) {#
      fitted_models[[disease_group]] <- NULL#
      next#
    }#
    # Pre-calculate total number of rows needed#
    total_rows <- 0#
    print("Calculating total rows needed...")#
    start_time <- Sys.time()#
    for (i in seq_len(nrow(current_FH_train))) {#
      age_at_enrollment <- current_FH_train$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_train)[3]) next#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_train[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_train)[3])#
      total_rows <- total_rows + (end_time - t_enroll)#
    }#
    print(paste("Total rows needed:", total_rows))#
    print(paste("Time for row calculation:", Sys.time() - start_time))#
    # Pre-allocate data frame#
    print("Pre-allocating data frame...")#
    start_time <- Sys.time()#
    tdc_data <- data.frame(#
      id = integer(total_rows),#
      start = numeric(total_rows),#
      stop = numeric(total_rows),#
      event = logical(total_rows),#
      sex = integer(total_rows)#
    )#
    if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_train))) {#
      tdc_data$fh <- logical(total_rows)#
    }#
    if (!is.null(current_pi_train)) {#
      tdc_data$noulli_risk <- numeric(total_rows)#
    }#
    print(paste("Time for pre-allocation:", Sys.time() - start_time))#
    # Fill the data frame#
    print("Filling data frame...")#
    start_time <- Sys.time()#
    row_idx <- 1#
    for (i in seq_len(nrow(current_FH_train))) {#
      if (i == 1) {#
        print("First person details:")#
        print(paste("Age at enrollment:", current_FH_train$age[i]))#
        print(paste("t_enroll:", as.integer(current_FH_train$age[i] - 29)))#
        if (!is.null(current_pi_train)) {#
          pi_diseases <- current_pi_train[i, disease_indices, as.integer(current_FH_train$age[i] - 29)]#
          print("Pi values for diseases:")#
          print(pi_diseases)#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          print(paste("Yearly risk:", yearly_risk))#
        }#
      }#
      if (i %% 1000 == 0) {#
        print(paste("Processing individual", i, "of", nrow(current_FH_train)))#
        print(paste("Time so far:", Sys.time() - start_time))#
      }#
      age_at_enrollment <- current_FH_train$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_train)[3]) next#
      # Prevalent disease check#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_train[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_train)[3])#
      # Create time intervals for each year#
      for (t in t_enroll:(end_time-1)) {#
        # Check if event occurred in this interval#
        ymat <- current_Y_train[i, disease_indices, t:(t+1), drop = TRUE]#
        event <- if (length(disease_indices) == 1) {#
          any(ymat == 1)#
        } else {#
          any(ymat == 1)#
        }#
        # Fill row#
        tdc_data$id[row_idx] <- i#
        tdc_data$start[row_idx] <- t + 29#
        tdc_data$stop[row_idx] <- t + 30#
        tdc_data$event[row_idx] <- event#
        tdc_data$sex[row_idx] <- current_FH_train$sex[i]#
        if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_train))) {#
          tdc_data$fh[row_idx] <- any(current_FH_train[i, fh_cols])#
        }#
        if (!is.null(current_pi_train)) {#
          pi_diseases <- current_pi_train[i, disease_indices, t]#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          tdc_data$noulli_risk[row_idx] <- yearly_risk#
        }#
        row_idx <- row_idx + 1#
        # Stop if event occurred#
        if (event) {#
          if (i == 1) {#
            print(paste("First person had event at age", t + 30))#
          }#
          break#
        }#
      }#
    }#
    print(paste("Total time for filling:", Sys.time() - start_time))#
    # Trim any unused rows#
    print(paste("Final row count:", row_idx-1))#
    print("Trimming unused rows...")#
    start_time <- Sys.time()#
    tdc_data <- tdc_data[1:(row_idx-1), ]#
    print(paste("Time for trimming:", Sys.time() - start_time))#
    print("Data frame complete")#
    print(paste("Number of events:", sum(tdc_data$event)))#
    print(paste("Number of unique individuals:", length(unique(tdc_data$id))))#
    print(paste("Average rows per person:", nrow(tdc_data)/length(unique(tdc_data$id))))#
    if (nrow(tdc_data) == 0 || sum(tdc_data$event) < 5) {#
      cat(sprintf("   Warning: Too few events (%d) for %s\n", sum(tdc_data$event), disease_group))#
      fitted_models[[disease_group]] <- NULL#
      next#
    }#
    # Fit time-dependent Cox model#
    formula_str <- "Surv(start, stop, event) ~ sex"#
    if ("fh" %in% colnames(tdc_data))#
      formula_str <- "Surv(start, stop, event) ~ sex + fh"#
    if (!is.na(target_sex_code)) {#
      formula_str <- if ("fh" %in% colnames(tdc_data))#
        "Surv(start, stop, event) ~ fh"#
      else#
        "Surv(start, stop, event) ~ 1"#
    }#
    if (!is.null(pi_train) && "noulli_risk" %in% colnames(tdc_data))#
      formula_str <- paste(formula_str, "+ noulli_risk")#
    print(formula_str)#
    fit <- try(coxph(as.formula(formula_str), data = tdc_data, id = id), silent = TRUE)#
    if (inherits(fit, "try-error")) {#
      cat(sprintf("   Error fitting %s: %s\n", disease_group, fit))#
      fitted_models[[disease_group]] <- NULL#
    } else {#
      fitted_models[[disease_group]] <- fit#
      cat(sprintf("   Model fitted for %s using %d time intervals.\n", disease_group, nrow(tdc_data)))#
    }#
  }#
  return(fitted_models)#
}
tdc_models <- fit_time_dependent_cox(#
  Y_train = Y_train,#
  FH_processed = FH_processed,#
  train_indices = 20001:30000,#
  disease_mapping = disease_mapping,#
  major_diseases = major_diseases,#
  disease_names = disease_names,#
  follow_up_duration_years = 10,#
  pi_train = pi_train_full#
)
fit_time_dependent_cox <- function(Y_train,#
                                 FH_processed,#
                                 train_indices,#
                                 disease_mapping,#
                                 major_diseases,#
                                 disease_names,#
                                 follow_up_duration_years = 10,#
                                 pi_train = NULL) {#
  fitted_models <- list()#
  FH_train <- FH_processed[train_indices, ]#
  for (disease_group in names(major_diseases)) {#
    fh_cols <- disease_mapping[[disease_group]]#
    if (is.null(fh_cols)) fh_cols <- character(0)#
    if (length(fh_cols) == 0)#
      cat(sprintf(" - %s: No FH columns, fitting Sex only.\n", disease_group))#
    cat(sprintf(" - Fitting time-dependent Cox for %s...\n", disease_group))#
    target_sex_code <- NA#
    if (disease_group == "Breast_Cancer")#
      target_sex_code <- 0#
    if (disease_group == "Prostate_Cancer")#
      target_sex_code <- 1#
    if (!is.na(target_sex_code)) {#
      mask_train <- FH_train$sex == target_sex_code#
    } else {#
      mask_train <- rep(TRUE, nrow(FH_train))#
    }#
    current_FH_train <- FH_train[mask_train, ]#
    current_Y_train <- Y_train[mask_train, , , drop = FALSE]#
    if (!is.null(pi_train)) {#
      current_pi_train <- pi_train[mask_train, , , drop = FALSE]#
    } else {#
      current_pi_train <- NULL#
    }#
    if (nrow(current_FH_train) == 0) {#
      cat(sprintf("   Warning: No individuals for target sex code %s in training slice.\n", target_sex_code))#
      fitted_models[[disease_group]] <- NULL#
      next#
    }#
    # Find disease indices#
    disease_indices <- unlist(lapply(major_diseases[[disease_group]], function(disease) {#
      which(tolower(disease_names) == tolower(disease))#
    }))#
    if (length(disease_indices) == 0) {#
      fitted_models[[disease_group]] <- NULL#
      next#
    }#
    # Pre-calculate total number of rows needed#
    total_rows <- 0#
    print("Calculating total rows needed...")#
    start_time <- Sys.time()#
    for (i in seq_len(nrow(current_FH_train))) {#
      age_at_enrollment <- current_FH_train$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_train)[3]) next#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_train[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_train)[3])#
      total_rows <- total_rows + (end_time - t_enroll)#
    }#
    print(paste("Total rows needed:", total_rows))#
    print(paste("Time for row calculation:", Sys.time() - start_time))#
    # Pre-allocate data frame#
    print("Pre-allocating data frame...")#
    start_time <- Sys.time()#
    tdc_data <- data.frame(#
      id = integer(total_rows),#
      start = numeric(total_rows),#
      stop = numeric(total_rows),#
      event = logical(total_rows),#
      sex = integer(total_rows)#
    )#
    if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_train))) {#
      tdc_data$fh <- logical(total_rows)#
    }#
    if (!is.null(current_pi_train)) {#
      tdc_data$noulli_risk <- numeric(total_rows)#
    }#
    print(paste("Time for pre-allocation:", Sys.time() - start_time))#
    # Fill the data frame#
    print("Filling data frame...")#
    start_time <- Sys.time()#
    row_idx <- 1#
    for (i in seq_len(nrow(current_FH_train))) {#
      if (i == 1) {#
        print("First person details:")#
        print(paste("Age at enrollment:", current_FH_train$age[i]))#
        print(paste("t_enroll:", as.integer(current_FH_train$age[i] - 29)))#
        if (!is.null(current_pi_train)) {#
          pi_diseases <- current_pi_train[i, disease_indices, as.integer(current_FH_train$age[i] - 29)]#
          print("Pi values for diseases:")#
          print(pi_diseases)#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          print(paste("Yearly risk:", yearly_risk))#
        }#
      }#
      if (i %% 1000 == 0) {#
        print(paste("Processing individual", i, "of", nrow(current_FH_train)))#
        print(paste("Time so far:", Sys.time() - start_time))#
      }#
      age_at_enrollment <- current_FH_train$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_train)[3]) next#
      # Prevalent disease check#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_train[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_train)[3])#
      # Create time intervals for each year#
      for (t in t_enroll:(end_time-1)) {#
        # Check if event occurred in this interval#
        ymat <- current_Y_train[i, disease_indices, t:(t+1), drop = TRUE]#
        event <- if (length(disease_indices) == 1) {#
          any(ymat == 1)#
        } else {#
          any(ymat == 1)#
        }#
        # Fill row#
        tdc_data$id[row_idx] <- i#
        tdc_data$start[row_idx] <- t + 29#
        tdc_data$stop[row_idx] <- t + 30#
        tdc_data$event[row_idx] <- event#
        tdc_data$sex[row_idx] <- current_FH_train$sex[i]#
        if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_train))) {#
          tdc_data$fh[row_idx] <- any(current_FH_train[i, fh_cols])#
        }#
        if (!is.null(current_pi_train)) {#
          pi_diseases <- current_pi_train[i, disease_indices, t]#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          tdc_data$noulli_risk[row_idx] <- yearly_risk#
        }#
        row_idx <- row_idx + 1#
        # Stop if event occurred#
        if (event) {#
          if (i == 1) {#
            print(paste("First person had event at age", t + 30))#
            print(paste("Event occurred in interval", t, "to", t+1))#
          }#
          break#
        }#
      }#
    }#
    print(paste("Total time for filling:", Sys.time() - start_time))#
    # Trim any unused rows#
    print(paste("Final row count:", row_idx-1))#
    print("Trimming unused rows...")#
    start_time <- Sys.time()#
    tdc_data <- tdc_data[1:(row_idx-1), ]#
    print(paste("Time for trimming:", Sys.time() - start_time))#
    print("Data frame complete")#
    print(paste("Number of events:", sum(tdc_data$event)))#
    print(paste("Number of unique individuals:", length(unique(tdc_data$id))))#
    print(paste("Average rows per person:", nrow(tdc_data)/length(unique(tdc_data$id))))#
    print(paste("Number of people with events:", sum(tdc_data$event)))#
    if (nrow(tdc_data) == 0 || sum(tdc_data$event) < 5) {#
      cat(sprintf("   Warning: Too few events (%d) for %s\n", sum(tdc_data$event), disease_group))#
      fitted_models[[disease_group]] <- NULL#
      next#
    }#
    # Fit time-dependent Cox model#
    formula_str <- "Surv(start, stop, event) ~ sex"#
    if ("fh" %in% colnames(tdc_data))#
      formula_str <- "Surv(start, stop, event) ~ sex + fh"#
    if (!is.na(target_sex_code)) {#
      formula_str <- if ("fh" %in% colnames(tdc_data))#
        "Surv(start, stop, event) ~ fh"#
      else#
        "Surv(start, stop, event) ~ 1"#
    }#
    if (!is.null(pi_train) && "noulli_risk" %in% colnames(tdc_data))#
      formula_str <- paste(formula_str, "+ noulli_risk")#
    print(formula_str)#
    fit <- try(coxph(as.formula(formula_str), data = tdc_data, id = id), silent = TRUE)#
    if (inherits(fit, "try-error")) {#
      cat(sprintf("   Error fitting %s: %s\n", disease_group, fit))#
      fitted_models[[disease_group]] <- NULL#
    } else {#
      fitted_models[[disease_group]] <- fit#
      cat(sprintf("   Model fitted for %s using %d time intervals.\n", disease_group, nrow(tdc_data)))#
    }#
  }#
  return(fitted_models)#
}
fit_time_dependent_cox <- function(Y_train,#
                                 FH_processed,#
                                 train_indices,#
                                 disease_mapping,#
                                 major_diseases,#
                                 disease_names,#
                                 follow_up_duration_years = 10,#
                                 pi_train = NULL) {#
  fitted_models <- list()#
  FH_train <- FH_processed[train_indices, ]#
  for (disease_group in names(major_diseases)) {#
    fh_cols <- disease_mapping[[disease_group]]#
    if (is.null(fh_cols)) fh_cols <- character(0)#
    if (length(fh_cols) == 0)#
      cat(sprintf(" - %s: No FH columns, fitting Sex only.\n", disease_group))#
    cat(sprintf(" - Fitting time-dependent Cox for %s...\n", disease_group))#
    target_sex_code <- NA#
    if (disease_group == "Breast_Cancer")#
      target_sex_code <- 0#
    if (disease_group == "Prostate_Cancer")#
      target_sex_code <- 1#
    if (!is.na(target_sex_code)) {#
      mask_train <- FH_train$sex == target_sex_code#
    } else {#
      mask_train <- rep(TRUE, nrow(FH_train))#
    }#
    current_FH_train <- FH_train[mask_train, ]#
    current_Y_train <- Y_train[mask_train, , , drop = FALSE]#
    if (!is.null(pi_train)) {#
      current_pi_train <- pi_train[mask_train, , , drop = FALSE]#
    } else {#
      current_pi_train <- NULL#
    }#
    if (nrow(current_FH_train) == 0) {#
      cat(sprintf("   Warning: No individuals for target sex code %s in training slice.\n", target_sex_code))#
      fitted_models[[disease_group]] <- NULL#
      next#
    }#
    # Find disease indices#
    disease_indices <- unlist(lapply(major_diseases[[disease_group]], function(disease) {#
      which(tolower(disease_names) == tolower(disease))#
    }))#
    if (length(disease_indices) == 0) {#
      fitted_models[[disease_group]] <- NULL#
      next#
    }#
    # Pre-calculate total number of rows needed#
    total_rows <- 0#
    print("Calculating total rows needed...")#
    start_time <- Sys.time()#
    for (i in seq_len(nrow(current_FH_train))) {#
      age_at_enrollment <- current_FH_train$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_train)[3]) next#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_train[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_train)[3])#
      total_rows <- total_rows + (end_time - t_enroll)#
    }#
    print(paste("Total rows needed:", total_rows))#
    print(paste("Time for row calculation:", Sys.time() - start_time))#
    # Pre-allocate data frame#
    print("Pre-allocating data frame...")#
    start_time <- Sys.time()#
    tdc_data <- data.frame(#
      id = integer(total_rows),#
      start = numeric(total_rows),#
      stop = numeric(total_rows),#
      event = logical(total_rows),#
      sex = integer(total_rows)#
    )#
    if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_train))) {#
      tdc_data$fh <- logical(total_rows)#
    }#
    if (!is.null(current_pi_train)) {#
      tdc_data$noulli_risk <- numeric(total_rows)#
    }#
    print(paste("Time for pre-allocation:", Sys.time() - start_time))#
    # Fill the data frame#
    print("Filling data frame...")#
    start_time <- Sys.time()#
    row_idx <- 1#
    for (i in seq_len(nrow(current_FH_train))) {#
      if (i == 1) {#
        print("First person details:")#
        print(paste("Age at enrollment:", current_FH_train$age[i]))#
        print(paste("t_enroll:", as.integer(current_FH_train$age[i] - 29)))#
        if (!is.null(current_pi_train)) {#
          pi_diseases <- current_pi_train[i, disease_indices, as.integer(current_FH_train$age[i] - 29)]#
          print("Pi values for diseases:")#
          print(pi_diseases)#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          print(paste("Yearly risk:", yearly_risk))#
        }#
      }#
      if (i %% 1000 == 0) {#
        print(paste("Processing individual", i, "of", nrow(current_FH_train)))#
        print(paste("Time so far:", Sys.time() - start_time))#
      }#
      age_at_enrollment <- current_FH_train$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_train)[3]) next#
      # Prevalent disease check#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_train[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_train)[3])#
      # Create time intervals for each year#
      for (t in t_enroll:(end_time-1)) {#
        # Check if event occurred in this interval#
        ymat <- current_Y_train[i, disease_indices, t:(t+1), drop = TRUE]#
        event <- if (length(disease_indices) == 1) {#
          any(ymat == 1)#
        } else {#
          any(ymat == 1)#
        }#
        # Fill row#
        tdc_data$id[row_idx] <- i#
        tdc_data$start[row_idx] <- t + 29#
        tdc_data$stop[row_idx] <- t + 30#
        tdc_data$event[row_idx] <- event#
        tdc_data$sex[row_idx] <- current_FH_train$sex[i]#
        if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_train))) {#
          tdc_data$fh[row_idx] <- any(current_FH_train[i, fh_cols])#
        }#
        if (!is.null(current_pi_train)) {#
          pi_diseases <- current_pi_train[i, disease_indices, t]#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          tdc_data$noulli_risk[row_idx] <- yearly_risk#
        }#
        row_idx <- row_idx + 1#
        # Stop if event occurred#
        if (event) {#
          if (i == 1) {#
            print(paste("First person had event at age", t + 30))#
            print(paste("Event occurred in interval", t, "to", t+1))#
          }#
          break#
        }#
      }#
    }#
    print(paste("Total time for filling:", Sys.time() - start_time))#
    # Trim any unused rows#
    print(paste("Final row count:", row_idx-1))#
    print("Trimming unused rows...")#
    start_time <- Sys.time()#
    tdc_data <- tdc_data[1:(row_idx-1), ]#
    print(paste("Time for trimming:", Sys.time() - start_time))#
    print("Data frame complete")#
    print(paste("Number of events:", sum(tdc_data$event)))#
    print(paste("Number of unique individuals:", length(unique(tdc_data$id))))#
    print(paste("Average rows per person:", nrow(tdc_data)/length(unique(tdc_data$id))))#
    print(paste("Number of people with events:", sum(tdc_data$event)))#
    if (nrow(tdc_data) == 0 || sum(tdc_data$event) < 5) {#
      cat(sprintf("   Warning: Too few events (%d) for %s\n", sum(tdc_data$event), disease_group))#
      fitted_models[[disease_group]] <- NULL#
      next#
    }#
    # Fit time-dependent Cox model#
    formula_str <- "Surv(start, stop, event) ~ sex"#
    if ("fh" %in% colnames(tdc_data))#
      formula_str <- "Surv(start, stop, event) ~ sex + fh"#
    if (!is.na(target_sex_code)) {#
      formula_str <- if ("fh" %in% colnames(tdc_data))#
        "Surv(start, stop, event) ~ fh"#
      else#
        "Surv(start, stop, event) ~ 1"#
    }#
    if (!is.null(pi_train) && "noulli_risk" %in% colnames(tdc_data))#
      formula_str <- paste(formula_str, "+ noulli_risk")#
    print(formula_str)#
    fit <- try(coxph(as.formula(formula_str), data = tdc_data, id = id), silent = TRUE)#
    if (inherits(fit, "try-error")) {#
      cat(sprintf("   Error fitting %s: %s\n", disease_group, fit))#
      fitted_models[[disease_group]] <- NULL#
    } else {#
      fitted_models[[disease_group]] <- fit#
      cat(sprintf("   Model fitted for %s using %d time intervals.\n", disease_group, nrow(tdc_data)))#
    }#
  }#
  return(fitted_models)#
}
tdc_models <- fit_time_dependent_cox(#
  Y_train = Y_train,#
  FH_processed = FH_processed,#
  train_indices = 20001:30000,#
  disease_mapping = disease_mapping,#
  major_diseases = major_diseases,#
  disease_names = disease_names,#
  follow_up_duration_years = 10,#
  pi_train = pi_train_full#
)
# Function for time-dependent Cox modeling#
fit_time_dependent_cox <- function(Y_train,#
                                 FH_processed,#
                                 train_indices,#
                                 disease_mapping,#
                                 major_diseases,#
                                 disease_names,#
                                 follow_up_duration_years = 10,#
                                 pi_train = NULL) {#
  fitted_models <- list()#
  FH_train <- FH_processed[train_indices, ]#
  for (disease_group in names(major_diseases)) {#
    fh_cols <- disease_mapping[[disease_group]]#
    if (is.null(fh_cols)) fh_cols <- character(0)#
    if (length(fh_cols) == 0)#
      cat(sprintf(" - %s: No FH columns, fitting Sex only.\n", disease_group))#
    cat(sprintf(" - Fitting time-dependent Cox for %s...\n", disease_group))#
    target_sex_code <- NA#
    if (disease_group == "Breast_Cancer")#
      target_sex_code <- 0#
    if (disease_group == "Prostate_Cancer")#
      target_sex_code <- 1#
    if (!is.na(target_sex_code)) {#
      mask_train <- FH_train$sex == target_sex_code#
    } else {#
      mask_train <- rep(TRUE, nrow(FH_train))#
    }#
    current_FH_train <- FH_train[mask_train, ]#
    current_Y_train <- Y_train[mask_train, , , drop = FALSE]#
    if (!is.null(pi_train)) {#
      current_pi_train <- pi_train[mask_train, , , drop = FALSE]#
    } else {#
      current_pi_train <- NULL#
    }#
    if (nrow(current_FH_train) == 0) {#
      cat(sprintf("   Warning: No individuals for target sex code %s in training slice.\n", target_sex_code))#
      fitted_models[[disease_group]] <- NULL#
      next#
    }#
    # Find disease indices#
    disease_indices <- unlist(lapply(major_diseases[[disease_group]], function(disease) {#
      which(tolower(disease_names) == tolower(disease))#
    }))#
    if (length(disease_indices) == 0) {#
      fitted_models[[disease_group]] <- NULL#
      next#
    }#
    # Pre-calculate total number of rows needed#
    total_rows <- 0#
    print("Calculating total rows needed...")#
    start_time <- Sys.time()#
    for (i in seq_len(nrow(current_FH_train))) {#
      age_at_enrollment <- current_FH_train$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_train)[3]) next#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_train[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_train)[3])#
      total_rows <- total_rows + (end_time - t_enroll)#
    }#
    print(paste("Total rows needed:", total_rows))#
    print(paste("Time for row calculation:", Sys.time() - start_time))#
    # Pre-allocate data frame#
    print("Pre-allocating data frame...")#
    start_time <- Sys.time()#
    tdc_data <- data.frame(#
      id = integer(total_rows),#
      start = numeric(total_rows),#
      stop = numeric(total_rows),#
      event = logical(total_rows),#
      sex = integer(total_rows)#
    )#
    if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_train))) {#
      tdc_data$fh <- logical(total_rows)#
    }#
    if (!is.null(current_pi_train)) {#
      tdc_data$noulli_risk <- numeric(total_rows)#
    }#
    print(paste("Time for pre-allocation:", Sys.time() - start_time))#
    # Fill the data frame#
    print("Filling data frame...")#
    start_time <- Sys.time()#
    row_idx <- 1#
    for (i in seq_len(nrow(current_FH_train))) {#
      if (i == 1) {#
        print("First person details:")#
        print(paste("Age at enrollment:", current_FH_train$age[i]))#
        print(paste("t_enroll:", as.integer(current_FH_train$age[i] - 29)))#
        if (!is.null(current_pi_train)) {#
          pi_diseases <- current_pi_train[i, disease_indices, as.integer(current_FH_train$age[i] - 29)]#
          print("Pi values for diseases:")#
          print(pi_diseases)#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          print(paste("Yearly risk:", yearly_risk))#
        }#
      }#
      if (i %% 1000 == 0) {#
        print(paste("Processing individual", i, "of", nrow(current_FH_train)))#
        print(paste("Time so far:", Sys.time() - start_time))#
      }#
      age_at_enrollment <- current_FH_train$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_train)[3]) next#
      # Prevalent disease check#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_train[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_train)[3])#
      # Create time intervals for each year#
      for (t in t_enroll:(end_time-1)) {#
        # Check if event occurred in this interval#
        ymat <- current_Y_train[i, disease_indices, t:(t+1), drop = TRUE]#
        event <- if (length(disease_indices) == 1) {#
          any(ymat == 1)#
        } else {#
          any(ymat == 1)#
        }#
        # Fill row#
        tdc_data$id[row_idx] <- i#
        tdc_data$start[row_idx] <- t + 29#
        tdc_data$stop[row_idx] <- t + 30#
        tdc_data$event[row_idx] <- event#
        tdc_data$sex[row_idx] <- current_FH_train$sex[i]#
        if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_train))) {#
          tdc_data$fh[row_idx] <- any(current_FH_train[i, fh_cols])#
        }#
        if (!is.null(current_pi_train)) {#
          pi_diseases <- current_pi_train[i, disease_indices, t]#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          tdc_data$noulli_risk[row_idx] <- yearly_risk#
        }#
        row_idx <- row_idx + 1#
        # Stop if event occurred#
        if (event) {#
          if (i <= 5) {  # Show first 5 people who have events#
            print(paste("Person", i, "had event at age", t + 30))#
            print(paste("Event occurred in interval", t, "to", t+1))#
          }#
          break#
        }#
      }#
    }#
    print(paste("Total time for filling:", Sys.time() - start_time))#
    # Trim any unused rows#
    print(paste("Final row count:", row_idx-1))#
    print("Trimming unused rows...")#
    start_time <- Sys.time()#
    tdc_data <- tdc_data[1:(row_idx-1), ]#
    print(paste("Time for trimming:", Sys.time() - start_time))#
    print("Data frame complete")#
    print(paste("Number of events:", sum(tdc_data$event)))#
    print(paste("Number of unique individuals:", length(unique(tdc_data$id))))#
    print(paste("Average rows per person:", nrow(tdc_data)/length(unique(tdc_data$id))))#
    print(paste("Number of people with events:", sum(tdc_data$event)))#
    print(paste("Proportion of people with events:", sum(tdc_data$event)/length(unique(tdc_data$id))))#
    if (nrow(tdc_data) == 0 || sum(tdc_data$event) < 5) {#
      cat(sprintf("   Warning: Too few events (%d) for %s\n", sum(tdc_data$event), disease_group))#
      fitted_models[[disease_group]] <- NULL#
      next#
    }#
    # Fit time-dependent Cox model#
    formula_str <- "Surv(start, stop, event) ~ sex"#
    if ("fh" %in% colnames(tdc_data))#
      formula_str <- "Surv(start, stop, event) ~ sex + fh"#
    if (!is.na(target_sex_code)) {#
      formula_str <- if ("fh" %in% colnames(tdc_data))#
        "Surv(start, stop, event) ~ fh"#
      else#
        "Surv(start, stop, event) ~ 1"#
    }#
    if (!is.null(pi_train) && "noulli_risk" %in% colnames(tdc_data))#
      formula_str <- paste(formula_str, "+ noulli_risk")#
    print(formula_str)#
    fit <- try(coxph(as.formula(formula_str), data = tdc_data, id = id), silent = TRUE)#
    if (inherits(fit, "try-error")) {#
      cat(sprintf("   Error fitting %s: %s\n", disease_group, fit))#
      fitted_models[[disease_group]] <- NULL#
    } else {#
      fitted_models[[disease_group]] <- fit#
      cat(sprintf("   Model fitted for %s using %d time intervals.\n", disease_group, nrow(tdc_data)))#
    }#
  }#
  return(fitted_models)#
}
# Function for time-dependent Cox modeling#
fit_time_dependent_cox <- function(Y_train,#
                                 FH_processed,#
                                 train_indices,#
                                 disease_mapping,#
                                 major_diseases,#
                                 disease_names,#
                                 follow_up_duration_years = 10,#
                                 pi_train = NULL) {#
  fitted_models <- list()#
  FH_train <- FH_processed[train_indices, ]#
  for (disease_group in names(major_diseases)) {#
    fh_cols <- disease_mapping[[disease_group]]#
    if (is.null(fh_cols)) fh_cols <- character(0)#
    if (length(fh_cols) == 0)#
      cat(sprintf(" - %s: No FH columns, fitting Sex only.\n", disease_group))#
    cat(sprintf(" - Fitting time-dependent Cox for %s...\n", disease_group))#
    target_sex_code <- NA#
    if (disease_group == "Breast_Cancer")#
      target_sex_code <- 0#
    if (disease_group == "Prostate_Cancer")#
      target_sex_code <- 1#
    if (!is.na(target_sex_code)) {#
      mask_train <- FH_train$sex == target_sex_code#
    } else {#
      mask_train <- rep(TRUE, nrow(FH_train))#
    }#
    current_FH_train <- FH_train[mask_train, ]#
    current_Y_train <- Y_train[mask_train, , , drop = FALSE]#
    if (!is.null(pi_train)) {#
      current_pi_train <- pi_train[mask_train, , , drop = FALSE]#
    } else {#
      current_pi_train <- NULL#
    }#
    if (nrow(current_FH_train) == 0) {#
      cat(sprintf("   Warning: No individuals for target sex code %s in training slice.\n", target_sex_code))#
      fitted_models[[disease_group]] <- NULL#
      next#
    }#
    # Find disease indices#
    disease_indices <- unlist(lapply(major_diseases[[disease_group]], function(disease) {#
      which(tolower(disease_names) == tolower(disease))#
    }))#
    if (length(disease_indices) == 0) {#
      fitted_models[[disease_group]] <- NULL#
      next#
    }#
    # Pre-calculate total number of rows needed#
    total_rows <- 0#
    print("Calculating total rows needed...")#
    start_time <- Sys.time()#
    for (i in seq_len(nrow(current_FH_train))) {#
      age_at_enrollment <- current_FH_train$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_train)[3]) next#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_train[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_train)[3])#
      total_rows <- total_rows + (end_time - t_enroll)#
    }#
    print(paste("Total rows needed:", total_rows))#
    print(paste("Time for row calculation:", Sys.time() - start_time))#
    # Pre-allocate data frame#
    print("Pre-allocating data frame...")#
    start_time <- Sys.time()#
    tdc_data <- data.frame(#
      id = integer(total_rows),#
      start = numeric(total_rows),#
      stop = numeric(total_rows),#
      event = logical(total_rows),#
      sex = integer(total_rows)#
    )#
    if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_train))) {#
      tdc_data$fh <- logical(total_rows)#
    }#
    if (!is.null(current_pi_train)) {#
      tdc_data$noulli_risk <- numeric(total_rows)#
    }#
    print(paste("Time for pre-allocation:", Sys.time() - start_time))#
    # Fill the data frame#
    print("Filling data frame...")#
    start_time <- Sys.time()#
    row_idx <- 1#
    for (i in seq_len(nrow(current_FH_train))) {#
      if (i == 1) {#
        print("First person details:")#
        print(paste("Age at enrollment:", current_FH_train$age[i]))#
        print(paste("t_enroll:", as.integer(current_FH_train$age[i] - 29)))#
        if (!is.null(current_pi_train)) {#
          pi_diseases <- current_pi_train[i, disease_indices, as.integer(current_FH_train$age[i] - 29)]#
          print("Pi values for diseases:")#
          print(pi_diseases)#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          print(paste("Yearly risk:", yearly_risk))#
        }#
      }#
      if (i %% 1000 == 0) {#
        print(paste("Processing individual", i, "of", nrow(current_FH_train)))#
        print(paste("Time so far:", Sys.time() - start_time))#
      }#
      age_at_enrollment <- current_FH_train$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_train)[3]) next#
      # Prevalent disease check#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_train[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_train)[3])#
      # Create time intervals for each year#
      for (t in t_enroll:(end_time-1)) {#
        # Check if event occurred in this interval#
        ymat <- current_Y_train[i, disease_indices, t:(t+1), drop = TRUE]#
        event <- if (length(disease_indices) == 1) {#
          any(ymat == 1)#
        } else {#
          any(ymat == 1)#
        }#
        # Fill row#
        tdc_data$id[row_idx] <- i#
        tdc_data$start[row_idx] <- t + 29#
        tdc_data$stop[row_idx] <- t + 30#
        tdc_data$event[row_idx] <- event#
        tdc_data$sex[row_idx] <- current_FH_train$sex[i]#
        if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_train))) {#
          tdc_data$fh[row_idx] <- any(current_FH_train[i, fh_cols])#
        }#
        if (!is.null(current_pi_train)) {#
          pi_diseases <- current_pi_train[i, disease_indices, t]#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          tdc_data$noulli_risk[row_idx] <- yearly_risk#
        }#
        row_idx <- row_idx + 1#
        # Stop if event occurred#
        if (event) {#
          if (i <= 5) {  # Show first 5 people who have events#
            print(paste("Person", i, "had event at age", t + 30))#
            print(paste("Event occurred in interval", t, "to", t+1))#
          }#
          break#
        }#
      }#
    }#
    print(paste("Total time for filling:", Sys.time() - start_time))#
    # Trim any unused rows#
    print(paste("Final row count:", row_idx-1))#
    print("Trimming unused rows...")#
    start_time <- Sys.time()#
    tdc_data <- tdc_data[1:(row_idx-1), ]#
    print(paste("Time for trimming:", Sys.time() - start_time))#
    print("Data frame complete")#
    print(paste("Number of events:", sum(tdc_data$event)))#
    print(paste("Number of unique individuals:", length(unique(tdc_data$id))))#
    print(paste("Average rows per person:", nrow(tdc_data)/length(unique(tdc_data$id))))#
    print(paste("Number of people with events:", sum(tdc_data$event)))#
    print(paste("Proportion of people with events:", sum(tdc_data$event)/length(unique(tdc_data$id))))#
    if (nrow(tdc_data) == 0 || sum(tdc_data$event) < 5) {#
      cat(sprintf("   Warning: Too few events (%d) for %s\n", sum(tdc_data$event), disease_group))#
      fitted_models[[disease_group]] <- NULL#
      next#
    }#
    # Fit time-dependent Cox model#
    formula_str <- "Surv(start, stop, event) ~ sex"#
    if ("fh" %in% colnames(tdc_data))#
      formula_str <- "Surv(start, stop, event) ~ sex + fh"#
    if (!is.na(target_sex_code)) {#
      formula_str <- if ("fh" %in% colnames(tdc_data))#
        "Surv(start, stop, event) ~ fh"#
      else#
        "Surv(start, stop, event) ~ 1"#
    }#
    if (!is.null(pi_train) && "noulli_risk" %in% colnames(tdc_data))#
      formula_str <- paste(formula_str, "+ noulli_risk")#
    print(formula_str)#
    fit <- try(coxph(as.formula(formula_str), data = tdc_data, id = id), silent = TRUE)#
    if (inherits(fit, "try-error")) {#
      cat(sprintf("   Error fitting %s: %s\n", disease_group, fit))#
      fitted_models[[disease_group]] <- NULL#
    } else {#
      fitted_models[[disease_group]] <- fit#
      cat(sprintf("   Model fitted for %s using %d time intervals.\n", disease_group, nrow(tdc_data)))#
    }#
  }#
  return(fitted_models)#
}
tdc_models <- fit_time_dependent_cox(#
  Y_train = Y_train,#
  FH_processed = FH_processed,#
  train_indices = 20001:30000,#
  disease_mapping = disease_mapping,#
  major_diseases = major_diseases,#
  disease_names = disease_names,#
  follow_up_duration_years = 10,#
  pi_train = pi_train_full#
)
# Function for time-dependent Cox modeling#
fit_time_dependent_cox <- function(Y_train,#
                                 FH_processed,#
                                 train_indices,#
                                 disease_mapping,#
                                 major_diseases,#
                                 disease_names,#
                                 follow_up_duration_years = 10,#
                                 pi_train = NULL) {#
  fitted_models <- list()#
  FH_train <- FH_processed[train_indices, ]#
  for (disease_group in names(major_diseases)) {#
    fh_cols <- disease_mapping[[disease_group]]#
    if (is.null(fh_cols)) fh_cols <- character(0)#
    if (length(fh_cols) == 0)#
      cat(sprintf(" - %s: No FH columns, fitting Sex only.\n", disease_group))#
    cat(sprintf(" - Fitting time-dependent Cox for %s...\n", disease_group))#
    target_sex_code <- NA#
    if (disease_group == "Breast_Cancer")#
      target_sex_code <- 0#
    if (disease_group == "Prostate_Cancer")#
      target_sex_code <- 1#
    if (!is.na(target_sex_code)) {#
      mask_train <- FH_train$sex == target_sex_code#
    } else {#
      mask_train <- rep(TRUE, nrow(FH_train))#
    }#
    current_FH_train <- FH_train[mask_train, ]#
    current_Y_train <- Y_train[mask_train, , , drop = FALSE]#
    if (!is.null(pi_train)) {#
      current_pi_train <- pi_train[mask_train, , , drop = FALSE]#
    } else {#
      current_pi_train <- NULL#
    }#
    if (nrow(current_FH_train) == 0) {#
      cat(sprintf("   Warning: No individuals for target sex code %s in training slice.\n", target_sex_code))#
      fitted_models[[disease_group]] <- NULL#
      next#
    }#
    # Find disease indices#
    disease_indices <- unlist(lapply(major_diseases[[disease_group]], function(disease) {#
      which(tolower(disease_names) == tolower(disease))#
    }))#
    if (length(disease_indices) == 0) {#
      fitted_models[[disease_group]] <- NULL#
      next#
    }#
    # Pre-calculate total number of rows needed#
    total_rows <- 0#
    print("Calculating total rows needed...")#
    start_time <- Sys.time()#
    for (i in seq_len(nrow(current_FH_train))) {#
      age_at_enrollment <- current_FH_train$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_train)[3]) next#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_train[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_train)[3])#
      # Check for events to determine actual number of rows needed#
      event_found <- FALSE#
      for (t in t_enroll:(end_time-1)) {#
        ymat <- current_Y_train[i, disease_indices, t:(t+1), drop = TRUE]#
        event <- if (length(disease_indices) == 1) {#
          any(ymat == 1)#
        } else {#
          any(ymat == 1)#
        }#
        total_rows <- total_rows + 1#
        if (event) {#
          event_found <- TRUE#
          break#
        }#
      }#
    }#
    print(paste("Total rows needed:", total_rows))#
    print(paste("Time for row calculation:", Sys.time() - start_time))#
    # Pre-allocate data frame#
    print("Pre-allocating data frame...")#
    start_time <- Sys.time()#
    tdc_data <- data.frame(#
      id = integer(total_rows),#
      start = numeric(total_rows),#
      stop = numeric(total_rows),#
      event = logical(total_rows),#
      sex = integer(total_rows)#
    )#
    if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_train))) {#
      tdc_data$fh <- logical(total_rows)#
    }#
    if (!is.null(current_pi_train)) {#
      tdc_data$noulli_risk <- numeric(total_rows)#
    }#
    print(paste("Time for pre-allocation:", Sys.time() - start_time))#
    # Fill the data frame#
    print("Filling data frame...")#
    start_time <- Sys.time()#
    row_idx <- 1#
    for (i in seq_len(nrow(current_FH_train))) {#
      if (i == 1) {#
        print("First person details:")#
        print(paste("Age at enrollment:", current_FH_train$age[i]))#
        print(paste("t_enroll:", as.integer(current_FH_train$age[i] - 29)))#
        if (!is.null(current_pi_train)) {#
          pi_diseases <- current_pi_train[i, disease_indices, as.integer(current_FH_train$age[i] - 29)]#
          print("Pi values for diseases:")#
          print(pi_diseases)#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          print(paste("Yearly risk:", yearly_risk))#
        }#
      }#
      if (i %% 1000 == 0) {#
        print(paste("Processing individual", i, "of", nrow(current_FH_train)))#
        print(paste("Time so far:", Sys.time() - start_time))#
      }#
      age_at_enrollment <- current_FH_train$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_train)[3]) next#
      # Prevalent disease check#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_train[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_train)[3])#
      # Create time intervals for each year#
      for (t in t_enroll:(end_time-1)) {#
        # Check if event occurred in this interval#
        ymat <- current_Y_train[i, disease_indices, t:(t+1), drop = TRUE]#
        event <- if (length(disease_indices) == 1) {#
          any(ymat == 1)#
        } else {#
          any(ymat == 1)#
        }#
        # Debug prints for events#
        if (event) {#
          print(paste("Found event for person", i, "at age", t + 30))#
          print("Event matrix:")#
          print(ymat)#
          print("Disease indices:")#
          print(disease_indices)#
        }#
        # Fill row#
        tdc_data$id[row_idx] <- i#
        tdc_data$start[row_idx] <- t + 29#
        tdc_data$stop[row_idx] <- t + 30#
        tdc_data$event[row_idx] <- event#
        tdc_data$sex[row_idx] <- current_FH_train$sex[i]#
        if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_train))) {#
          tdc_data$fh[row_idx] <- any(current_FH_train[i, fh_cols])#
        }#
        if (!is.null(current_pi_train)) {#
          pi_diseases <- current_pi_train[i, disease_indices, t]#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          tdc_data$noulli_risk[row_idx] <- yearly_risk#
        }#
        row_idx <- row_idx + 1#
        # Stop if event occurred#
        if (event) {#
          print(paste("Stopping after event for person", i))#
          break#
        }#
      }#
    }#
    print(paste("Total time for filling:", Sys.time() - start_time))#
    # Trim any unused rows#
    print(paste("Final row count:", row_idx-1))#
    print("Trimming unused rows...")#
    start_time <- Sys.time()#
    tdc_data <- tdc_data[1:(row_idx-1), ]#
    print(paste("Time for trimming:", Sys.time() - start_time))#
    print("Data frame complete")#
    print(paste("Number of events:", sum(tdc_data$event)))#
    print(paste("Number of unique individuals:", length(unique(tdc_data$id))))#
    print(paste("Average rows per person:", nrow(tdc_data)/length(unique(tdc_data$id))))#
    print(paste("Number of people with events:", sum(tdc_data$event)))#
    print(paste("Proportion of people with events:", sum(tdc_data$event)/length(unique(tdc_data$id))))#
    if (nrow(tdc_data) == 0 || sum(tdc_data$event) < 5) {#
      cat(sprintf("   Warning: Too few events (%d) for %s\n", sum(tdc_data$event), disease_group))#
      fitted_models[[disease_group]] <- NULL#
      next#
    }#
    # Fit time-dependent Cox model#
    formula_str <- "Surv(start, stop, event) ~ sex"#
    if ("fh" %in% colnames(tdc_data))#
      formula_str <- "Surv(start, stop, event) ~ sex + fh"#
    if (!is.na(target_sex_code)) {#
      formula_str <- if ("fh" %in% colnames(tdc_data))#
        "Surv(start, stop, event) ~ fh"#
      else#
        "Surv(start, stop, event) ~ 1"#
    }#
    if (!is.null(pi_train) && "noulli_risk" %in% colnames(tdc_data))#
      formula_str <- paste(formula_str, "+ noulli_risk")#
    print(formula_str)#
    fit <- try(coxph(as.formula(formula_str), data = tdc_data, id = id), silent = TRUE)#
    if (inherits(fit, "try-error")) {#
      cat(sprintf("   Error fitting %s: %s\n", disease_group, fit))#
      fitted_models[[disease_group]] <- NULL#
    } else {#
      fitted_models[[disease_group]] <- fit#
      cat(sprintf("   Model fitted for %s using %d time intervals.\n", disease_group, nrow(tdc_data)))#
    }#
  }#
  return(fitted_models)#
}
tdc_models <- fit_time_dependent_cox(#
  Y_train = Y_train,#
  FH_processed = FH_processed,#
  train_indices = 20001:30000,#
  disease_mapping = disease_mapping,#
  major_diseases = major_diseases,#
  disease_names = disease_names,#
  follow_up_duration_years = 10,#
  pi_train = pi_train_full#
)
#### Testing function#
# Function to evaluate time-dependent Cox models#
test_time_dependent_cox <- function(Y_test,#
                                  FH_processed,#
                                  test_indices,#
                                  disease_mapping,#
                                  major_diseases,#
                                  disease_names,#
                                  follow_up_duration_years = 10,#
                                  fitted_models,#
                                  pi_test = NULL) {#
  auc_results <- list()#
  FH_test <- FH_processed[test_indices, ]#
  for (disease_group in names(major_diseases)) {#
    fh_cols <- disease_mapping[[disease_group]]#
    if (is.null(fh_cols)) fh_cols <- character(0)#
    if (length(fh_cols) == 0)#
      cat(sprintf(" - %s: No FH columns, evaluating Sex only.\n", disease_group))#
    cat(sprintf(" - Evaluating time-dependent Cox for %s...\n", disease_group))#
    target_sex_code <- NA#
    if (disease_group == "Breast_Cancer")#
      target_sex_code <- 0#
    if (disease_group == "Prostate_Cancer")#
      target_sex_code <- 1#
    if (!is.na(target_sex_code)) {#
      mask_test <- FH_test$sex == target_sex_code#
    } else {#
      mask_test <- rep(TRUE, nrow(FH_test))#
    }#
    current_FH_test <- FH_test[mask_test, ]#
    current_Y_test <- Y_test[mask_test, , , drop = FALSE]#
    if (!is.null(pi_test)) {#
      current_pi_test <- pi_test[mask_test, , , drop = FALSE]#
    } else {#
      current_pi_test <- NULL#
    }#
    if (nrow(current_FH_test) == 0) {#
      cat(sprintf("   Warning: No individuals for target sex code %s in testing slice.\n", target_sex_code))#
      next#
    }#
    disease_indices <- unlist(lapply(major_diseases[[disease_group]], function(disease) {#
      which(tolower(disease_names) == tolower(disease))#
    }))#
    if (length(disease_indices) == 0) next#
    # Create time-dependent data structure for testing#
    print("Calculating total rows needed...")#
    start_time <- Sys.time()#
    total_rows <- 0#
    for (i in seq_len(nrow(current_FH_test))) {#
      age_at_enrollment <- current_FH_test$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_test)[3]) next#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_test[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_test)[3])#
      # Check for events to determine actual number of rows needed#
      for (t in t_enroll:(end_time-1)) {#
        ymat <- current_Y_test[i, disease_indices, t:(t+1), drop = TRUE]#
        event <- if (length(disease_indices) == 1) {#
          any(ymat == 1)#
        } else {#
          any(ymat == 1)#
        }#
        total_rows <- total_rows + 1#
        if (event) break#
      }#
    }#
    print(paste("Total rows needed:", total_rows))#
    print(paste("Time for row calculation:", Sys.time() - start_time))#
    # Pre-allocate data frame#
    print("Pre-allocating data frame...")#
    start_time <- Sys.time()#
    tdc_data <- data.frame(#
      id = integer(total_rows),#
      start = numeric(total_rows),#
      stop = numeric(total_rows),#
      event = logical(total_rows),#
      sex = integer(total_rows)#
    )#
    if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_test))) {#
      tdc_data$fh <- logical(total_rows)#
    }#
    if (!is.null(current_pi_test)) {#
      tdc_data$noulli_risk <- numeric(total_rows)#
    }#
    print(paste("Time for pre-allocation:", Sys.time() - start_time))#
    # Fill the data frame#
    print("Filling data frame...")#
    start_time <- Sys.time()#
    row_idx <- 1#
    for (i in seq_len(nrow(current_FH_test))) {#
      if (i %% 1000 == 0) {#
        print(paste("Processing individual", i, "of", nrow(current_FH_test)))#
        print(paste("Time so far:", Sys.time() - start_time))#
      }#
      age_at_enrollment <- current_FH_test$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_test)[3]) next#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_test[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_test)[3])#
      for (t in t_enroll:(end_time-1)) {#
        ymat <- current_Y_test[i, disease_indices, t:(t+1), drop = TRUE]#
        event <- if (length(disease_indices) == 1) {#
          any(ymat == 1)#
        } else {#
          any(ymat == 1)#
        }#
        # Debug prints for events#
        if (event) {#
          print(paste("Found event for person", i, "at age", t + 30))#
          print("Event matrix:")#
          print(ymat)#
          print("Disease indices:")#
          print(disease_indices)#
        }#
        tdc_data$id[row_idx] <- i#
        tdc_data$start[row_idx] <- t + 29#
        tdc_data$stop[row_idx] <- t + 30#
        tdc_data$event[row_idx] <- event#
        tdc_data$sex[row_idx] <- current_FH_test$sex[i]#
        if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_test))) {#
          tdc_data$fh[row_idx] <- any(current_FH_test[i, fh_cols])#
        }#
        if (!is.null(current_pi_test)) {#
          pi_diseases <- current_pi_test[i, disease_indices, t]#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          tdc_data$noulli_risk[row_idx] <- yearly_risk#
        }#
        row_idx <- row_idx + 1#
        if (event) {#
          print(paste("Stopping after event for person", i))#
          break#
        }#
      }#
    }#
    print(paste("Total time for filling:", Sys.time() - start_time))#
    print(paste("Final row count:", row_idx-1))#
    print("Trimming unused rows...")#
    start_time <- Sys.time()#
    tdc_data <- tdc_data[1:(row_idx-1), ]#
    print(paste("Time for trimming:", Sys.time() - start_time))#
    print("Data frame complete")#
    print(paste("Number of events:", sum(tdc_data$event)))#
    print(paste("Number of unique individuals:", length(unique(tdc_data$id))))#
    print(paste("Average rows per person:", nrow(tdc_data)/length(unique(tdc_data$id))))#
    print(paste("Number of people with events:", sum(tdc_data$event)))#
    print(paste("Proportion of people with events:", sum(tdc_data$event)/length(unique(tdc_data$id))))#
    fit <- fitted_models[[disease_group]]#
    if (is.null(fit) || nrow(tdc_data) == 0) next#
    # Predict risk scores#
    risk_scores <- predict(fit, newdata = tdc_data, type = "risk")#
    # Calculate time-dependent AUC#
    # For simplicity, we'll use the average risk score per person#
    person_risks <- aggregate(risk_scores, by = list(id = tdc_data$id), FUN = mean)#
    person_events <- aggregate(tdc_data$event, by = list(id = tdc_data$id), FUN = max)#
    roc_obj <- roc(person_events$x, person_risks$x)#
    auc_val <- auc(roc_obj)#
    print(sprintf("Time-dependent AUC for %s: %.3f", disease_group, auc_val))#
    auc_results[[disease_group]] <- auc_val#
  }#
  return(auc_results)#
}
tdc_auc_results <- test_time_dependent_cox(#
  Y_test = Y_test,#
  FH_processed = FH_processed,#
  test_indices = 0:10000,#
  disease_mapping = disease_mapping,#
  major_diseases = major_diseases,#
  disease_names = disease_names,#
  follow_up_duration_years = 10,#
  fitted_models = tdc_models,#
  pi_test = pi_test_full#
)
tdc_auc_df <- data.frame(#
  disease_group = names(tdc_auc_results),#
  auc = unlist(tdc_auc_results)#
)
tdc_auc_df
model_comp=read.csv("~/Library/CloudStorage/Dropbox/model_comparison_everything.csv")
merge(model_comp,tdc_auc_df,by.x="Disease",by.y="disease_group")
m=merge(model_comp,tdc_auc_df,by.x="Disease",by.y="disease_group")
disease_group="ASCVD"
age_at_enrollment <- current_FH_train$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_train)[3]) next#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_train[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_train)[3])
total_rows <- 0#
    print("Calculating total rows needed...")#
    start_time <- Sys.time()#
    for (i in seq_len(nrow(current_FH_train))) {#
      age_at_enrollment <- current_FH_train$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_train)[3]) next#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_train[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_train)[3])#
      # Check for events to determine actual number of rows needed#
      event_found <- FALSE#
      for (t in t_enroll:(end_time-1)) {#
        ymat <- current_Y_train[i, disease_indices, t:(t+1), drop = TRUE]#
        event <- if (length(disease_indices) == 1) {#
          any(ymat == 1)#
        } else {#
          any(ymat == 1)#
        }#
        total_rows <- total_rows + 1#
        if (event) {#
          event_found <- TRUE#
          break#
        }#
      }#
    }#
    print(paste("Total rows needed:", total_rows))#
    print(paste("Time for row calculation:", Sys.time() - start_time))#
    # Pre-allocate data frame#
    print("Pre-allocating data frame...")#
    start_time <- Sys.time()#
    tdc_data <- data.frame(#
      id = integer(total_rows),#
      start = numeric(total_rows),#
      stop = numeric(total_rows),#
      event = logical(total_rows),#
      sex = integer(total_rows)#
    )#
    if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_train))) {#
      tdc_data$fh <- logical(total_rows)#
    }#
    if (!is.null(current_pi_train)) {#
      tdc_data$noulli_risk <- numeric(total_rows)#
    }#
    print(paste("Time for pre-allocation:", Sys.time() - start_time))#
    # Fill the data frame#
    print("Filling data frame...")#
    start_time <- Sys.time()#
    row_idx <- 1#
    for (i in seq_len(nrow(current_FH_train))) {#
      if (i == 1) {#
        print("First person details:")#
        print(paste("Age at enrollment:", current_FH_train$age[i]))#
        print(paste("t_enroll:", as.integer(current_FH_train$age[i] - 29)))#
        if (!is.null(current_pi_train)) {#
          pi_diseases <- current_pi_train[i, disease_indices, as.integer(current_FH_train$age[i] - 29)]#
          print("Pi values for diseases:")#
          print(pi_diseases)#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          print(paste("Yearly risk:", yearly_risk))#
        }#
      }#
      if (i %% 1000 == 0) {#
        print(paste("Processing individual", i, "of", nrow(current_FH_train)))#
        print(paste("Time so far:", Sys.time() - start_time))#
      }#
      age_at_enrollment <- current_FH_train$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_train)[3]) next#
      # Prevalent disease check#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_train[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_train)[3])#
      # Create time intervals for each year#
      for (t in t_enroll:(end_time-1)) {#
        # Check if event occurred in this interval#
        ymat <- current_Y_train[i, disease_indices, t:(t+1), drop = TRUE]#
        event <- if (length(disease_indices) == 1) {#
          any(ymat == 1)#
        } else {#
          any(ymat == 1)#
        }#
        # Debug prints for events#
        if (event) {#
          print(paste("Found event for person", i, "at age", t + 30))#
          print("Event matrix:")#
          print(ymat)#
          print("Disease indices:")#
          print(disease_indices)#
        }#
        # Fill row#
        tdc_data$id[row_idx] <- i#
        tdc_data$start[row_idx] <- t + 29#
        tdc_data$stop[row_idx] <- t + 30#
        tdc_data$event[row_idx] <- event#
        tdc_data$sex[row_idx] <- current_FH_train$sex[i]#
        if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_train))) {#
          tdc_data$fh[row_idx] <- any(current_FH_train[i, fh_cols])#
        }#
        if (!is.null(current_pi_train)) {#
          pi_diseases <- current_pi_train[i, disease_indices, t]#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          tdc_data$noulli_risk[row_idx] <- yearly_risk#
        }#
        row_idx <- row_idx + 1#
        # Stop if event occurred#
        if (event) {#
          print(paste("Stopping after event for person", i))#
          break#
        }#
      }#
    }#
    print(paste("Total time for filling:", Sys.time() - start_time))
ls()
head(tdc_data)
total_rows
dim(tdc_data)
tdc_data[tdc_data$id%in%1,]
dim(tdc_data[tdc_data$id%in%1,])
dim(tdc_data[tdc_data$id%in%38,])
FH_train[38,]
FH_train[38,disease_indices,6]
FH_train[38,disease_indices,6]
disease_indices
FH_train[38,disease_indices,]
Y_train[38,disease_indices,6]
Y_train[38,disease_indices,]
sum(Y_train[38,disease_indices,])
head(tdc_data[tdc_data$id%in%38,(FH_train[38,'age']-29)+7])
head(Y_train[38,(FH_train[38,'age']-29)+7])
head(Y_train[38,as.numeric(FH_train[38,'age'])-29)+7])
head(Y_train[38,as.numeric(FH_train[38,'age'])-29),7])
head(Y_train[38,as.numeric(FH_train[38,'age'])-29,7])
head(Y_train[38,as.numeric(FH_train[38,'age'])-29,0:7])
head(Y_train[38,disease_indices,0:as.numeric(FH_train[38,'age'])-29+7])
head(Y_train[38,disease_indices,0:(as.numeric(FH_train[38,'age'])-29+7)])
i=38
if (i == 1) {#
        print("First person details:")#
        print(paste("Age at enrollment:", current_FH_train$age[i]))#
        print(paste("t_enroll:", as.integer(current_FH_train$age[i] - 29)))#
        if (!is.null(current_pi_train)) {#
          pi_diseases <- current_pi_train[i, disease_indices, as.integer(current_FH_train$age[i] - 29)]#
          print("Pi values for diseases:")#
          print(pi_diseases)#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          print(paste("Yearly risk:", yearly_risk))#
        }#
      }#
      if (i %% 1000 == 0) {#
        print(paste("Processing individual", i, "of", nrow(current_FH_train)))#
        print(paste("Time so far:", Sys.time() - start_time))#
      }#
      age_at_enrollment <- current_FH_train$age[i]#
      t_enroll <- as.integer(age_at_enrollment - 29)#
      if (t_enroll < 0 || t_enroll >= dim(current_Y_train)[3]) next#
      # Prevalent disease check#
      if (length(disease_indices) == 1 && t_enroll > 0) {#
        if (any(current_Y_train[i, disease_indices, 1:(t_enroll-1)] == 1)) next#
      }#
      end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_train)[3])#
      # Create time intervals for each year#
      for (t in t_enroll:(end_time-1)) {#
        # Check if event occurred in this interval#
        ymat <- current_Y_train[i, disease_indices, t:(t+1), drop = TRUE]#
        event <- if (length(disease_indices) == 1) {#
          any(ymat == 1)#
        } else {#
          any(ymat == 1)#
        }#
        # Debug prints for events#
        if (event) {#
          print(paste("Found event for person", i, "at age", t + 30))#
          print("Event matrix:")#
          print(ymat)#
          print("Disease indices:")#
          print(disease_indices)#
        }#
        # Fill row#
        tdc_data$id[row_idx] <- i#
        tdc_data$start[row_idx] <- t + 29#
        tdc_data$stop[row_idx] <- t + 30#
        tdc_data$event[row_idx] <- event#
        tdc_data$sex[row_idx] <- current_FH_train$sex[i]#
        if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_train))) {#
          tdc_data$fh[row_idx] <- any(current_FH_train[i, fh_cols])#
        }#
        if (!is.null(current_pi_train)) {#
          pi_diseases <- current_pi_train[i, disease_indices, t]#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          tdc_data$noulli_risk[row_idx] <- yearly_risk#
        }#
        row_idx <- row_idx + 1#
        # Stop if event occurred#
        if (event) {#
          print(paste("Stopping after event for person", i))#
          break#
        }
}
ymat
t_enroll
end_time <- min(t_enroll + follow_up_duration_years, dim(current_Y_train)[3])
end_time
for (t in t_enroll:(end_time-1)) {#
        # Check if event occurred in this interval#
        ymat <- current_Y_train[i, disease_indices, t:(t+1), drop = TRUE]#
        event <- if (length(disease_indices) == 1) {#
          any(ymat == 1)#
        } else {#
          any(ymat == 1)#
        }#
        # Debug prints for events#
        if (event) {#
          print(paste("Found event for person", i, "at age", t + 30))#
          print("Event matrix:")#
          print(ymat)#
          print("Disease indices:")#
          print(disease_indices)#
        }
}
for (t in t_enroll:(end_time-1)) {#
        # Check if event occurred in this interval#
        ymat <- current_Y_train[i, disease_indices, t:(t+1), drop = TRUE]#
        event <- if (length(disease_indices) == 1) {#
          any(ymat == 1)#
        } else {#
          any(ymat == 1)#
        }#
        # Debug prints for events#
        if (event) {#
          print(paste("Found event for person", i, "at age", t + 30))#
          print("Event matrix:")#
          print(ymat)#
          print("Disease indices:")#
          print(disease_indices)#
        }#
        # Fill row#
        tdc_data$id[row_idx] <- i#
        tdc_data$start[row_idx] <- t + 29#
        tdc_data$stop[row_idx] <- t + 30#
        tdc_data$event[row_idx] <- event#
        tdc_data$sex[row_idx] <- current_FH_train$sex[i]#
        if (length(fh_cols) > 0 && all(fh_cols %in% colnames(current_FH_train))) {#
          tdc_data$fh[row_idx] <- any(current_FH_train[i, fh_cols])#
        }#
        if (!is.null(current_pi_train)) {#
          pi_diseases <- current_pi_train[i, disease_indices, t]#
          yearly_risk <- 1 - prod(1 - pi_diseases)#
          tdc_data$noulli_risk[row_idx] <- yearly_risk#
        }#
        row_idx <- row_idx + 1#
        # Stop if event occurred#
        if (event) {#
          print(paste("Stopping after event for person", i))#
          break#
        }#
      }
tdc_data[tdc_data$id%in%38,]
56-29
current_Y_train[38,disease_indices,0:27]
n
m
cbind(m$aladynoulli_auc_dynamic,m$auc)
cbind(m$Disease,m$aladynoulli_auc_dynamic,m$auc)
m
names(m)
names(m)[9]="td_cox"
write.csv(m,"all_model_comp_withtdcox.csv")
require("ggplot2")#
require("dplyr")#
require("tidyr")#
require("stringr")#
require("forcats")#
# Load required libraries#
library(ggplot2)#
library(dplyr)#
library(tidyr)#
library(stringr)#
library(forcats)#
#
# Function to parse the data#
parse_model_data <- function(data_path) {#
  # Read the data#
  df <- read.csv(data_path)#
  # Extract confidence intervals from the formatted strings#
  extract_ci <- function(ci_str) {#
    # Matches format like "0.765 (0.748-0.782)"#
    pattern <- "(\\d+\\.\\d+)\\s*\\((\\d+\\.\\d+)-(\\d+\\.\\d+)\\)"#
    matches <- regexec(pattern, ci_str)#
    result <- regmatches(ci_str, matches)#
    if(length(result) > 0 && length(result[[1]]) >= 4) {#
      return(c(as.numeric(result[[1]][2]), #
               as.numeric(result[[1]][3]),#
               as.numeric(result[[1]][4])))#
    } else {#
      return(c(NA, NA, NA))#
    }#
  }#
  # Create a clean data frame#
  model_data <- data.frame(#
    Disease = df$Disease,#
    Events = df$Events,#
    Rate = df$Rate,#
    stringsAsFactors = FALSE#
  )#
  # Extract values for Aladynoulli Dynamic#
  dynamic_ci <- lapply(df$aladynoulli_auc_dynamic, extract_ci)#
  model_data$dynamic_auc <- sapply(dynamic_ci, function(x) x[1])#
  model_data$dynamic_lower <- sapply(dynamic_ci, function(x) x[2])#
  model_data$dynamic_upper <- sapply(dynamic_ci, function(x) x[3])#
  # Extract values for Aladynoulli Static#
  static_ci <- lapply(df$aladynoulli_auc_static, extract_ci)#
  model_data$static_auc <- sapply(static_ci, function(x) x[1])#
  model_data$static_lower <- sapply(static_ci, function(x) x[2])#
  model_data$static_upper <- sapply(static_ci, function(x) x[3])#
  # Add Cox values#
  model_data$cox_without_noulli <- df$cox_auc_without_noulli#
  model_data$cox_with_noulli <- df$cox_auc_with_noulli#
  # Calculate CI for Cox values (using the formula SE = sqrt((AUC * (1-AUC)) / (n * prevalence)))#
  calc_cox_ci <- function(auc, events, total = 400000) {#
    # Parse rate from string like "4.8%"#
    prevalence <- events / total#
    # Ensure minimum prevalence for calculation#
    prevalence <- max(0.01, prevalence)#
    # Standard error#
    se <- sqrt((auc * (1 - auc)) / (total * prevalence))#
    # 95% CI#
    lower <- max(0, auc - 1.96 * se)#
    upper <- min(1, auc + 1.96 * se)#
    return(c(lower, upper))#
  }#
  # Add CI for Cox without Noulli#
  cox_without_ci <- mapply(calc_cox_ci, #
                           model_data$cox_without_noulli, #
                           model_data$Events, #
                           SIMPLIFY = FALSE)#
  model_data$cox_without_lower <- sapply(cox_without_ci, function(x) x[1])#
  model_data$cox_without_upper <- sapply(cox_without_ci, function(x) x[2])#
  # Add CI for Cox with Noulli#
  cox_with_ci <- mapply(calc_cox_ci, #
                        model_data$cox_with_noulli, #
                        model_data$Events, #
                        SIMPLIFY = FALSE)#
  model_data$cox_with_lower <- sapply(cox_with_ci, function(x) x[1])#
  model_data$cox_with_upper <- sapply(cox_with_ci, function(x) x[2])#
  return(model_data)#
}#
#
# Reshape data for plotting#
prepare_forest_plot_data <- function(model_data) {#
  # Transform to long format#
  long_data <- model_data %>%#
    pivot_longer(#
      cols = c("dynamic_auc", "static_auc", "cox_without_noulli", "cox_with_noulli"),#
      names_to = "model",#
      values_to = "auc"#
    ) %>%#
    mutate(#
      lower = case_when(#
        model == "dynamic_auc" ~ dynamic_lower,#
        model == "static_auc" ~ static_lower,#
        model == "cox_without_noulli" ~ cox_without_lower,#
        model == "cox_with_noulli" ~ cox_with_lower#
      ),#
      upper = case_when(#
        model == "dynamic_auc" ~ dynamic_upper,#
        model == "static_auc" ~ static_upper,#
        model == "cox_without_noulli" ~ cox_without_upper,#
        model == "cox_with_noulli" ~ cox_with_upper#
      ),#
      model = case_when(#
        model == "dynamic_auc" ~ "Aladynoulli Dynamic",#
        model == "static_auc" ~ "Aladynoulli Static",#
        model == "cox_without_noulli" ~ "Cox without Noulli",#
        model == "cox_with_noulli" ~ "Cox with Noulli"#
      )#
    ) %>%#
    select(Disease, Events, Rate, model, auc, lower, upper)#
  # Make Disease a factor ordered by dynamic AUC#
  disease_order <- model_data %>%#
    arrange(desc(dynamic_auc)) %>%#
    pull(Disease)#
  long_data$Disease <- factor(long_data$Disease, levels = disease_order)#
  return(long_data)#
}#
#
# Create the forest plot#
create_forest_plot <- function(plot_data) {#
  # Define colors for models#
  model_colors <- c(#
    "Aladynoulli Dynamic" = "#4285F4",  # Blue#
    "Aladynoulli Static" = "#34A853",   # Green#
    "Cox without Noulli" = "#FBBC05",   # Yellow/Orange#
    "Cox with Noulli" = "#EA4335"       # Red#
  )#
  # Shape the disease names to be more readable#
  plot_data <- plot_data %>%#
    mutate(Disease = str_replace_all(Disease, "_", " "))#
  # Create the plot#
  p <- ggplot(plot_data, aes(x = auc, y = Disease, color = model)) +#
    geom_vline(xintercept = 0.5, linetype = "dashed", color = "gray70") +#
    geom_point(aes(shape = model), size = 2.5, position = position_dodge(width = 0.5)) +#
    geom_errorbarh(aes(xmin = lower, xmax = upper), height = 0.2, position = position_dodge(width = 0.5)) +#
    scale_color_manual(values = model_colors) +#
    scale_x_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Comparing performance of four prediction models across 28 diseases",#
      x = "AUC (95% CI)",#
      y = NULL,#
      color = "Model",#
      shape = "Model"#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      panel.grid.major.y = element_line(color = "gray90"),#
      panel.grid.minor.y = element_blank(),#
      axis.text.y = element_text(size = 10),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}#
#
# Main function to run the analysis#
create_multidisease_comparison <- function(data_path) {#
  # Parse the data#
  model_data <- parse_model_data(data_path)#
  # Prepare data for plotting#
  plot_data <- prepare_forest_plot_data(model_data)#
  # Create forest plot#
  forest_plot <- create_forest_plot(plot_data)#
  # Save the plot#
  ggsave("multidisease_forest_plot.png", forest_plot, width = 12, height = 14, dpi = 300)#
  # Print summary statistics#
  model_summary <- plot_data %>%#
    group_by(model) %>%#
    summarize(#
      mean_auc = mean(auc, na.rm = TRUE),#
      median_auc = median(auc, na.rm = TRUE),#
      min_auc = min(auc, na.rm = TRUE),#
      max_auc = max(auc, na.rm = TRUE)#
    )#
  print(model_summary)#
  return(forest_plot)#
}#
#
# Example usage:#
# forest_plot <- create_multidisease_comparison("model_comparison_everything.csv")#
# print(forest_plot)#
#
# Alternative approach with facet_wrap for separate panels by disease#
create_faceted_forest_plot <- function(plot_data) {#
  # Limit to top 16 diseases by dynamic AUC#
  top_diseases <- plot_data %>%#
    filter(model == "Aladynoulli Static") %>%#
    arrange(desc(Events)) %>%#
    head(16) %>%#
    pull(Disease)#
  plot_data_subset <- plot_data %>%#
    filter(Disease %in% top_diseases)#
#
  plot_data_subset$Disease=factor(plot_data_subset$Disease,levels = top_diseases)#
  plot_data_subset=plot_data%>%#
    filter(Disease %in% c("ASCVD","Diabetes","All_Cancers","COPD","Atrial_Fib","Pneumonia","Secondary_Cancer","Osteoporosis",#
    "Breast Cancer","CKD","Heart_Failure","Rheumatoid_Arthritis","Stroke"))#
  plot_data_subset=plot_data%>%#
    filter(Disease %in% c("ASCVD","Diabetes","All_Cancers","COPD","Atrial_Fib","Pneumonia","Secondary_Cancer","Osteoporosis",#
                          "Breast Cancer","CKD","Heart_Failure","Rheumatoid_Arthritis","Stroke"))#
  # Define colors for models#
  model_colors <- c(#
    "Aladynoulli Dynamic" = "#4285F4",  # Blue#
    "Aladynoulli Static" = "#34A853",   # Green#
    "Cox without Noulli" = "#FBBC05",   # Yellow/Orange#
    "Cox with Noulli" = "#EA4335"       # Red#
  )#
  # Create the faceted plot#
  p <- ggplot(plot_data_subset, aes(x = model, y = auc, color = model)) +#
    geom_point(size = 5) +#
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +#
    facet_wrap(~ Disease, scales = "free_y", ncol = 4) +#
    geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +#
    scale_color_manual(values = model_colors) +#
    scale_y_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Performance across top 16 diseases",#
      y = "AUC (95% CI)",#
      x = NULL#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),#
      strip.text = element_text(face = "bold"),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}
model_data <- parse_model_data("all_model_comp_withtdcox.csv")#
plot_data <- prepare_forest_plot_data(model_data)
faceted_plot <- create_faceted_forest_plot(plot_data)
faceted_plot
plot_data
print(plot_data,n=120)
model_data
model_data <- parse_model_data("all_model_comp_withtdcox.csv")#
plot_data <- prepare_forest_plot_data(model_data)
model_data
Function to parse the data#
parse_model_data <- function(data_path) {#
  # Read the data#
  df <- read.csv(data_path)#
  # Extract confidence intervals from the formatted strings#
  extract_ci <- function(ci_str) {#
    # Matches format like "0.765 (0.748-0.782)"#
    pattern <- "(\\d+\\.\\d+)\\s*\\((\\d+\\.\\d+)-(\\d+\\.\\d+)\\)"#
    matches <- regexec(pattern, ci_str)#
    result <- regmatches(ci_str, matches)#
    if(length(result) > 0 && length(result[[1]]) >= 4) {#
      return(c(as.numeric(result[[1]][2]), #
               as.numeric(result[[1]][3]),#
               as.numeric(result[[1]][4])))#
    } else {#
      return(c(NA, NA, NA))#
    }#
  }#
  # Create a clean data frame#
  model_data <- data.frame(#
    Disease = df$Disease,#
    Events = df$Events,#
    Rate = df$Rate,#
    stringsAsFactors = FALSE#
  )#
  # Extract values for Aladynoulli Dynamic#
  dynamic_ci <- lapply(df$aladynoulli_auc_dynamic, extract_ci)#
  model_data$dynamic_auc <- sapply(dynamic_ci, function(x) x[1])#
  model_data$dynamic_lower <- sapply(dynamic_ci, function(x) x[2])#
  model_data$dynamic_upper <- sapply(dynamic_ci, function(x) x[3])#
  # Extract values for Aladynoulli Static#
  static_ci <- lapply(df$aladynoulli_auc_static, extract_ci)#
  model_data$static_auc <- sapply(static_ci, function(x) x[1])#
  model_data$static_lower <- sapply(static_ci, function(x) x[2])#
  model_data$static_upper <- sapply(static_ci, function(x) x[3])#
  # Add Cox values#
  model_data$cox_without_noulli <- df$cox_auc_without_noulli#
  model_data$cox_with_noulli <- df$cox_auc_with_noulli#
#
  # Add TD Cox AUC (as numeric)#
  model_data$td_cox_auc <- as.numeric(df$auc)#
  # Calculate CI for Cox values (using the formula SE = sqrt((AUC * (1-AUC)) / (n * prevalence)))#
  calc_cox_ci <- function(auc, events, total = 400000) {#
    prevalence <- events / total#
    prevalence <- max(0.01, prevalence)#
    se <- sqrt((auc * (1 - auc)) / (total * prevalence))#
    lower <- max(0, auc - 1.96 * se)#
    upper <- min(1, auc + 1.96 * se)#
    return(c(lower, upper))#
  }#
  # Add CI for Cox without Noulli#
  cox_without_ci <- mapply(calc_cox_ci, #
                           model_data$cox_without_noulli, #
                           model_data$Events, #
                           SIMPLIFY = FALSE)#
  model_data$cox_without_lower <- sapply(cox_without_ci, function(x) x[1])#
  model_data$cox_without_upper <- sapply(cox_without_ci, function(x) x[2])#
  # Add CI for Cox with Noulli#
  cox_with_ci <- mapply(calc_cox_ci, #
                        model_data$cox_with_noulli, #
                        model_data$Events, #
                        SIMPLIFY = FALSE)#
  model_data$cox_with_lower <- sapply(cox_with_ci, function(x) x[1])#
  model_data$cox_with_upper <- sapply(cox_with_ci, function(x) x[2])#
#
  # Add CI for TD Cox#
  td_cox_ci <- mapply(calc_cox_ci, #
                      model_data$td_cox_auc, #
                      model_data$Events, #
                      SIMPLIFY = FALSE)#
  model_data$td_cox_lower <- sapply(td_cox_ci, function(x) x[1])#
  model_data$td_cox_upper <- sapply(td_cox_ci, function(x) x[2])#
  return(model_data)#
}
model_data <- parse_model_data("all_model_comp_withtdcox.csv")#
plot_data <- prepare_forest_plot_data(model_data)
head  df <- read.csv(data_path)
model_data <- parse_model_data("all_model_comp_withtdcox.csv")#
plot_data <- prepare_forest_plot_data(model_data)
df=read.csv(all_model_comp_withtdcox.csv)
df=read.csv("all_model_comp_withtdcox.csv")
df
df=read.csv("all_model_comp_withtdcox.csv")
parse_model_data <- function(data_path) {#
  # Read the data#
  df <- read.csv(data_path)#
  # Extract confidence intervals from the formatted strings#
  extract_ci <- function(ci_str) {#
    # Matches format like "0.765 (0.748-0.782)"#
    pattern <- "(\\d+\\.\\d+)\\s*\\((\\d+\\.\\d+)-(\\d+\\.\\d+)\\)"#
    matches <- regexec(pattern, ci_str)#
    result <- regmatches(ci_str, matches)#
    if(length(result) > 0 && length(result[[1]]) >= 4) {#
      return(c(as.numeric(result[[1]][2]), #
               as.numeric(result[[1]][3]),#
               as.numeric(result[[1]][4])))#
    } else {#
      return(c(NA, NA, NA))#
    }#
  }#
  # Create a clean data frame#
  model_data <- data.frame(#
    Disease = df$Disease,#
    Events = df$Events,#
    Rate = df$Rate,#
    stringsAsFactors = FALSE#
  )#
  # Extract values for Aladynoulli Dynamic#
  dynamic_ci <- lapply(df$aladynoulli_auc_dynamic, extract_ci)#
  model_data$dynamic_auc <- sapply(dynamic_ci, function(x) x[1])#
  model_data$dynamic_lower <- sapply(dynamic_ci, function(x) x[2])#
  model_data$dynamic_upper <- sapply(dynamic_ci, function(x) x[3])#
  # Extract values for Aladynoulli Static#
  static_ci <- lapply(df$aladynoulli_auc_static, extract_ci)#
  model_data$static_auc <- sapply(static_ci, function(x) x[1])#
  model_data$static_lower <- sapply(static_ci, function(x) x[2])#
  model_data$static_upper <- sapply(static_ci, function(x) x[3])#
  # Add Cox values#
  model_data$cox_without_noulli <- df$cox_auc_without_noulli#
  model_data$cox_with_noulli <- df$cox_auc_with_noulli#
#
  # Add TD Cox AUC (as numeric)#
  model_data$td_cox_auc <- as.numeric(df$td_cox)#
  # Calculate CI for Cox values (using the formula SE = sqrt((AUC * (1-AUC)) / (n * prevalence)))#
  calc_cox_ci <- function(auc, events, total = 400000) {#
    prevalence <- events / total#
    prevalence <- max(0.01, prevalence)#
    se <- sqrt((auc * (1 - auc)) / (total * prevalence))#
    lower <- max(0, auc - 1.96 * se)#
    upper <- min(1, auc + 1.96 * se)#
    return(c(lower, upper))#
  }#
  # Add CI for Cox without Noulli#
  cox_without_ci <- mapply(calc_cox_ci, #
                           model_data$cox_without_noulli, #
                           model_data$Events, #
                           SIMPLIFY = FALSE)#
  model_data$cox_without_lower <- sapply(cox_without_ci, function(x) x[1])#
  model_data$cox_without_upper <- sapply(cox_without_ci, function(x) x[2])#
  # Add CI for Cox with Noulli#
  cox_with_ci <- mapply(calc_cox_ci, #
                        model_data$cox_with_noulli, #
                        model_data$Events, #
                        SIMPLIFY = FALSE)#
  model_data$cox_with_lower <- sapply(cox_with_ci, function(x) x[1])#
  model_data$cox_with_upper <- sapply(cox_with_ci, function(x) x[2])#
#
  # Add CI for TD Cox#
  td_cox_ci <- mapply(calc_cox_ci, #
                      model_data$td_cox_auc, #
                      model_data$Events, #
                      SIMPLIFY = FALSE)#
  model_data$td_cox_lower <- sapply(td_cox_ci, function(x) x[1])#
  model_data$td_cox_upper <- sapply(td_cox_ci, function(x) x[2])#
  return(model_data)#
}
model_data <- parse_model_data("all_model_comp_withtdcox.csv")#
plot_data <- prepare_forest_plot_data(model_data)
model_data
plot_data
model_data <- parse_model_data("all_model_comp_withtdcox.csv")#
plot_data <- prepare_forest_plot_data(model_data)
# Reshape data for plotting#
prepare_forest_plot_data <- function(model_data) {#
  # Transform to long format#
  long_data <- model_data %>%#
    pivot_longer(#
      cols = c("dynamic_auc", "static_auc", "cox_without_noulli", "cox_with_noulli"),#
      names_to = "model",#
      values_to = "auc"#
    ) %>%#
    mutate(#
      lower = case_when(#
        model == "dynamic_auc" ~ dynamic_lower,#
        model == "static_auc" ~ static_lower,#
        model == "cox_without_noulli" ~ cox_without_lower,#
        model == "cox_with_noulli" ~ cox_with_lower,#
        model == "td_cox" ~ td_cox_lower#
      ),#
      upper = case_when(#
        model == "dynamic_auc" ~ dynamic_upper,#
        model == "static_auc" ~ static_upper,#
        model == "cox_without_noulli" ~ cox_without_upper,#
        model == "cox_with_noulli" ~ cox_with_upper,#
        model == "td_cox" ~ td_cox_upper#
      ),#
      model = case_when(#
        model == "dynamic_auc" ~ "Aladynoulli Dynamic",#
        model == "static_auc" ~ "Aladynoulli Static",#
        model == "cox_without_noulli" ~ "Cox without Noulli",#
        model == "cox_with_noulli" ~ "Cox with Noulli",#
        model == "td_cox" ~ "TD Cox"#
      )#
    ) %>%#
    select(Disease, Events, Rate, model, auc, lower, upper)#
  # Make Disease a factor ordered by dynamic AUC#
  disease_order <- model_data %>%#
    arrange(desc(dynamic_auc)) %>%#
    pull(Disease)#
  long_data$Disease <- factor(long_data$Disease, levels = disease_order)#
  return(long_data)#
}
model_data <- parse_model_data("all_model_comp_withtdcox.csv")#
plot_data <- prepare_forest_plot_data(model_data)
plot_data
model_data
# Reshape data for plotting#
prepare_forest_plot_data <- function(model_data) {#
  # Transform to long format#
  long_data <- model_data %>%#
    pivot_longer(#
      cols = c("dynamic_auc", "static_auc", "cox_without_noulli", "cox_with_noulli"),#
      names_to = "model",#
      values_to = "auc"#
    ) %>%#
    mutate(#
      lower = case_when(#
        model == "dynamic_auc" ~ dynamic_lower,#
        model == "static_auc" ~ static_lower,#
        model == "cox_without_noulli" ~ cox_without_lower,#
        model == "cox_with_noulli" ~ cox_with_lower,#
        model == "td_cox" ~ td_cox_lower#
      ),#
      upper = case_when(#
        model == "dynamic_auc" ~ dynamic_upper,#
        model == "static_auc" ~ static_upper,#
        model == "cox_without_noulli" ~ cox_without_upper,#
        model == "cox_with_noulli" ~ cox_with_upper,#
        model == "td_cox" ~ td_cox_upper#
      ),#
      model = case_when(#
        model == "dynamic_auc" ~ "Aladynoulli Dynamic",#
        model == "static_auc" ~ "Aladynoulli Static",#
        model == "cox_without_noulli" ~ "Cox without Noulli",#
        model == "cox_with_noulli" ~ "Cox with Noulli",#
        model == "td_cox" ~ "TD Cox"#
      )#
    ) %>%#
    select(Disease, Events, Rate, model, auc, lower, upper)#
  # Make Disease a factor ordered by dynamic AUC#
  disease_order <- model_data %>%#
    arrange(desc(dynamic_auc)) %>%#
    pull(Disease)#
  long_data$Disease <- factor(long_data$Disease, levels = disease_order)#
  return(long_data)#
}
model_data <- parse_model_data("all_model_comp_withtdcox.csv")#
plot_data <- prepare_forest_plot_data(model_data)
plot_data
# Reshape data for plotting#
prepare_forest_plot_data <- function(model_data) {#
  # Transform to long format, now including TD Cox#
  long_data <- model_data %>%#
    pivot_longer(#
      cols = c("dynamic_auc", "static_auc", "cox_without_noulli", "cox_with_noulli", "td_cox_auc"),#
      names_to = "model",#
      values_to = "auc"#
    ) %>%#
    mutate(#
      lower = case_when(#
        model == "dynamic_auc" ~ dynamic_lower,#
        model == "static_auc" ~ static_lower,#
        model == "cox_without_noulli" ~ cox_without_lower,#
        model == "cox_with_noulli" ~ cox_with_lower,#
        model == "td_cox_auc" ~ td_cox_lower#
      ),#
      upper = case_when(#
        model == "dynamic_auc" ~ dynamic_upper,#
        model == "static_auc" ~ static_upper,#
        model == "cox_without_noulli" ~ cox_without_upper,#
        model == "cox_with_noulli" ~ cox_with_upper,#
        model == "td_cox_auc" ~ td_cox_upper#
      ),#
      model = case_when(#
        model == "dynamic_auc" ~ "Aladynoulli Dynamic",#
        model == "static_auc" ~ "Aladynoulli Static",#
        model == "cox_without_noulli" ~ "Cox without Noulli",#
        model == "cox_with_noulli" ~ "Cox with Noulli",#
        model == "td_cox_auc" ~ "TD Cox"#
      )#
    ) %>%#
    select(Disease, Events, Rate, model, auc, lower, upper)#
  # Make Disease a factor ordered by dynamic AUC#
  disease_order <- model_data %>%#
    arrange(desc(dynamic_auc)) %>%#
    pull(Disease)#
  long_data$Disease <- factor(long_data$Disease, levels = disease_order)#
  return(long_data)#
}
model_data <- parse_model_data("all_model_comp_withtdcox.csv")#
plot_data <- prepare_forest_plot_data(model_data)
plot_data
# Alternative approach with facet_wrap for separate panels by disease#
create_faceted_forest_plot <- function(plot_data) {#
  # Limit to top 16 diseases by dynamic AUC#
  top_diseases <- plot_data %>%#
    filter(model == "Aladynoulli Dynamic") %>%#
    arrange(desc(Events)) %>%#
    head(16) %>%#
    pull(Disease)#
  plot_data_subset <- plot_data %>%#
    filter(Disease %in% top_diseases)#
#
  plot_data_subset$Disease <- factor(plot_data_subset$Disease, levels = top_diseases)#
  # Define colors for models, now including TD Cox#
  model_colors <- c(#
    "Aladynoulli Dynamic" = "#4285F4",  # Blue#
    "Aladynoulli Static" = "#34A853",   # Green#
    "Cox without Noulli" = "#FBBC05",   # Yellow/Orange#
    "Cox with Noulli" = "#EA4335",      # Red#
    "TD Cox" = "#8E44AD"                # Purple (or pick your favorite color)#
  )#
  # Create the faceted plot#
  p <- ggplot(plot_data_subset, aes(x = model, y = auc, color = model)) +#
    geom_point(size = 5) +#
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +#
    facet_wrap(~ Disease, scales = "free_y", ncol = 4) +#
    geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +#
    scale_color_manual(values = model_colors) +#
    scale_y_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Performance across top 16 diseases",#
      y = "AUC (95% CI)",#
      x = NULL#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),#
      strip.text = element_text(face = "bold"),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}
model_data <- parse_model_data("all_model_comp_withtdcox.csv")#
plot_data <- prepare_forest_plot_data(model_data)
faceted_plot <- create_faceted_forest_plot(plot_data)
faceted_plot
create_faceted_forest_plot <- function(plot_data) {#
  # Limit to top 16 diseases by dynamic AUC#
  top_diseases <- plot_data %>%#
    filter(model == "Aladynoulli Dynamic") %>%#
    arrange(desc(Events)) %>%#
    head(16) %>%#
    pull(Disease)#
  plot_data_subset <- plot_data %>%#
    filter(Disease %in% top_diseases)#
#
  plot_data_subset$Disease <- factor(plot_data_subset$Disease, levels = top_diseases)#
  # Define colors for models, now including TD Cox#
  model_colors <- c(#
     "TD Cox" = "#8E44AD"                # Purple (or pick your favorite color)#
    "Aladynoulli Dynamic" = "#4285F4",  # Blue#
    "Aladynoulli Static" = "#34A853",   # Green#
    "Cox without Noulli" = "#FBBC05",   # Yellow/Orange#
    "Cox with Noulli" = "#EA4335",      # Red#
  )#
  # Create the faceted plot#
  p <- ggplot(plot_data_subset, aes(x = model, y = auc, color = model)) +#
    geom_point(size = 5) +#
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +#
    facet_wrap(~ Disease, scales = "free_y", ncol = 4) +#
    geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +#
    scale_color_manual(values = model_colors) +#
    scale_y_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Performance across top 16 diseases",#
      y = "AUC (95% CI)",#
      x = NULL#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),#
      strip.text = element_text(face = "bold"),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}
# Alternative approach with facet_wrap for separate panels by disease#
create_faceted_forest_plot <- function(plot_data) {#
  # Limit to top 16 diseases by dynamic AUC#
  top_diseases <- plot_data %>%#
    filter(model == "Aladynoulli Dynamic") %>%#
    arrange(desc(Events)) %>%#
    head(16) %>%#
    pull(Disease)#
  plot_data_subset <- plot_data %>%#
    filter(Disease %in% top_diseases)#
#
  plot_data_subset$Disease <- factor(plot_data_subset$Disease, levels = top_diseases)#
  # Define colors for models, now including TD Cox#
  model_colors <- c(#
     "TD Cox" = "#8E44AD"    ,            # Purple (or pick your favorite color)#
    "Aladynoulli Dynamic" = "#4285F4",  # Blue#
    "Aladynoulli Static" = "#34A853",   # Green#
    "Cox without Noulli" = "#FBBC05",   # Yellow/Orange#
    "Cox with Noulli" = "#EA4335",      # Red#
  )#
  # Create the faceted plot#
  p <- ggplot(plot_data_subset, aes(x = model, y = auc, color = model)) +#
    geom_point(size = 5) +#
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +#
    facet_wrap(~ Disease, scales = "free_y", ncol = 4) +#
    geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +#
    scale_color_manual(values = model_colors) +#
    scale_y_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Performance across top 16 diseases",#
      y = "AUC (95% CI)",#
      x = NULL#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),#
      strip.text = element_text(face = "bold"),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}
faceted_plot <- create_faceted_forest_plot(plot_data)
# Alternative approach with facet_wrap for separate panels by disease#
create_faceted_forest_plot <- function(plot_data) {#
  # Limit to top 16 diseases by dynamic AUC#
  top_diseases <- plot_data %>%#
    filter(model == "Aladynoulli Dynamic") %>%#
    arrange(desc(Events)) %>%#
    head(16) %>%#
    pull(Disease)#
  plot_data_subset <- plot_data %>%#
    filter(Disease %in% top_diseases)#
#
  plot_data_subset$Disease <- factor(plot_data_subset$Disease, levels = top_diseases)#
  # Define colors for models, now including TD Cox#
  model_colors <- c(#
    "TD Cox" = "#8E44AD",            # Purple (or pick your favorite color)#
    "Aladynoulli Dynamic" = "#4285F4",  # Blue#
    "Aladynoulli Static" = "#34A853",   # Green#
    "Cox without Noulli" = "#FBBC05",   # Yellow/Orange#
    "Cox with Noulli" = "#EA4335",      # Red#
  )#
  # Create the faceted plot#
  p <- ggplot(plot_data_subset, aes(x = model, y = auc, color = model)) +#
    geom_point(size = 5) +#
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +#
    facet_wrap(~ Disease, scales = "free_y", ncol = 4) +#
    geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +#
    scale_color_manual(values = model_colors) +#
    scale_y_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Performance across top 16 diseases",#
      y = "AUC (95% CI)",#
      x = NULL#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),#
      strip.text = element_text(face = "bold"),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}
faceted_plot <- create_faceted_forest_plot(plot_data)
with facet_wrap for separate panels by disease#
create_faceted_forest_plot <- function(plot_data) {#
  # Limit to top 16 diseases by dynamic AUC#
  top_diseases <- plot_data %>%#
    filter(model == "Aladynoulli Dynamic") %>%#
    arrange(desc(Events)) %>%#
    head(16) %>%#
    pull(Disease)#
  plot_data_subset <- plot_data %>%#
    filter(Disease %in% top_diseases)#
#
  plot_data_subset$Disease <- factor(plot_data_subset$Disease, levels = top_diseases)#
  # Define colors for models, now including TD Cox#
  model_colors <- c(#
    "TD Cox" = "#8E44AD",            # Purple (or pick your favorite color)#
    "Aladynoulli Dynamic" = "#4285F4",  # Blue#
    "Aladynoulli Static" = "#34A853",   # Green#
    "Cox without Noulli" = "#FBBC05",   # Yellow/Orange#
    "Cox with Noulli" = "#EA4335"    # Red#
  )#
  # Create the faceted plot#
  p <- ggplot(plot_data_subset, aes(x = model, y = auc, color = model)) +#
    geom_point(size = 5) +#
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +#
    facet_wrap(~ Disease, scales = "free_y", ncol = 4) +#
    geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +#
    scale_color_manual(values = model_colors) +#
    scale_y_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Performance across top 16 diseases",#
      y = "AUC (95% CI)",#
      x = NULL#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),#
      strip.text = element_text(face = "bold"),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}
faceted_plot <- create_faceted_forest_plot(plot_data)
faceted_plot
prepare_forest_plot_data <- function(model_data) {#
  # Transform to long format, now including TD Cox#
  long_data <- model_data %>%#
    pivot_longer(#
      cols = c("td_cox_auc", "dynamic_auc", "static_auc", "cox_with_noulli", "cox_without_noulli"),#
      names_to = "model",#
      values_to = "auc"#
    ) %>%#
    mutate(#
      lower = case_when(#
        model == "td_cox_auc" ~ td_cox_lower,#
        model == "dynamic_auc" ~ dynamic_lower,#
        model == "static_auc" ~ static_lower,#
        model == "cox_with_noulli" ~ cox_with_lower,#
        model == "cox_without_noulli" ~ cox_without_lower#
      ),#
      upper = case_when(#
        model == "td_cox_auc" ~ td_cox_upper,#
        model == "dynamic_auc" ~ dynamic_upper,#
        model == "static_auc" ~ static_upper,#
        model == "cox_with_noulli" ~ cox_with_upper,#
        model == "cox_without_noulli" ~ cox_without_upper#
      ),#
      model = case_when(#
        model == "td_cox_auc" ~ "Time-dependent Cox with Noulli",#
        model == "dynamic_auc" ~ "Aladynoulli Dynamic",#
        model == "static_auc" ~ "Aladynoulli Static",#
        model == "cox_with_noulli" ~ "Cox with Noulli",#
        model == "cox_without_noulli" ~ "Cox without Noulli"#
      )#
    ) %>%#
    select(Disease, Events, Rate, model, auc, lower, upper)#
  # Set the model order as requested#
  long_data$model <- factor(long_data$model, levels = c(#
    "Time-dependent Cox with Noulli",#
    "Aladynoulli Dynamic",#
    "Aladynoulli Static",#
    "Cox with Noulli",#
    "Cox without Noulli"#
  ))#
  # Make Disease a factor ordered by dynamic AUC#
  disease_order <- model_data %>%#
    arrange(desc(dynamic_auc)) %>%#
    pull(Disease)#
  long_data$Disease <- factor(long_data$Disease, levels = disease_order)#
  return(long_data)#
}
faceted_plot <- create_faceted_forest_plot(plot_data)
faceted_plot
# Load required libraries#
library(ggplot2)#
library(dplyr)#
library(tidyr)#
library(stringr)#
library(forcats)#
#
# Function to parse the data#
parse_model_data <- function(data_path) {#
  # Read the data#
  df <- read.csv(data_path)#
  # Extract confidence intervals from the formatted strings#
  extract_ci <- function(ci_str) {#
    # Matches format like "0.765 (0.748-0.782)"#
    pattern <- "(\\d+\\.\\d+)\\s*\\((\\d+\\.\\d+)-(\\d+\\.\\d+)\\)"#
    matches <- regexec(pattern, ci_str)#
    result <- regmatches(ci_str, matches)#
    if(length(result) > 0 && length(result[[1]]) >= 4) {#
      return(c(as.numeric(result[[1]][2]), #
               as.numeric(result[[1]][3]),#
               as.numeric(result[[1]][4])))#
    } else {#
      return(c(NA, NA, NA))#
    }#
  }#
  # Create a clean data frame#
  model_data <- data.frame(#
    Disease = df$Disease,#
    Events = df$Events,#
    Rate = df$Rate,#
    stringsAsFactors = FALSE#
  )#
  # Extract values for Aladynoulli Dynamic#
  dynamic_ci <- lapply(df$aladynoulli_auc_dynamic, extract_ci)#
  model_data$dynamic_auc <- sapply(dynamic_ci, function(x) x[1])#
  model_data$dynamic_lower <- sapply(dynamic_ci, function(x) x[2])#
  model_data$dynamic_upper <- sapply(dynamic_ci, function(x) x[3])#
  # Extract values for Aladynoulli Static#
  static_ci <- lapply(df$aladynoulli_auc_static, extract_ci)#
  model_data$static_auc <- sapply(static_ci, function(x) x[1])#
  model_data$static_lower <- sapply(static_ci, function(x) x[2])#
  model_data$static_upper <- sapply(static_ci, function(x) x[3])#
  # Add Cox values#
  model_data$cox_without_noulli <- df$cox_auc_without_noulli#
  model_data$cox_with_noulli <- df$cox_auc_with_noulli#
#
  # Add TD Cox AUC (as numeric)#
  model_data$td_cox_auc <- as.numeric(df$td_cox)#
  # Calculate CI for Cox values (using the formula SE = sqrt((AUC * (1-AUC)) / (n * prevalence)))#
  calc_cox_ci <- function(auc, events, total = 400000) {#
    prevalence <- events / total#
    prevalence <- max(0.01, prevalence)#
    se <- sqrt((auc * (1 - auc)) / (total * prevalence))#
    lower <- max(0, auc - 1.96 * se)#
    upper <- min(1, auc + 1.96 * se)#
    return(c(lower, upper))#
  }#
  # Add CI for Cox without Noulli#
  cox_without_ci <- mapply(calc_cox_ci, #
                           model_data$cox_without_noulli, #
                           model_data$Events, #
                           SIMPLIFY = FALSE)#
  model_data$cox_without_lower <- sapply(cox_without_ci, function(x) x[1])#
  model_data$cox_without_upper <- sapply(cox_without_ci, function(x) x[2])#
  # Add CI for Cox with Noulli#
  cox_with_ci <- mapply(calc_cox_ci, #
                        model_data$cox_with_noulli, #
                        model_data$Events, #
                        SIMPLIFY = FALSE)#
  model_data$cox_with_lower <- sapply(cox_with_ci, function(x) x[1])#
  model_data$cox_with_upper <- sapply(cox_with_ci, function(x) x[2])#
#
  # Add CI for TD Cox#
  td_cox_ci <- mapply(calc_cox_ci, #
                      model_data$td_cox_auc, #
                      model_data$Events, #
                      SIMPLIFY = FALSE)#
  model_data$td_cox_lower <- sapply(td_cox_ci, function(x) x[1])#
  model_data$td_cox_upper <- sapply(td_cox_ci, function(x) x[2])#
  return(model_data)#
}#
#
# Reshape data for plotting#
prepare_forest_plot_data <- function(model_data) {#
  # Transform to long format, now including TD Cox#
  long_data <- model_data %>%#
    pivot_longer(#
      cols = c("td_cox_auc", "dynamic_auc", "static_auc", "cox_with_noulli", "cox_without_noulli"),#
      names_to = "model",#
      values_to = "auc"#
    ) %>%#
    mutate(#
      lower = case_when(#
        model == "td_cox_auc" ~ td_cox_lower,#
        model == "dynamic_auc" ~ dynamic_lower,#
        model == "static_auc" ~ static_lower,#
        model == "cox_with_noulli" ~ cox_with_lower,#
        model == "cox_without_noulli" ~ cox_without_lower#
      ),#
      upper = case_when(#
        model == "td_cox_auc" ~ td_cox_upper,#
        model == "dynamic_auc" ~ dynamic_upper,#
        model == "static_auc" ~ static_upper,#
        model == "cox_with_noulli" ~ cox_with_upper,#
        model == "cox_without_noulli" ~ cox_without_upper#
      ),#
      model = case_when(#
        model == "td_cox_auc" ~ "Time-dependent Cox with Noulli",#
        model == "dynamic_auc" ~ "Aladynoulli Dynamic",#
        model == "static_auc" ~ "Aladynoulli Static",#
        model == "cox_with_noulli" ~ "Cox with Noulli",#
        model == "cox_without_noulli" ~ "Cox without Noulli"#
      )#
    ) %>%#
    select(Disease, Events, Rate, model, auc, lower, upper)#
  # Set the model order as requested#
  long_data$model <- factor(long_data$model, levels = c(#
    "Time-dependent Cox with Noulli",#
    "Aladynoulli Dynamic",#
    "Aladynoulli Static",#
    "Cox with Noulli",#
    "Cox without Noulli"#
  ))#
  # Make Disease a factor ordered by dynamic AUC#
  disease_order <- model_data %>%#
    arrange(desc(dynamic_auc)) %>%#
    pull(Disease)#
  long_data$Disease <- factor(long_data$Disease, levels = disease_order)#
  return(long_data)#
}#
#
# Create the forest plot#
create_forest_plot <- function(plot_data) {#
  # Define colors for models#
  model_colors <- c(#
    "Time-dependent Cox with Noulli" = "#8E44AD",   # Purple#
    "Aladynoulli Dynamic" = "#4285F4",              # Blue#
    "Aladynoulli Static" = "#34A853",               # Green#
    "Cox with Noulli" = "#EA4335",                  # Red#
    "Cox without Noulli" = "#FBBC05"                # Yellow/Orange#
  )#
  # Shape the disease names to be more readable#
  plot_data <- plot_data %>%#
    mutate(Disease = str_replace_all(Disease, "_", " "))#
  # Create the plot#
  p <- ggplot(plot_data, aes(x = auc, y = Disease, color = model)) +#
    geom_vline(xintercept = 0.5, linetype = "dashed", color = "gray70") +#
    geom_point(aes(shape = model), size = 2.5, position = position_dodge(width = 0.5)) +#
    geom_errorbarh(aes(xmin = lower, xmax = upper), height = 0.2, position = position_dodge(width = 0.5)) +#
    scale_color_manual(values = model_colors) +#
    scale_x_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Comparing performance of four prediction models across 28 diseases",#
      x = "AUC (95% CI)",#
      y = NULL,#
      color = "Model",#
      shape = "Model"#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      panel.grid.major.y = element_line(color = "gray90"),#
      panel.grid.minor.y = element_blank(),#
      axis.text.y = element_text(size = 10),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}#
#
# Main function to run the analysis#
create_multidisease_comparison <- function(data_path) {#
  # Parse the data#
  model_data <- parse_model_data(data_path)#
  # Prepare data for plotting#
  plot_data <- prepare_forest_plot_data(model_data)#
  # Create forest plot#
  forest_plot <- create_forest_plot(plot_data)#
  # Save the plot#
  ggsave("multidisease_forest_plot.png", forest_plot, width = 12, height = 14, dpi = 300)#
  # Print summary statistics#
  model_summary <- plot_data %>%#
    group_by(model) %>%#
    summarize(#
      mean_auc = mean(auc, na.rm = TRUE),#
      median_auc = median(auc, na.rm = TRUE),#
      min_auc = min(auc, na.rm = TRUE),#
      max_auc = max(auc, na.rm = TRUE)#
    )#
  print(model_summary)#
  return(forest_plot)#
}#
#
# Example usage:#
# forest_plot <- create_multidisease_comparison("model_comparison_everything.csv")#
# print(forest_plot)#
#
# Alternative approach with facet_wrap for separate panels by disease#
create_faceted_forest_plot <- function(plot_data) {#
  # Limit to top 16 diseases by dynamic AUC#
  top_diseases <- plot_data %>%#
    filter(model == "Aladynoulli Dynamic") %>%#
    arrange(desc(Events)) %>%#
    head(16) %>%#
    pull(Disease)#
  plot_data_subset <- plot_data %>%#
    filter(Disease %in% top_diseases)#
#
  plot_data_subset$Disease <- factor(plot_data_subset$Disease, levels = top_diseases)#
  # Define colors for models, now including TD Cox#
  model_colors <- c(#
    "Time-dependent Cox with Noulli" = "#8E44AD",   # Purple#
    "Aladynoulli Dynamic" = "#4285F4",              # Blue#
    "Aladynoulli Static" = "#34A853",               # Green#
    "Cox with Noulli" = "#EA4335",                  # Red#
    "Cox without Noulli" = "#FBBC05"                # Yellow/Orange#
  )#
  # Create the faceted plot#
  p <- ggplot(plot_data_subset, aes(x = model, y = auc, color = model)) +#
    geom_point(size = 5) +#
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +#
    facet_wrap(~ Disease, scales = "free_y", ncol = 4) +#
    geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +#
    scale_color_manual(values = model_colors) +#
    scale_y_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Performance across top 16 diseases",#
      y = "AUC (95% CI)",#
      x = NULL#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),#
      strip.text = element_text(face = "bold"),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}#
model_data <- parse_model_data("~/Library/CloudStorage/Dropbox/model_comparison_everything.csv")#
plot_data <- prepare_forest_plot_data(model_data)#
#
# Add this line to also generate the faceted plot#
faceted_plot <- create_faceted_forest_plot(plot_data)#
ggsave("multidisease_faceted_plot.pdf", faceted_plot, width = 12, height = 12, dpi = 300)
# Load required libraries#
library(ggplot2)#
library(dplyr)#
library(tidyr)#
library(stringr)#
library(forcats)#
#
# Function to parse the data#
parse_model_data <- function(data_path) {#
  # Read the data#
  df <- read.csv(data_path)#
  # Extract confidence intervals from the formatted strings#
  extract_ci <- function(ci_str) {#
    # Matches format like "0.765 (0.748-0.782)"#
    pattern <- "(\\d+\\.\\d+)\\s*\\((\\d+\\.\\d+)-(\\d+\\.\\d+)\\)"#
    matches <- regexec(pattern, ci_str)#
    result <- regmatches(ci_str, matches)#
    if(length(result) > 0 && length(result[[1]]) >= 4) {#
      return(c(as.numeric(result[[1]][2]), #
               as.numeric(result[[1]][3]),#
               as.numeric(result[[1]][4])))#
    } else {#
      return(c(NA, NA, NA))#
    }#
  }#
  # Create a clean data frame#
  model_data <- data.frame(#
    Disease = df$Disease,#
    Events = df$Events,#
    Rate = df$Rate,#
    stringsAsFactors = FALSE#
  )#
  # Extract values for Aladynoulli Dynamic#
  dynamic_ci <- lapply(df$aladynoulli_auc_dynamic, extract_ci)#
  model_data$dynamic_auc <- sapply(dynamic_ci, function(x) x[1])#
  model_data$dynamic_lower <- sapply(dynamic_ci, function(x) x[2])#
  model_data$dynamic_upper <- sapply(dynamic_ci, function(x) x[3])#
  # Extract values for Aladynoulli Static#
  static_ci <- lapply(df$aladynoulli_auc_static, extract_ci)#
  model_data$static_auc <- sapply(static_ci, function(x) x[1])#
  model_data$static_lower <- sapply(static_ci, function(x) x[2])#
  model_data$static_upper <- sapply(static_ci, function(x) x[3])#
  # Add Cox values#
  model_data$cox_without_noulli <- df$cox_auc_without_noulli#
  model_data$cox_with_noulli <- df$cox_auc_with_noulli#
#
  # Add TD Cox AUC (as numeric)#
  model_data$td_cox_auc <- as.numeric(df$td_cox)#
  # Calculate CI for Cox values (using the formula SE = sqrt((AUC * (1-AUC)) / (n * prevalence)))#
  calc_cox_ci <- function(auc, events, total = 400000) {#
    prevalence <- events / total#
    prevalence <- max(0.01, prevalence)#
    se <- sqrt((auc * (1 - auc)) / (total * prevalence))#
    lower <- max(0, auc - 1.96 * se)#
    upper <- min(1, auc + 1.96 * se)#
    return(c(lower, upper))#
  }#
  # Add CI for Cox without Noulli#
  cox_without_ci <- mapply(calc_cox_ci, #
                           model_data$cox_without_noulli, #
                           model_data$Events, #
                           SIMPLIFY = FALSE)#
  model_data$cox_without_lower <- sapply(cox_without_ci, function(x) x[1])#
  model_data$cox_without_upper <- sapply(cox_without_ci, function(x) x[2])#
  # Add CI for Cox with Noulli#
  cox_with_ci <- mapply(calc_cox_ci, #
                        model_data$cox_with_noulli, #
                        model_data$Events, #
                        SIMPLIFY = FALSE)#
  model_data$cox_with_lower <- sapply(cox_with_ci, function(x) x[1])#
  model_data$cox_with_upper <- sapply(cox_with_ci, function(x) x[2])#
#
  # Add CI for TD Cox#
  td_cox_ci <- mapply(calc_cox_ci, #
                      model_data$td_cox_auc, #
                      model_data$Events, #
                      SIMPLIFY = FALSE)#
  model_data$td_cox_lower <- sapply(td_cox_ci, function(x) x[1])#
  model_data$td_cox_upper <- sapply(td_cox_ci, function(x) x[2])#
  return(model_data)#
}#
#
# Reshape data for plotting#
prepare_forest_plot_data <- function(model_data) {#
  # Transform to long format, now including TD Cox#
  long_data <- model_data %>%#
    pivot_longer(#
      cols = c("td_cox_auc", "dynamic_auc", "static_auc", "cox_with_noulli", "cox_without_noulli"),#
      names_to = "model",#
      values_to = "auc"#
    ) %>%#
    mutate(#
      lower = case_when(#
        model == "td_cox_auc" ~ td_cox_lower,#
        model == "dynamic_auc" ~ dynamic_lower,#
        model == "static_auc" ~ static_lower,#
        model == "cox_with_noulli" ~ cox_with_lower,#
        model == "cox_without_noulli" ~ cox_without_lower#
      ),#
      upper = case_when(#
        model == "td_cox_auc" ~ td_cox_upper,#
        model == "dynamic_auc" ~ dynamic_upper,#
        model == "static_auc" ~ static_upper,#
        model == "cox_with_noulli" ~ cox_with_upper,#
        model == "cox_without_noulli" ~ cox_without_upper#
      ),#
      model = case_when(#
        model == "td_cox_auc" ~ "Time-dependent Cox with Noulli",#
        model == "dynamic_auc" ~ "Aladynoulli Dynamic",#
        model == "static_auc" ~ "Aladynoulli Static",#
        model == "cox_with_noulli" ~ "Cox with Noulli",#
        model == "cox_without_noulli" ~ "Cox without Noulli"#
      )#
    ) %>%#
    select(Disease, Events, Rate, model, auc, lower, upper)#
  # Set the model order as requested#
  long_data$model <- factor(long_data$model, levels = c(#
    "Time-dependent Cox with Noulli",#
    "Aladynoulli Dynamic",#
    "Aladynoulli Static",#
    "Cox with Noulli",#
    "Cox without Noulli"#
  ))#
  # Make Disease a factor ordered by dynamic AUC#
  disease_order <- model_data %>%#
    arrange(desc(dynamic_auc)) %>%#
    pull(Disease)#
  long_data$Disease <- factor(long_data$Disease, levels = disease_order)#
  return(long_data)#
}#
#
# Create the forest plot#
create_forest_plot <- function(plot_data) {#
  # Define colors for models#
  model_colors <- c(#
    "Time-dependent Cox with Noulli" = "#8E44AD",   # Purple#
    "Aladynoulli Dynamic" = "#4285F4",              # Blue#
    "Aladynoulli Static" = "#34A853",               # Green#
    "Cox with Noulli" = "#EA4335",                  # Red#
    "Cox without Noulli" = "#FBBC05"                # Yellow/Orange#
  )#
  # Shape the disease names to be more readable#
  plot_data <- plot_data %>%#
    mutate(Disease = str_replace_all(Disease, "_", " "))#
  # Create the plot#
  p <- ggplot(plot_data, aes(x = auc, y = Disease, color = model)) +#
    geom_vline(xintercept = 0.5, linetype = "dashed", color = "gray70") +#
    geom_point(aes(shape = model), size = 2.5, position = position_dodge(width = 0.5)) +#
    geom_errorbarh(aes(xmin = lower, xmax = upper), height = 0.2, position = position_dodge(width = 0.5)) +#
    scale_color_manual(values = model_colors) +#
    scale_x_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Comparing performance of four prediction models across 28 diseases",#
      x = "AUC (95% CI)",#
      y = NULL,#
      color = "Model",#
      shape = "Model"#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      panel.grid.major.y = element_line(color = "gray90"),#
      panel.grid.minor.y = element_blank(),#
      axis.text.y = element_text(size = 10),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}#
#
# Main function to run the analysis#
create_multidisease_comparison <- function(data_path) {#
  # Parse the data#
  model_data <- parse_model_data(data_path)#
  # Prepare data for plotting#
  plot_data <- prepare_forest_plot_data(model_data)#
  # Create forest plot#
  forest_plot <- create_forest_plot(plot_data)#
  # Save the plot#
  ggsave("multidisease_forest_plot.png", forest_plot, width = 12, height = 14, dpi = 300)#
  # Print summary statistics#
  model_summary <- plot_data %>%#
    group_by(model) %>%#
    summarize(#
      mean_auc = mean(auc, na.rm = TRUE),#
      median_auc = median(auc, na.rm = TRUE),#
      min_auc = min(auc, na.rm = TRUE),#
      max_auc = max(auc, na.rm = TRUE)#
    )#
  print(model_summary)#
  return(forest_plot)#
}#
#
# Example usage:#
# forest_plot <- create_multidisease_comparison("model_comparison_everything.csv")#
# print(forest_plot)#
#
# Alternative approach with facet_wrap for separate panels by disease#
create_faceted_forest_plot <- function(plot_data) {#
  # Limit to top 16 diseases by dynamic AUC#
  top_diseases <- plot_data %>%#
    filter(model == "Aladynoulli Dynamic") %>%#
    arrange(desc(Events)) %>%#
    head(16) %>%#
    pull(Disease)#
  plot_data_subset <- plot_data %>%#
    filter(Disease %in% top_diseases)#
#
  plot_data_subset$Disease <- factor(plot_data_subset$Disease, levels = top_diseases)#
  # Define colors for models, now including TD Cox#
  model_colors <- c(#
    "Time-dependent Cox with Noulli" = "#8E44AD",   # Purple#
    "Aladynoulli Dynamic" = "#4285F4",              # Blue#
    "Aladynoulli Static" = "#34A853",               # Green#
    "Cox with Noulli" = "#EA4335",                  # Red#
    "Cox without Noulli" = "#FBBC05"                # Yellow/Orange#
  )#
  # Create the faceted plot#
  p <- ggplot(plot_data_subset, aes(x = model, y = auc, color = model)) +#
    geom_point(size = 5) +#
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +#
    facet_wrap(~ Disease, scales = "free_y", ncol = 4) +#
    geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +#
    scale_color_manual(values = model_colors) +#
    scale_y_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Performance across top 16 diseases",#
      y = "AUC (95% CI)",#
      x = NULL#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),#
      strip.text = element_text(face = "bold"),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}#
model_data <- parse_model_data("~/Library/CloudStorage/Dropbox/model_comparison_everything.csv")#
plot_data <- prepare_forest_plot_data(model_data)#
#
# Add this line to also generate the faceted plot#
faceted_plot <- create_faceted_forest_plot(plot_data)#
ggsave("multidisease_faceted_plot.pdf", faceted_plot, width = 12, height = 12, dpi = 300)
# Load required libraries#
library(ggplot2)#
library(dplyr)#
library(tidyr)#
library(stringr)#
library(forcats)#
#
# Function to parse the data#
parse_model_data <- function(data_path) {#
  # Read the data#
  df <- read.csv(data_path)#
  # Extract confidence intervals from the formatted strings#
  extract_ci <- function(ci_str) {#
    # Matches format like "0.765 (0.748-0.782)"#
    pattern <- "(\\d+\\.\\d+)\\s*\\((\\d+\\.\\d+)-(\\d+\\.\\d+)\\)"#
    matches <- regexec(pattern, ci_str)#
    result <- regmatches(ci_str, matches)#
    if(length(result) > 0 && length(result[[1]]) >= 4) {#
      return(c(as.numeric(result[[1]][2]), #
               as.numeric(result[[1]][3]),#
               as.numeric(result[[1]][4])))#
    } else {#
      return(c(NA, NA, NA))#
    }#
  }#
  # Create a clean data frame#
  model_data <- data.frame(#
    Disease = df$Disease,#
    Events = df$Events,#
    Rate = df$Rate,#
    stringsAsFactors = FALSE#
  )#
  # Extract values for Aladynoulli Dynamic#
  dynamic_ci <- lapply(df$aladynoulli_auc_dynamic, extract_ci)#
  model_data$dynamic_auc <- sapply(dynamic_ci, function(x) x[1])#
  model_data$dynamic_lower <- sapply(dynamic_ci, function(x) x[2])#
  model_data$dynamic_upper <- sapply(dynamic_ci, function(x) x[3])#
  # Extract values for Aladynoulli Static#
  static_ci <- lapply(df$aladynoulli_auc_static, extract_ci)#
  model_data$static_auc <- sapply(static_ci, function(x) x[1])#
  model_data$static_lower <- sapply(static_ci, function(x) x[2])#
  model_data$static_upper <- sapply(static_ci, function(x) x[3])#
  # Add Cox values#
  model_data$cox_without_noulli <- df$cox_auc_without_noulli#
  model_data$cox_with_noulli <- df$cox_auc_with_noulli#
#
  # Add TD Cox AUC (as numeric)#
  model_data$td_cox_auc <- as.numeric(df$td_cox)#
  # Calculate CI for Cox values (using the formula SE = sqrt((AUC * (1-AUC)) / (n * prevalence)))#
  calc_cox_ci <- function(auc, events, total = 400000) {#
    prevalence <- events / total#
    prevalence <- max(0.01, prevalence)#
    se <- sqrt((auc * (1 - auc)) / (total * prevalence))#
    lower <- max(0, auc - 1.96 * se)#
    upper <- min(1, auc + 1.96 * se)#
    return(c(lower, upper))#
  }#
  # Add CI for Cox without Noulli#
  cox_without_ci <- mapply(calc_cox_ci, #
                           model_data$cox_without_noulli, #
                           model_data$Events, #
                           SIMPLIFY = FALSE)#
  model_data$cox_without_lower <- sapply(cox_without_ci, function(x) x[1])#
  model_data$cox_without_upper <- sapply(cox_without_ci, function(x) x[2])#
  # Add CI for Cox with Noulli#
  cox_with_ci <- mapply(calc_cox_ci, #
                        model_data$cox_with_noulli, #
                        model_data$Events, #
                        SIMPLIFY = FALSE)#
  model_data$cox_with_lower <- sapply(cox_with_ci, function(x) x[1])#
  model_data$cox_with_upper <- sapply(cox_with_ci, function(x) x[2])#
#
  # Add CI for TD Cox#
  td_cox_ci <- mapply(calc_cox_ci, #
                      model_data$td_cox, #
                      model_data$Events, #
                      SIMPLIFY = FALSE)#
  model_data$td_cox_lower <- sapply(td_cox_ci, function(x) x[1])#
  model_data$td_cox_upper <- sapply(td_cox_ci, function(x) x[2])#
  return(model_data)#
}#
#
# Reshape data for plotting#
prepare_forest_plot_data <- function(model_data) {#
  # Transform to long format, now including TD Cox#
  long_data <- model_data %>%#
    pivot_longer(#
      cols = c("td_cox_auc", "dynamic_auc", "static_auc", "cox_with_noulli", "cox_without_noulli"),#
      names_to = "model",#
      values_to = "auc"#
    ) %>%#
    mutate(#
      lower = case_when(#
        model == "td_cox_auc" ~ td_cox_lower,#
        model == "dynamic_auc" ~ dynamic_lower,#
        model == "static_auc" ~ static_lower,#
        model == "cox_with_noulli" ~ cox_with_lower,#
        model == "cox_without_noulli" ~ cox_without_lower#
      ),#
      upper = case_when(#
        model == "td_cox_auc" ~ td_cox_upper,#
        model == "dynamic_auc" ~ dynamic_upper,#
        model == "static_auc" ~ static_upper,#
        model == "cox_with_noulli" ~ cox_with_upper,#
        model == "cox_without_noulli" ~ cox_without_upper#
      ),#
      model = case_when(#
        model == "td_cox_auc" ~ "Time-dependent Cox with Noulli",#
        model == "dynamic_auc" ~ "Aladynoulli Dynamic",#
        model == "static_auc" ~ "Aladynoulli Static",#
        model == "cox_with_noulli" ~ "Cox with Noulli",#
        model == "cox_without_noulli" ~ "Cox without Noulli"#
      )#
    ) %>%#
    select(Disease, Events, Rate, model, auc, lower, upper)#
  # Set the model order as requested#
  long_data$model <- factor(long_data$model, levels = c(#
    "Time-dependent Cox with Noulli",#
    "Aladynoulli Dynamic",#
    "Aladynoulli Static",#
    "Cox with Noulli",#
    "Cox without Noulli"#
  ))#
  # Make Disease a factor ordered by dynamic AUC#
  disease_order <- model_data %>%#
    arrange(desc(dynamic_auc)) %>%#
    pull(Disease)#
  long_data$Disease <- factor(long_data$Disease, levels = disease_order)#
  return(long_data)#
}#
#
# Create the forest plot#
create_forest_plot <- function(plot_data) {#
  # Define colors for models#
  model_colors <- c(#
    "Time-dependent Cox with Noulli" = "#8E44AD",   # Purple#
    "Aladynoulli Dynamic" = "#4285F4",              # Blue#
    "Aladynoulli Static" = "#34A853",               # Green#
    "Cox with Noulli" = "#EA4335",                  # Red#
    "Cox without Noulli" = "#FBBC05"                # Yellow/Orange#
  )#
  # Shape the disease names to be more readable#
  plot_data <- plot_data %>%#
    mutate(Disease = str_replace_all(Disease, "_", " "))#
  # Create the plot#
  p <- ggplot(plot_data, aes(x = auc, y = Disease, color = model)) +#
    geom_vline(xintercept = 0.5, linetype = "dashed", color = "gray70") +#
    geom_point(aes(shape = model), size = 2.5, position = position_dodge(width = 0.5)) +#
    geom_errorbarh(aes(xmin = lower, xmax = upper), height = 0.2, position = position_dodge(width = 0.5)) +#
    scale_color_manual(values = model_colors) +#
    scale_x_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Comparing performance of four prediction models across 28 diseases",#
      x = "AUC (95% CI)",#
      y = NULL,#
      color = "Model",#
      shape = "Model"#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      panel.grid.major.y = element_line(color = "gray90"),#
      panel.grid.minor.y = element_blank(),#
      axis.text.y = element_text(size = 10),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}#
#
# Main function to run the analysis#
create_multidisease_comparison <- function(data_path) {#
  # Parse the data#
  model_data <- parse_model_data(data_path)#
  # Prepare data for plotting#
  plot_data <- prepare_forest_plot_data(model_data)#
  # Create forest plot#
  forest_plot <- create_forest_plot(plot_data)#
  # Save the plot#
  ggsave("multidisease_forest_plot.png", forest_plot, width = 12, height = 14, dpi = 300)#
  # Print summary statistics#
  model_summary <- plot_data %>%#
    group_by(model) %>%#
    summarize(#
      mean_auc = mean(auc, na.rm = TRUE),#
      median_auc = median(auc, na.rm = TRUE),#
      min_auc = min(auc, na.rm = TRUE),#
      max_auc = max(auc, na.rm = TRUE)#
    )#
  print(model_summary)#
  return(forest_plot)#
}#
#
# Example usage:#
# forest_plot <- create_multidisease_comparison("model_comparison_everything.csv")#
# print(forest_plot)#
#
# Alternative approach with facet_wrap for separate panels by disease#
create_faceted_forest_plot <- function(plot_data) {#
  # Limit to top 16 diseases by dynamic AUC#
  top_diseases <- plot_data %>%#
    filter(model == "Aladynoulli Dynamic") %>%#
    arrange(desc(Events)) %>%#
    head(16) %>%#
    pull(Disease)#
  plot_data_subset <- plot_data %>%#
    filter(Disease %in% top_diseases)#
#
  plot_data_subset$Disease <- factor(plot_data_subset$Disease, levels = top_diseases)#
  # Define colors for models, now including TD Cox#
  model_colors <- c(#
    "Time-dependent Cox with Noulli" = "#8E44AD",   # Purple#
    "Aladynoulli Dynamic" = "#4285F4",              # Blue#
    "Aladynoulli Static" = "#34A853",               # Green#
    "Cox with Noulli" = "#EA4335",                  # Red#
    "Cox without Noulli" = "#FBBC05"                # Yellow/Orange#
  )#
  # Create the faceted plot#
  p <- ggplot(plot_data_subset, aes(x = model, y = auc, color = model)) +#
    geom_point(size = 5) +#
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +#
    facet_wrap(~ Disease, scales = "free_y", ncol = 4) +#
    geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +#
    scale_color_manual(values = model_colors) +#
    scale_y_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Performance across top 16 diseases",#
      y = "AUC (95% CI)",#
      x = NULL#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),#
      strip.text = element_text(face = "bold"),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}#
model_data <- parse_model_data("~/Library/CloudStorage/Dropbox/model_comparison_everything.csv")#
plot_data <- prepare_forest_plot_data(model_data)#
#
# Add this line to also generate the faceted plot#
faceted_plot <- create_faceted_forest_plot(plot_data)#
ggsave("multidisease_faceted_plot.pdf", faceted_plot, width = 12, height = 12, dpi = 300)#
#
# Function for time-d
parse_model_data
head(m)
m$td_cox
model_data <- parse_model_data("~/Library/CloudStorage/Dropbox/model_comparison_everything.csv")
# Load required libraries#
library(ggplot2)#
library(dplyr)#
library(tidyr)#
library(stringr)#
library(forcats)#
#
# Function to parse the data#
parse_model_data <- function(data_path) {#
  # Read the data#
  df <- read.csv(data_path)#
  # Extract confidence intervals from the formatted strings#
  extract_ci <- function(ci_str) {#
    # Matches format like "0.765 (0.748-0.782)"#
    pattern <- "(\\d+\\.\\d+)\\s*\\((\\d+\\.\\d+)-(\\d+\\.\\d+)\\)"#
    matches <- regexec(pattern, ci_str)#
    result <- regmatches(ci_str, matches)#
    if(length(result) > 0 && length(result[[1]]) >= 4) {#
      return(c(as.numeric(result[[1]][2]), #
               as.numeric(result[[1]][3]),#
               as.numeric(result[[1]][4])))#
    } else {#
      return(c(NA, NA, NA))#
    }#
  }#
  # Create a clean data frame#
  model_data <- data.frame(#
    Disease = df$Disease,#
    Events = df$Events,#
    Rate = df$Rate,#
    stringsAsFactors = FALSE#
  )#
  # Extract values for Aladynoulli Dynamic#
  dynamic_ci <- lapply(df$aladynoulli_auc_dynamic, extract_ci)#
  model_data$dynamic_auc <- sapply(dynamic_ci, function(x) x[1])#
  model_data$dynamic_lower <- sapply(dynamic_ci, function(x) x[2])#
  model_data$dynamic_upper <- sapply(dynamic_ci, function(x) x[3])#
  # Extract values for Aladynoulli Static#
  static_ci <- lapply(df$aladynoulli_auc_static, extract_ci)#
  model_data$static_auc <- sapply(static_ci, function(x) x[1])#
  model_data$static_lower <- sapply(static_ci, function(x) x[2])#
  model_data$static_upper <- sapply(static_ci, function(x) x[3])#
  # Add Cox values#
  model_data$cox_without_noulli <- df$cox_auc_without_noulli#
  model_data$cox_with_noulli <- df$cox_auc_with_noulli#
#
  # Add TD Cox AUC (as numeric)#
  model_data$td_cox_auc <- as.numeric(df$td_cox)#
  # Calculate CI for Cox values (using the formula SE = sqrt((AUC * (1-AUC)) / (n * prevalence)))#
  calc_cox_ci <- function(auc, events, total = 400000) {#
    prevalence <- events / total#
    prevalence <- max(0.01, prevalence)#
    se <- sqrt((auc * (1 - auc)) / (total * prevalence))#
    lower <- max(0, auc - 1.96 * se)#
    upper <- min(1, auc + 1.96 * se)#
    return(c(lower, upper))#
  }#
  # Add CI for Cox without Noulli#
  cox_without_ci <- mapply(calc_cox_ci, #
                           model_data$cox_without_noulli, #
                           model_data$Events, #
                           SIMPLIFY = FALSE)#
  model_data$cox_without_lower <- sapply(cox_without_ci, function(x) x[1])#
  model_data$cox_without_upper <- sapply(cox_without_ci, function(x) x[2])#
  # Add CI for Cox with Noulli#
  cox_with_ci <- mapply(calc_cox_ci, #
                        model_data$cox_with_noulli, #
                        model_data$Events, #
                        SIMPLIFY = FALSE)#
  model_data$cox_with_lower <- sapply(cox_with_ci, function(x) x[1])#
  model_data$cox_with_upper <- sapply(cox_with_ci, function(x) x[2])#
#
  # Add CI for TD Cox#
  td_cox_ci <- mapply(calc_cox_ci, #
                      model_data$td_cox_auc, #
                      model_data$Events, #
                      SIMPLIFY = FALSE)#
  model_data$td_cox_lower <- sapply(td_cox_ci, function(x) x[1])#
  model_data$td_cox_upper <- sapply(td_cox_ci, function(x) x[2])#
  return(model_data)#
}
# Load required #
model_data <- parse_model_data("~/Library/CloudStorage/Dropbox/model_comparison_everything.csv")#
plot_data <- prepare_forest_plot_data(model_data)#
#
# Add this line to also generate the faceted plot#
faceted_plot <- create_faceted_forest_plot(plot_data)#
ggsave("multidisease_faceted_plot.pdf", faceted_plot, width = 12, height = 12, dpi = 300)
parse_model_data
df=read.csv("all_model_comp_withtdcox.csv")
parse_model_data("all_model_comp_withtdcox.csv")
model_data <- parse_model_data("all_model_comp_withtdcox.csv")#
plot_data <- prepare_forest_plot_data(model_data)#
forest_plot <- create_forest_plot(plot_data)#
ggsave("multidisease_forest_plot.png", forest_plot, width = 12, height = 14, dpi = 300)#
print(forest_plot)parse_model_data("all_model_comp_withtdcox.csv")
forest_plot
faceted_plot <- create_faceted_forest_plot(plot_data)#
ggsave("multidisease_faceted_plot.pdf", faceted_plot, width = 12, height = 12, dpi = 300)#
print(faceted_plot)
# Alternative approach with facet_wrap for separate panels by disease#
create_faceted_forest_plot <- function(plot_data) {#
  # Limit to top 16 diseases by dynamic AUC#
  top_diseases <- plot_data %>%#
    filter(model == "Aladynoulli Dynamic") %>%#
    arrange(desc(Events)) %>%#
    head(16) %>%#
    pull(Disease)#
  plot_data_subset <- plot_data %>%#
    filter(Disease %in% top_diseases)#
#
  plot_data_subset$Disease <- factor(plot_data_subset$Disease, levels = top_diseases)#
  plot_data_subset=plot_data%>%#
    filter(Disease %in% c("ASCVD","Diabetes","All_Cancers","COPD","Atrial_Fib","Pneumonia","Secondary_Cancer","Osteoporosis",#
                          "Breast Cancer","CKD","Heart_Failure","Rheumatoid_Arthritis","Stroke"))#
  # Define colors for models, now including TD Cox#
  model_colors <- c(#
    "Time-dependent Cox with Noulli" = "#8E44AD",   # Purple#
    "Aladynoulli Dynamic" = "#4285F4",              # Blue#
    "Aladynoulli Static" = "#34A853",               # Green#
    "Cox with Noulli" = "#EA4335",                  # Red#
    "Cox without Noulli" = "#FBBC05"                # Yellow/Orange#
  )#
  # Create the faceted plot#
  p <- ggplot(plot_data_subset, aes(x = model, y = auc, color = model)) +#
    geom_point(size = 5) +#
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +#
    facet_wrap(~ Disease, scales = "free_y", ncol = 4) +#
    geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +#
    scale_color_manual(values = model_colors) +#
    scale_y_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Performance across top 16 diseases",#
      y = "AUC (95% CI)",#
      x = NULL#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),#
      strip.text = element_text(face = "bold"),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}#
model_data <- parse_model_data("~/Library/CloudStorage/Dropbox/model_comparison_everything.csv")#
plot_data <- prepare_forest_plot_data(model_data)#
#
# Add this line to also generate the faceted plot#
faceted_plot <- create_faceted_forest_plot(plot_data)#
ggsave("multidisease_faceted_plot.pdf", faceted_plot, width = 12, height = 12, dpi = 300)
faceted_plot
# Alternative approach with facet_wrap for separate panels by disease#
create_faceted_forest_plot <- function(plot_data) {#
  # Limit to top 16 diseases by dynamic AUC#
  top_diseases <- plot_data %>%#
    filter(model == "Aladynoulli Dynamic") %>%#
    arrange(desc(Events)) %>%#
    head(16) %>%#
    pull(Disease)#
  plot_data_subset <- plot_data %>%#
    filter(Disease %in% top_diseases)#
#
  plot_data_subset$Disease <- factor(plot_data_subset$Disease, levels = top_diseases)#
  plot_data_subset=plot_data%>%#
    filter(Disease %in% c("ASCVD","Diabetes","All_Cancers","COPD","Atrial_Fib","Pneumonia","Secondary_Cancer","Osteoporosis",#
                          "Breast Cancer","CKD","Heart_Failure","Rheumatoid_Arthritis","Stroke"))#
  # Define colors for models, now including TD Cox#
  model_colors <- c(#
    "Time-dependent Cox with Noulli" = "#8E44AD",   # Purple#
    "Aladynoulli Dynamic" = "#4285F4",              # Blue#
    "Aladynoulli Static" = "#34A853",               # Green#
    "Cox with Noulli" = "#EA4335",                  # Red#
    "Cox without Noulli" = "#FBBC05"                # Yellow/Orange#
  )#
  # Create the faceted plot#
  p <- ggplot(plot_data_subset, aes(x = model, y = auc, color = model)) +#
    geom_point(size = 3) +#
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +#
    facet_wrap(~ Disease, scales = "free_y", ncol = 4) +#
    geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +#
    scale_color_manual(values = model_colors) +#
    scale_y_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Performance across top 16 diseases",#
      y = "AUC (95% CI)",#
      x = NULL#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),#
      strip.text = element_text(face = "bold"),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}
faceted_plot
# Alternative approach with facet_wrap for separate panels by disease#
create_faceted_forest_plot <- function(plot_data) {#
  # Limit to top 16 diseases by dynamic AUC#
  top_diseases <- plot_data %>%#
    filter(model == "Aladynoulli Dynamic") %>%#
    arrange(desc(Events)) %>%#
    head(16) %>%#
    pull(Disease)#
  plot_data_subset <- plot_data %>%#
    filter(Disease %in% top_diseases)#
#
  plot_data_subset$Disease <- factor(plot_data_subset$Disease, levels = top_diseases)#
  plot_data_subset=plot_data%>%#
    filter(Disease %in% c("ASCVD","Diabetes","All_Cancers","COPD","Atrial_Fib","Pneumonia","Secondary_Cancer","Osteoporosis",#
                          "Breast Cancer","CKD","Heart_Failure","Rheumatoid_Arthritis","Stroke"))#
  # Define colors for models, now including TD Cox#
  model_colors <- c(#
    "Time-dependent Cox with Noulli" = "#8E44AD",   # Purple#
    "Aladynoulli Dynamic" = "#4285F4",              # Blue#
    "Aladynoulli Static" = "#34A853",               # Green#
    "Cox with Noulli" = "#EA4335",                  # Red#
    "Cox without Noulli" = "#FBBC05"                # Yellow/Orange#
  )#
  # Create the faceted plot#
  p <- ggplot(plot_data_subset, aes(x = model, y = auc, color = model)) +#
    geom_point(size = 5) +#
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +#
    facet_wrap(~ Disease, scales = "free_y", ncol = 4) +#
    geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +#
    scale_color_manual(values = model_colors) +#
    scale_y_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Performance across top 16 diseases",#
      y = "AUC (95% CI)",#
      x = NULL#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),#
      strip.text = element_text(face = "bold"),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}#
model_data <- parse_model_data("~/Library/CloudStorage/Dropbox/model_comparison_everything.csv")#
plot_data <- prepare_forest_plot_data(model_data)#
#
# Add this line to also generate the faceted plot#
faceted_plot <- create_faceted_forest_plot(plot_data)#
ggsave("multidisease_faceted_plot.pdf", faceted_plot, width = 12, height = 12, dpi = 300)
faceted_plot
# Alternative approach with facet_wrap for separate panels by disease#
create_faceted_forest_plot <- function(plot_data) {#
  # Limit to top 16 diseases by dynamic AUC#
  top_diseases <- plot_data %>%#
    filter(model == "Aladynoulli Dynamic") %>%#
    arrange(desc(Events)) %>%#
    head(16) %>%#
    pull(Disease)#
  plot_data_subset <- plot_data %>%#
    filter(Disease %in% top_diseases)#
#
  plot_data_subset$Disease <- factor(plot_data_subset$Disease, levels = top_diseases)#
  plot_data_subset=plot_data%>%#
    filter(Disease %in% c("ASCVD","Diabetes","All_Cancers","COPD","Atrial_Fib","Pneumonia","Secondary_Cancer","Osteoporosis",#
                          "Breast Cancer","CKD","Heart_Failure","Rheumatoid_Arthritis","Stroke"))#
  # Define colors for models, now including TD Cox#
  model_colors <- c(#
    "Time-dependent Cox with Noulli" = "#8E44AD",   # Purple#
    "Aladynoulli Dynamic" = "#4285F4",              # Blue#
    "Aladynoulli Static" = "#34A853",               # Green#
    "Cox with Noulli" = "#EA4335",                  # Red#
    "Cox without Noulli" = "#FBBC05"                # Yellow/Orange#
  )#
  # Create the faceted plot#
  p <- ggplot(plot_data_subset, aes(x = model, y = auc, color = model)) +#
    geom_point(size = 5) +#
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +#
    facet_wrap(~ Disease, scales = "free_y", ncol = 4) +#
    geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +#
    scale_color_manual(values = model_colors) +#
    scale_y_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Performance across top 16 diseases",#
      y = "AUC (95% CI)",#
      x = NULL#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),#
      strip.text = element_text(face = "bold"),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}#
model_data <- parse_model_data("all_model_comp_withtdcox.csv")#
plot_data <- prepare_forest_plot_data(model_data)#
#
# Add this line to also generate the faceted plot#
faceted_plot <- create_faceted_forest_plot(plot_data)#
ggsave("multidisease_faceted_plot.pdf", faceted_plot, width = 12, height = 12, dpi = 300)
faceted_plot
faceted_plot
cet_wrap for separate panels by disease#
create_faceted_forest_plot <- function(plot_data) {#
  # Limit to top 16 diseases by dynamic AUC#
  top_diseases <- plot_data %>%#
    filter(model == "Aladynoulli Dynamic") %>%#
    arrange(desc(Events)) %>%#
    head(16) %>%#
    pull(Disease)#
  plot_data_subset <- plot_data %>%#
    filter(Disease %in% top_diseases)#
#
  plot_data_subset$Disease <- factor(plot_data_subset$Disease, levels = top_diseases)#
  plot_data_subset=plot_data%>%#
    filter(Disease %in% c("ASCVD","Diabetes","All_Cancers","COPD","Atrial_Fib","Pneumonia","Secondary_Cancer","Osteoporosis",#
                          "Breast Cancer","CKD","Heart_Failure","Rheumatoid_Arthritis","Stroke"))#
  # Define colors for models, now including TD Cox#
  model_colors <- c(#
    "Time-dependent Cox with Noulli" = "#8E44AD",   # Purple#
    "Aladynoulli Dynamic" = "#4285F4",              # Blue#
    "Aladynoulli Static" = "#34A853",               # Green#
    "Cox with Noulli" = "#EA4335",                  # Red#
    "Cox without Noulli" = "#FBBC05"                # Yellow/Orange#
  )#
  # Create the faceted plot#
  p <- ggplot(plot_data_subset, aes(x = model, y = auc, color = model)) +#
    geom_point(size = 2) +#
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +#
    facet_wrap(~ Disease, scales = "free_y", ncol = 4) +#
    geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +#
    scale_color_manual(values = model_colors) +#
    scale_y_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Performance across top 16 diseases",#
      y = "AUC (95% CI)",#
      x = NULL#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),#
      strip.text = element_text(face = "bold"),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}
faceted_plot
model_data <- parse_model_data("all_model_comp_withtdcox.csv")#
plot_data <- prepare_forest_plot_data(model_data)#
#
# Add this line to also generate the faceted plot#
faceted_plot <- create_faceted_forest_plot(plot_data)#
ggsave("multidisease_faceted_plot.pdf", faceted_plot, width = 12, height = 12, dpi = 300)
faceted_plot
faceted_plot
print(faceted_plot)
plot_data
unique(plot_data$Disease)
plot_data[plot_data$Disease%in%c("Lung_Cancer","Breast_Cancer")]
plot_data[plot_data$Disease%in%c("Lung_Cancer","Breast_Cancer"),]
plot_data[plot_data$Disease%in%c("Lung_Cancer","Breast_Cancer","Prostate_Cancer"),]
h with facet_wrap for separate panels by disease#
create_faceted_forest_plot <- function(plot_data) {#
  # Limit to top 16 diseases by dynamic AUC#
  top_diseases <- plot_data %>%#
    filter(model == "Aladynoulli Dynamic") %>%#
    arrange(desc(Events)) %>%#
    head(16) %>%#
    pull(Disease)#
  plot_data_subset <- plot_data %>%#
    filter(Disease %in% top_diseases)#
#
  plot_data_subset$Disease <- factor(plot_data_subset$Disease, levels = top_diseases)#
  plot_data_subset=plot_data%>%#
    filter(Disease %in% c("ASCVD","Diabetes","Breast_Cancer","COPD","Atrial_Fib","Pneumonia","Prostatate_Cancer","Osteoporosis",#
                          "Parkinsons","CKD","Heart_Failure","Rheumatoid_Arthritis","Stroke"))#
  # Define colors for models, now including TD Cox#
  model_colors <- c(#
    "Time-dependent Cox with Noulli" = "#8E44AD",   # Purple#
    "Aladynoulli Dynamic" = "#4285F4",              # Blue#
    "Aladynoulli Static" = "#34A853",               # Green#
    "Cox with Noulli" = "#EA4335",                  # Red#
    "Cox without Noulli" = "#FBBC05"                # Yellow/Orange#
  )#
  # Create the faceted plot#
  p <- ggplot(plot_data_subset, aes(x = model, y = auc, color = model)) +#
    geom_point(size = 2) +#
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +#
    facet_wrap(~ Disease, scales = "free_y", ncol = 4) +#
    geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +#
    scale_color_manual(values = model_colors) +#
    scale_y_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Performance across top 16 diseases",#
      y = "AUC (95% CI)",#
      x = NULL#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),#
      strip.text = element_text(face = "bold"),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}
model_data <- parse_model_data("all_model_comp_withtdcox.csv")#
plot_data <- prepare_forest_plot_data(model_data)#
#
# Add this line to also generate the faceted plot#
faceted_plot <- create_faceted_forest_plot(plot_data)#
ggsave("multidisease_faceted_plot.pdf", faceted_plot, width = 12, height = 12, dpi = 300)
faceted_plot
# Alternative approach with facet_wrap for separate panels by disease#
create_faceted_forest_plot <- function(plot_data) {#
  # Limit to top 16 diseases by dynamic AUC#
  top_diseases <- plot_data %>%#
    filter(model == "Aladynoulli Dynamic") %>%#
    arrange(desc(Events)) %>%#
    head(16) %>%#
    pull(Disease)#
  plot_data_subset <- plot_data %>%#
    filter(Disease %in% top_diseases)#
#
  plot_data_subset$Disease <- factor(plot_data_subset$Disease, levels = top_diseases)#
  plot_data_subset=plot_data%>%#
    filter(Disease %in% c("ASCVD","Diabetes","Breast_Cancer","COPD","Atrial_Fib","Prostatate_Cancer","Osteoporosis",#
                          "Parkinsons","CKD","Heart_Failure","Rheumatoid_Arthritis","Stroke"))#
  # Define colors for models, now including TD Cox#
  model_colors <- c(#
    "Time-dependent Cox with Noulli" = "#8E44AD",   # Purple#
    "Aladynoulli Dynamic" = "#4285F4",              # Blue#
    "Aladynoulli Static" = "#34A853",               # Green#
    "Cox with Noulli" = "#EA4335",                  # Red#
    "Cox without Noulli" = "#FBBC05"                # Yellow/Orange#
  )#
  # Create the faceted plot#
  p <- ggplot(plot_data_subset, aes(x = model, y = auc, color = model)) +#
    geom_point(size = 2) +#
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +#
    facet_wrap(~ Disease, scales = "free_y", ncol = 4) +#
    geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +#
    scale_color_manual(values = model_colors) +#
    scale_y_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Performance across top 16 diseases",#
      y = "AUC (95% CI)",#
      x = NULL#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),#
      strip.text = element_text(face = "bold"),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}
model_data <- parse_model_data("all_model_comp_withtdcox.csv")#
plot_data <- prepare_forest_plot_data(model_data)#
#
# Add this line to also generate the faceted plot#
faceted_plot <- create_faceted_forest_plot(plot_data)#
ggsave("multidisease_faceted_plot.pdf", faceted_plot, width = 12, height = 12, dpi = 300)
faceted_plot
# Alternative approach with facet_wrap for separate panels by disease#
create_faceted_forest_plot <- function(plot_data) {#
  # Limit to top 16 diseases by dynamic AUC#
  top_diseases <- plot_data %>%#
    filter(model == "Aladynoulli Dynamic") %>%#
    arrange(desc(Events)) %>%#
    head(16) %>%#
    pull(Disease)#
  plot_data_subset <- plot_data %>%#
    filter(Disease %in% top_diseases)#
#
  plot_data_subset$Disease <- factor(plot_data_subset$Disease, levels = top_diseases)#
  plot_data_subset=plot_data%>%#
    filter(Disease %in% c("ASCVD","Diabetes","Breast_Cancer","COPD","Atrial_Fib","Prostate_Cancer","Osteoporosis",#
                          "Parkinsons","CKD","Heart_Failure","Rheumatoid_Arthritis","Stroke"))#
  # Define colors for models, now including TD Cox#
  model_colors <- c(#
    "Time-dependent Cox with Noulli" = "#8E44AD",   # Purple#
    "Aladynoulli Dynamic" = "#4285F4",              # Blue#
    "Aladynoulli Static" = "#34A853",               # Green#
    "Cox with Noulli" = "#EA4335",                  # Red#
    "Cox without Noulli" = "#FBBC05"                # Yellow/Orange#
  )#
  # Create the faceted plot#
  p <- ggplot(plot_data_subset, aes(x = model, y = auc, color = model)) +#
    geom_point(size = 2) +#
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +#
    facet_wrap(~ Disease, scales = "free_y", ncol = 4) +#
    geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +#
    scale_color_manual(values = model_colors) +#
    scale_y_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Performance across top 16 diseases",#
      y = "AUC (95% CI)",#
      x = NULL#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),#
      strip.text = element_text(face = "bold"),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}
model_data <- parse_model_data("all_model_comp_withtdcox.csv")#
plot_data <- prepare_forest_plot_data(model_data)#
#
# Add this line to also generate the faceted plot#
faceted_plot <- create_faceted_forest_plot(plot_data)#
ggsave("multidisease_faceted_plot.pdf", faceted_plot, width = 12, height = 12, dpi = 300)
model_data <- parse_model_data("all_model_comp_withtdcox.csv")#
plot_data <- prepare_forest_plot_data(model_data)#
#
# Add this line to also generate the faceted plot#
faceted_plot <- create_faceted_forest_plot(plot_data)#
ggsave("multidisease_faceted_plot.pdf", faceted_plot, width = 12, height = 12, dpi = 300)
faceted_plot
# Alternative approach with facet_wrap for separate panels by disease#
create_faceted_forest_plot <- function(plot_data) {#
  # Limit to top 16 diseases by dynamic AUC#
  top_diseases <- plot_data %>%#
    filter(model == "Aladynoulli Dynamic") %>%#
    arrange(desc(Events)) %>%#
    head(16) %>%#
    pull(Disease)#
  plot_data_subset <- plot_data %>%#
    filter(Disease %in% top_diseases)#
#
  plot_data_subset$Disease <- factor(plot_data_subset$Disease, levels = top_diseases)#
  plot_data_subset=plot_data%>%#
    filter(Disease %in% c("ASCVD","Diabetes","Breast_Cancer","COPD","Atrial_Fib","Prostate_Cancer","Osteoporosis",#
                          "Parkinsons","CKD","Heart_Failure","Rheumatoid_Arthritis","Colorectal_Cancer",""))#
  # Define colors for models, now including TD Cox#
  model_colors <- c(#
    "Time-dependent Cox with Noulli" = "#8E44AD",   # Purple#
    "Aladynoulli Dynamic" = "#4285F4",              # Blue#
    "Aladynoulli Static" = "#34A853",               # Green#
    "Cox with Noulli" = "#EA4335",                  # Red#
    "Cox without Noulli" = "#FBBC05"                # Yellow/Orange#
  )#
  # Create the faceted plot#
  p <- ggplot(plot_data_subset, aes(x = model, y = auc, color = model)) +#
    geom_point(size = 2) +#
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +#
    facet_wrap(~ Disease, scales = "free_y", ncol = 4) +#
    geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +#
    scale_color_manual(values = model_colors) +#
    scale_y_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Performance across top 16 diseases",#
      y = "AUC (95% CI)",#
      x = NULL#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),#
      strip.text = element_text(face = "bold"),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}
model_data <- parse_model_data("all_model_comp_withtdcox.csv")#
plot_data <- prepare_forest_plot_data(model_data)#
#
# Add this line to also generate the faceted plot#
faceted_plot <- create_faceted_forest_plot(plot_data)#
ggsave("multidisease_faceted_plot.pdf", faceted_plot, width = 12, height = 12, dpi = 300)
library(ggplot2)#
library(dplyr)#
library(tidyr)#
library(stringr)#
library(forcats)#
#
# Function to parse the data#
parse_model_data <- function(data_path) {#
  # Read the data#
  df <- read.csv(data_path)#
  # Extract confidence intervals from the formatted strings#
  extract_ci <- function(ci_str) {#
    # Matches format like "0.765 (0.748-0.782)"#
    pattern <- "(\\d+\\.\\d+)\\s*\\((\\d+\\.\\d+)-(\\d+\\.\\d+)\\)"#
    matches <- regexec(pattern, ci_str)#
    result <- regmatches(ci_str, matches)#
    if(length(result) > 0 && length(result[[1]]) >= 4) {#
      return(c(as.numeric(result[[1]][2]), #
               as.numeric(result[[1]][3]),#
               as.numeric(result[[1]][4])))#
    } else {#
      return(c(NA, NA, NA))#
    }#
  }#
  # Create a clean data frame#
  model_data <- data.frame(#
    Disease = df$Disease,#
    Events = df$Events,#
    Rate = df$Rate,#
    stringsAsFactors = FALSE#
  )#
  # Extract values for Aladynoulli Dynamic#
  dynamic_ci <- lapply(df$aladynoulli_auc_dynamic, extract_ci)#
  model_data$dynamic_auc <- sapply(dynamic_ci, function(x) x[1])#
  model_data$dynamic_lower <- sapply(dynamic_ci, function(x) x[2])#
  model_data$dynamic_upper <- sapply(dynamic_ci, function(x) x[3])#
  # Extract values for Aladynoulli Static#
  static_ci <- lapply(df$aladynoulli_auc_static, extract_ci)#
  model_data$static_auc <- sapply(static_ci, function(x) x[1])#
  model_data$static_lower <- sapply(static_ci, function(x) x[2])#
  model_data$static_upper <- sapply(static_ci, function(x) x[3])#
  # Add Cox values#
  model_data$cox_without_noulli <- df$cox_auc_without_noulli#
  model_data$cox_with_noulli <- df$cox_auc_with_noulli#
#
  # Add TD Cox AUC (as numeric)#
  model_data$td_cox_auc <- as.numeric(df$td_cox)#
  # Calculate CI for Cox values (using the formula SE = sqrt((AUC * (1-AUC)) / (n * prevalence)))#
  calc_cox_ci <- function(auc, events, total = 400000) {#
    prevalence <- events / total#
    prevalence <- max(0.01, prevalence)#
    se <- sqrt((auc * (1 - auc)) / (total * prevalence))#
    lower <- max(0, auc - 1.96 * se)#
    upper <- min(1, auc + 1.96 * se)#
    return(c(lower, upper))#
  }#
  # Add CI for Cox without Noulli#
  cox_without_ci <- mapply(calc_cox_ci, #
                           model_data$cox_without_noulli, #
                           model_data$Events, #
                           SIMPLIFY = FALSE)#
  model_data$cox_without_lower <- sapply(cox_without_ci, function(x) x[1])#
  model_data$cox_without_upper <- sapply(cox_without_ci, function(x) x[2])#
  # Add CI for Cox with Noulli#
  cox_with_ci <- mapply(calc_cox_ci, #
                        model_data$cox_with_noulli, #
                        model_data$Events, #
                        SIMPLIFY = FALSE)#
  model_data$cox_with_lower <- sapply(cox_with_ci, function(x) x[1])#
  model_data$cox_with_upper <- sapply(cox_with_ci, function(x) x[2])#
#
  # Add CI for TD Cox#
  td_cox_ci <- mapply(calc_cox_ci, #
                      model_data$td_cox_auc, #
                      model_data$Events, #
                      SIMPLIFY = FALSE)#
  model_data$td_cox_lower <- sapply(td_cox_ci, function(x) x[1])#
  model_data$td_cox_upper <- sapply(td_cox_ci, function(x) x[2])#
  # Calculate CI for Aladynoulli Dynamic using actual sample size (e.g., 400,000)#
  aladyn_dynamic_ci <- mapply(calc_cox_ci, #
                            model_data$dynamic_auc, #
                            model_data$Events, #
                            MoreArgs = list(total = 400000), #
                            SIMPLIFY = FALSE)#
  model_data$dynamic_lower <- sapply(aladyn_dynamic_ci, function(x) x[1])#
  model_data$dynamic_upper <- sapply(aladyn_dynamic_ci, function(x) x[2])#
#
  # Calculate CI for Aladynoulli Static using actual sample size (e.g., 400,000)#
  aladyn_static_ci <- mapply(calc_cox_ci, #
                           model_data$static_auc, #
                           model_data$Events, #
                           MoreArgs = list(total = 400000), #
                           SIMPLIFY = FALSE)#
  model_data$static_lower <- sapply(aladyn_static_ci, function(x) x[1])#
  model_data$static_upper <- sapply(aladyn_static_ci, function(x) x[2])#
  return(model_data)#
}
model_data <- parse_model_data("all_model_comp_withtdcox.csv")#
plot_data <- prepare_forest_plot_data(model_data)#
#
# Add this line to also generate the faceted plot#
faceted_plot <- create_faceted_forest_plot(plot_data)#
ggsave("multidisease_faceted_plot.pdf", faceted_plot, width = 12, height = 12, dpi = 300)
library(ggplot2)#
library(dplyr)#
library(tidyr)#
library(stringr)#
library(forcats)#
#
# Function to parse the data#
parse_model_data <- function(data_path) {#
  # Read the data#
  df <- read.csv(data_path)#
  # Extract confidence intervals from the formatted strings#
  extract_ci <- function(ci_str) {#
    # Matches format like "0.765 (0.748-0.782)"#
    pattern <- "(\\d+\\.\\d+)\\s*\\((\\d+\\.\\d+)-(\\d+\\.\\d+)\\)"#
    matches <- regexec(pattern, ci_str)#
    result <- regmatches(ci_str, matches)#
    if(length(result) > 0 && length(result[[1]]) >= 4) {#
      return(c(as.numeric(result[[1]][2]), #
               as.numeric(result[[1]][3]),#
               as.numeric(result[[1]][4])))#
    } else {#
      return(c(NA, NA, NA))#
    }#
  }#
  # Create a clean data frame#
  model_data <- data.frame(#
    Disease = df$Disease,#
    Events = df$Events,#
    Rate = df$Rate,#
    stringsAsFactors = FALSE#
  )#
  # Extract values for Aladynoulli Dynamic#
  dynamic_ci <- lapply(df$aladynoulli_auc_dynamic, extract_ci)#
  model_data$dynamic_auc <- sapply(dynamic_ci, function(x) x[1])#
  model_data$dynamic_lower <- sapply(dynamic_ci, function(x) x[2])#
  model_data$dynamic_upper <- sapply(dynamic_ci, function(x) x[3])#
  # Extract values for Aladynoulli Static#
  static_ci <- lapply(df$aladynoulli_auc_static, extract_ci)#
  model_data$static_auc <- sapply(static_ci, function(x) x[1])#
  model_data$static_lower <- sapply(static_ci, function(x) x[2])#
  model_data$static_upper <- sapply(static_ci, function(x) x[3])#
  # Add Cox values#
  model_data$cox_without_noulli <- df$cox_auc_without_noulli#
  model_data$cox_with_noulli <- df$cox_auc_with_noulli#
#
  # Add TD Cox AUC (as numeric)#
  model_data$td_cox_auc <- as.numeric(df$td_cox)#
  # Calculate CI for Cox values (using the formula SE = sqrt((AUC * (1-AUC)) / (n * prevalence)))#
  calc_cox_ci <- function(auc, events, total = 400000) {#
    prevalence <- events / total#
    prevalence <- max(0.01, prevalence)#
    se <- sqrt((auc * (1 - auc)) / (total * prevalence))#
    lower <- max(0, auc - 1.96 * se)#
    upper <- min(1, auc + 1.96 * se)#
    return(c(lower, upper))#
  }#
  # Add CI for Cox without Noulli#
  cox_without_ci <- mapply(calc_cox_ci, #
                           model_data$cox_without_noulli, #
                           model_data$Events, #
                           SIMPLIFY = FALSE)#
  model_data$cox_without_lower <- sapply(cox_without_ci, function(x) x[1])#
  model_data$cox_without_upper <- sapply(cox_without_ci, function(x) x[2])#
  # Add CI for Cox with Noulli#
  cox_with_ci <- mapply(calc_cox_ci, #
                        model_data$cox_with_noulli, #
                        model_data$Events, #
                        SIMPLIFY = FALSE)#
  model_data$cox_with_lower <- sapply(cox_with_ci, function(x) x[1])#
  model_data$cox_with_upper <- sapply(cox_with_ci, function(x) x[2])#
#
  # Add CI for TD Cox#
  td_cox_ci <- mapply(calc_cox_ci, #
                      model_data$td_cox_auc, #
                      model_data$Events, #
                      SIMPLIFY = FALSE)#
  model_data$td_cox_lower <- sapply(td_cox_ci, function(x) x[1])#
  model_data$td_cox_upper <- sapply(td_cox_ci, function(x) x[2])#
  # Calculate CI for Aladynoulli Dynamic using actual sample size (e.g., 400,000)#
  aladyn_dynamic_ci <- mapply(calc_cox_ci, #
                            model_data$dynamic_auc, #
                            model_data$Events, #
                            MoreArgs = list(total = 400000), #
                            SIMPLIFY = FALSE)#
  model_data$dynamic_lower <- sapply(aladyn_dynamic_ci, function(x) x[1])#
  model_data$dynamic_upper <- sapply(aladyn_dynamic_ci, function(x) x[2])#
#
  # Calculate CI for Aladynoulli Static using actual sample size (e.g., 400,000)#
  aladyn_static_ci <- mapply(calc_cox_ci, #
                           model_data$static_auc, #
                           model_data$Events, #
                           MoreArgs = list(total = 400000), #
                           SIMPLIFY = FALSE)#
  model_data$static_lower <- sapply(aladyn_static_ci, function(x) x[1])#
  model_data$static_upper <- sapply(aladyn_static_ci, function(x) x[2])#
  return(model_data)#
}
library(ggplot2)#
library(dplyr)#
library(tidyr)#
library(stringr)#
library(forcats)#
#
# Function to parse the data#
parse_model_data <- function(data_path) {#
  # Read the data#
  df <- read.csv(data_path)#
  # Extract confidence intervals from the formatted strings#
  extract_ci <- function(ci_str) {#
    # Matches format like "0.765 (0.748-0.782)"#
    pattern <- "(\\d+\\.\\d+)\\s*\\((\\d+\\.\\d+)-(\\d+\\.\\d+)\\)"#
    matches <- regexec(pattern, ci_str)#
    result <- regmatches(ci_str, matches)#
    if(length(result) > 0 && length(result[[1]]) >= 4) {#
      return(c(as.numeric(result[[1]][2]), #
               as.numeric(result[[1]][3]),#
               as.numeric(result[[1]][4])))#
    } else {#
      return(c(NA, NA, NA))#
    }#
  }#
  # Create a clean data frame#
  model_data <- data.frame(#
    Disease = df$Disease,#
    Events = df$Events,#
    Rate = df$Rate,#
    stringsAsFactors = FALSE#
  )#
  # Extract values for Aladynoulli Dynamic#
  dynamic_ci <- lapply(df$aladynoulli_auc_dynamic, extract_ci)#
  model_data$dynamic_auc <- sapply(dynamic_ci, function(x) x[1])#
  model_data$dynamic_lower <- sapply(dynamic_ci, function(x) x[2])#
  model_data$dynamic_upper <- sapply(dynamic_ci, function(x) x[3])#
  # Extract values for Aladynoulli Static#
  static_ci <- lapply(df$aladynoulli_auc_static, extract_ci)#
  model_data$static_auc <- sapply(static_ci, function(x) x[1])#
  model_data$static_lower <- sapply(static_ci, function(x) x[2])#
  model_data$static_upper <- sapply(static_ci, function(x) x[3])#
  # Add Cox values#
  model_data$cox_without_noulli <- df$cox_auc_without_noulli#
  model_data$cox_with_noulli <- df$cox_auc_with_noulli#
#
  # Add TD Cox AUC (as numeric)#
  model_data$td_cox_auc <- as.numeric(df$td_cox)#
  # Calculate CI for Cox values (using the formula SE = sqrt((AUC * (1-AUC)) / (n * prevalence)))#
  calc_cox_ci <- function(auc, events, total = 400000) {#
    prevalence <- events / total#
    prevalence <- max(0.01, prevalence)#
    se <- sqrt((auc * (1 - auc)) / (total * prevalence))#
    lower <- max(0, auc - 1.96 * se)#
    upper <- min(1, auc + 1.96 * se)#
    return(c(lower, upper))#
  }#
  # Add CI for Cox without Noulli#
  cox_without_ci <- mapply(calc_cox_ci, #
                           model_data$cox_without_noulli, #
                           model_data$Events, #
                           SIMPLIFY = FALSE)#
  model_data$cox_without_lower <- sapply(cox_without_ci, function(x) x[1])#
  model_data$cox_without_upper <- sapply(cox_without_ci, function(x) x[2])#
  # Add CI for Cox with Noulli#
  cox_with_ci <- mapply(calc_cox_ci, #
                        model_data$cox_with_noulli, #
                        model_data$Events, #
                        SIMPLIFY = FALSE)#
  model_data$cox_with_lower <- sapply(cox_with_ci, function(x) x[1])#
  model_data$cox_with_upper <- sapply(cox_with_ci, function(x) x[2])#
#
  # Add CI for TD Cox#
  td_cox_ci <- mapply(calc_cox_ci, #
                      model_data$td_cox_auc, #
                      model_data$Events, #
                      SIMPLIFY = FALSE)#
  model_data$td_cox_lower <- sapply(td_cox_ci, function(x) x[1])#
  model_data$td_cox_upper <- sapply(td_cox_ci, function(x) x[2])#
  # Calculate CI for Aladynoulli Dynamic using actual sample size (e.g., 400,000)#
  aladyn_dynamic_ci <- mapply(calc_cox_ci, #
                            model_data$dynamic_auc, #
                            model_data$Events, #
                            MoreArgs = list(total = 400000), #
                            SIMPLIFY = FALSE)#
  model_data$dynamic_lower <- sapply(aladyn_dynamic_ci, function(x) x[1])#
  model_data$dynamic_upper <- sapply(aladyn_dynamic_ci, function(x) x[2])#
#
  # Calculate CI for Aladynoulli Static using actual sample size (e.g., 400,000)#
  aladyn_static_ci <- mapply(calc_cox_ci, #
                           model_data$static_auc, #
                           model_data$Events, #
                           MoreArgs = list(total = 400000), #
                           SIMPLIFY = FALSE)#
  model_data$static_lower <- sapply(aladyn_static_ci, function(x) x[1])#
  model_data$static_upper <- sapply(aladyn_static_ci, function(x) x[2])#
  return(model_data)#
}
prepare_forest_plot_data
prepare_forest_plot_data
create_faceted_forest_plot
function(plot_data) {#
  # Limit to top 16 diseases by dynamic AUC#
  top_diseases <- plot_data %>%#
    filter(model == "Aladynoulli Dynamic") %>%#
    arrange(desc(Events)) %>%#
    head(16) %>%#
    pull(Disease)#
  plot_data_subset <- plot_data %>%#
    filter(Disease %in% top_diseases)#
#
  plot_data_subset$Disease <- factor(plot_data_subset$Disease, levels = top_diseases)#
  plot_data_subset=plot_data%>%#
    filter(Disease %in% c("ASCVD","Diabetes","Breast_Cancer","COPD","Atrial_Fib","Prostate_Cancer","Osteoporosis",#
                          "Parkinsons","CKD","Heart_Failure","Rheumatoid_Arthritis","Colorectal_Cancer"))#
  # Define colors for models, now including TD Cox#
  model_colors <- c(#
    "Time-dependent Cox with Noulli" = "#8E44AD",   # Purple#
    "Aladynoulli Dynamic" = "#4285F4",              # Blue#
    "Aladynoulli Static" = "#34A853",               # Green#
    "Cox with Noulli" = "#EA4335",                  # Red#
    "Cox without Noulli" = "#FBBC05"                # Yellow/Orange#
  )#
  # Create the faceted plot#
  p <- ggplot(plot_data_subset, aes(x = model, y = auc, color = model)) +#
    geom_point(size = 2) +#
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +#
    facet_wrap(~ Disease, scales = "free_y", ncol = 4) +#
    geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +#
    scale_color_manual(values = model_colors) +#
    scale_y_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Performance across top 16 diseases",#
      y = "AUC (95% CI)",#
      x = NULL#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),#
      strip.text = element_text(face = "bold"),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}
model_data <- parse_model_data("all_model_comp_withtdcox.csv")#
plot_data <- prepare_forest_plot_data(model_data)#
#
# Add this line to also generate the faceted plot#
faceted_plot <- create_faceted_forest_plot(plot_data)#
ggsave("multidisease_faceted_plot.pdf", faceted_plot, width = 12, height = 12, dpi = 300)
# Load required libraries#
library(ggplot2)#
library(dplyr)#
library(tidyr)#
library(stringr)#
library(forcats)#
#
# Function to parse the data#
parse_model_data <- function(data_path) {#
  # Read the data#
  df <- read.csv(data_path)#
  # Extract confidence intervals from the formatted strings#
  extract_ci <- function(ci_str) {#
    # Matches format like "0.765 (0.748-0.782)"#
    pattern <- "(\\d+\\.\\d+)\\s*\\((\\d+\\.\\d+)-(\\d+\\.\\d+)\\)"#
    matches <- regexec(pattern, ci_str)#
    result <- regmatches(ci_str, matches)#
    if(length(result) > 0 && length(result[[1]]) >= 4) {#
      return(c(as.numeric(result[[1]][2]), #
               as.numeric(result[[1]][3]),#
               as.numeric(result[[1]][4])))#
    } else {#
      return(c(NA, NA, NA))#
    }#
  }#
  # Create a clean data frame#
  model_data <- data.frame(#
    Disease = df$Disease,#
    Events = df$Events,#
    Rate = df$Rate,#
    stringsAsFactors = FALSE#
  )#
  # Extract values for Aladynoulli Dynamic#
  dynamic_ci <- lapply(df$aladynoulli_auc_dynamic, extract_ci)#
  model_data$dynamic_auc <- sapply(dynamic_ci, function(x) x[1])#
  model_data$dynamic_lower <- sapply(dynamic_ci, function(x) x[2])#
  model_data$dynamic_upper <- sapply(dynamic_ci, function(x) x[3])#
  # Extract values for Aladynoulli Static#
  static_ci <- lapply(df$aladynoulli_auc_static, extract_ci)#
  model_data$static_auc <- sapply(static_ci, function(x) x[1])#
  model_data$static_lower <- sapply(static_ci, function(x) x[2])#
  model_data$static_upper <- sapply(static_ci, function(x) x[3])#
  # Add Cox values#
  model_data$cox_without_noulli <- df$cox_auc_without_noulli#
  model_data$cox_with_noulli <- df$cox_auc_with_noulli#
#
  # Add TD Cox AUC (as numeric)#
  model_data$td_cox_auc <- as.numeric(df$td_cox)#
  # Calculate CI for Cox values (using the formula SE = sqrt((AUC * (1-AUC)) / (n * prevalence)))#
  calc_cox_ci <- function(auc, events, total = 400000) {#
    prevalence <- events / total#
    prevalence <- max(0.01, prevalence)#
    se <- sqrt((auc * (1 - auc)) / (total * prevalence))#
    lower <- max(0, auc - 1.96 * se)#
    upper <- min(1, auc + 1.96 * se)#
    return(c(lower, upper))#
  }#
  # Add CI for Cox without Noulli#
  cox_without_ci <- mapply(calc_cox_ci, #
                           model_data$cox_without_noulli, #
                           model_data$Events, #
                           SIMPLIFY = FALSE)#
  model_data$cox_without_lower <- sapply(cox_without_ci, function(x) x[1])#
  model_data$cox_without_upper <- sapply(cox_without_ci, function(x) x[2])#
  # Add CI for Cox with Noulli#
  cox_with_ci <- mapply(calc_cox_ci, #
                        model_data$cox_with_noulli, #
                        model_data$Events, #
                        SIMPLIFY = FALSE)#
  model_data$cox_with_lower <- sapply(cox_with_ci, function(x) x[1])#
  model_data$cox_with_upper <- sapply(cox_with_ci, function(x) x[2])#
#
  # Add CI for TD Cox#
  td_cox_ci <- mapply(calc_cox_ci, #
                      model_data$td_cox_auc, #
                      model_data$Events, #
                      SIMPLIFY = FALSE)#
  model_data$td_cox_lower <- sapply(td_cox_ci, function(x) x[1])#
  model_data$td_cox_upper <- sapply(td_cox_ci, function(x) x[2])#
  # Calculate CI for Aladynoulli Dynamic using actual sample size (e.g., 400,000)#
  aladyn_dynamic_ci <- mapply(calc_cox_ci, #
                            model_data$dynamic_auc, #
                            model_data$Events, #
                            MoreArgs = list(total = 400000), #
                            SIMPLIFY = FALSE)#
  model_data$dynamic_lower <- sapply(aladyn_dynamic_ci, function(x) x[1])#
  model_data$dynamic_upper <- sapply(aladyn_dynamic_ci, function(x) x[2])#
#
  # Calculate CI for Aladynoulli Static using actual sample size (e.g., 400,000)#
  aladyn_static_ci <- mapply(calc_cox_ci, #
                           model_data$static_auc, #
                           model_data$Events, #
                           MoreArgs = list(total = 400000), #
                           SIMPLIFY = FALSE)#
  model_data$static_lower <- sapply(aladyn_static_ci, function(x) x[1])#
  model_data$static_upper <- sapply(aladyn_static_ci, function(x) x[2])#
  # Extract values for Aladynoulli 1-year#
  one_year_ci <- lapply(df$Dynamic1year, extract_ci)#
  model_data$one_year_auc <- sapply(one_year_ci, function(x) x[1])#
  model_data$one_year_lower <- sapply(one_year_ci, function(x) x[2])#
  model_data$one_year_upper <- sapply(one_year_ci, function(x) x[3])#
  # After extracting one_year_auc, one_year_lower, one_year_upper, add CI calculation for 1-year AUC using total=400000#
  one_year_ci_calc <- mapply(calc_cox_ci, #
                          model_data$one_year_auc, #
                          model_data$Events, #
                          MoreArgs = list(total = 400000), #
                          SIMPLIFY = FALSE)#
  model_data$one_year_lower <- sapply(one_year_ci_calc, function(x) x[1])#
  model_data$one_year_upper <- sapply(one_year_ci_calc, function(x) x[2])#
  return(model_data)#
}
# Load required libraries#
library(ggplot2)#
library(dplyr)#
library(tidyr)#
library(stringr)#
library(forcats)#
#
# Function to parse the data#
parse_model_data <- function(data_path) {#
  # Read the data#
  df <- read.csv(data_path)#
  # Extract confidence intervals from the formatted strings#
  extract_ci <- function(ci_str) {#
    # Matches format like "0.765 (0.748-0.782)"#
    pattern <- "(\\d+\\.\\d+)\\s*\\((\\d+\\.\\d+)-(\\d+\\.\\d+)\\)"#
    matches <- regexec(pattern, ci_str)#
    result <- regmatches(ci_str, matches)#
    if(length(result) > 0 && length(result[[1]]) >= 4) {#
      return(c(as.numeric(result[[1]][2]), #
               as.numeric(result[[1]][3]),#
               as.numeric(result[[1]][4])))#
    } else {#
      return(c(NA, NA, NA))#
    }#
  }#
  # Create a clean data frame#
  model_data <- data.frame(#
    Disease = df$Disease,#
    Events = df$Events,#
    Rate = df$Rate,#
    stringsAsFactors = FALSE#
  )#
  # Extract values for Aladynoulli Dynamic#
  dynamic_ci <- lapply(df$aladynoulli_auc_dynamic, extract_ci)#
  model_data$dynamic_auc <- sapply(dynamic_ci, function(x) x[1])#
  model_data$dynamic_lower <- sapply(dynamic_ci, function(x) x[2])#
  model_data$dynamic_upper <- sapply(dynamic_ci, function(x) x[3])#
  # Extract values for Aladynoulli Static#
  static_ci <- lapply(df$aladynoulli_auc_static, extract_ci)#
  model_data$static_auc <- sapply(static_ci, function(x) x[1])#
  model_data$static_lower <- sapply(static_ci, function(x) x[2])#
  model_data$static_upper <- sapply(static_ci, function(x) x[3])#
  # Add Cox values#
  model_data$cox_without_noulli <- df$cox_auc_without_noulli#
  model_data$cox_with_noulli <- df$cox_auc_with_noulli#
#
  # Add TD Cox AUC (as numeric)#
  model_data$td_cox_auc <- as.numeric(df$td_cox)#
  # Calculate CI for Cox values (using the formula SE = sqrt((AUC * (1-AUC)) / (n * prevalence)))#
  calc_cox_ci <- function(auc, events, total = 400000) {#
    prevalence <- events / total#
    prevalence <- max(0.01, prevalence)#
    se <- sqrt((auc * (1 - auc)) / (total * prevalence))#
    lower <- max(0, auc - 1.96 * se)#
    upper <- min(1, auc + 1.96 * se)#
    return(c(lower, upper))#
  }#
  # Add CI for Cox without Noulli#
  cox_without_ci <- mapply(calc_cox_ci, #
                           model_data$cox_without_noulli, #
                           model_data$Events, #
                           SIMPLIFY = FALSE)#
  model_data$cox_without_lower <- sapply(cox_without_ci, function(x) x[1])#
  model_data$cox_without_upper <- sapply(cox_without_ci, function(x) x[2])#
  # Add CI for Cox with Noulli#
  cox_with_ci <- mapply(calc_cox_ci, #
                        model_data$cox_with_noulli, #
                        model_data$Events, #
                        SIMPLIFY = FALSE)#
  model_data$cox_with_lower <- sapply(cox_with_ci, function(x) x[1])#
  model_data$cox_with_upper <- sapply(cox_with_ci, function(x) x[2])#
#
  # Add CI for TD Cox#
  td_cox_ci <- mapply(calc_cox_ci, #
                      model_data$td_cox_auc, #
                      model_data$Events, #
                      SIMPLIFY = FALSE)#
  model_data$td_cox_lower <- sapply(td_cox_ci, function(x) x[1])#
  model_data$td_cox_upper <- sapply(td_cox_ci, function(x) x[2])#
  # Calculate CI for Aladynoulli Dynamic using actual sample size (e.g., 400,000)#
  aladyn_dynamic_ci <- mapply(calc_cox_ci, #
                            model_data$dynamic_auc, #
                            model_data$Events, #
                            MoreArgs = list(total = 400000), #
                            SIMPLIFY = FALSE)#
  model_data$dynamic_lower <- sapply(aladyn_dynamic_ci, function(x) x[1])#
  model_data$dynamic_upper <- sapply(aladyn_dynamic_ci, function(x) x[2])#
#
  # Calculate CI for Aladynoulli Static using actual sample size (e.g., 400,000)#
  aladyn_static_ci <- mapply(calc_cox_ci, #
                           model_data$static_auc, #
                           model_data$Events, #
                           MoreArgs = list(total = 400000), #
                           SIMPLIFY = FALSE)#
  model_data$static_lower <- sapply(aladyn_static_ci, function(x) x[1])#
  model_data$static_upper <- sapply(aladyn_static_ci, function(x) x[2])#
  # Extract values for Aladynoulli 1-year#
  one_year_ci <- lapply(df$Dynamic1year, extract_ci)#
  model_data$one_year_auc <- sapply(one_year_ci, function(x) x[1])#
  model_data$one_year_lower <- sapply(one_year_ci, function(x) x[2])#
  model_data$one_year_upper <- sapply(one_year_ci, function(x) x[3])#
  # After extracting one_year_auc, one_year_lower, one_year_upper, add CI calculation for 1-year AUC using total=400000#
  one_year_ci_calc <- mapply(calc_cox_ci, #
                          model_data$one_year_auc, #
                          model_data$Events, #
                          MoreArgs = list(total = 400000), #
                          SIMPLIFY = FALSE)#
  model_data$one_year_lower <- sapply(one_year_ci_calc, function(x) x[1])#
  model_data$one_year_upper <- sapply(one_year_ci_calc, function(x) x[2])#
  return(model_data)#
}#
#
# Reshape data for plotting#
prepare_forest_plot_data <- function(model_data) {#
  # Transform to long format, now including TD Cox#
  long_data <- model_data %>%#
    pivot_longer(#
      cols = c("one_year_auc", "td_cox_auc", "dynamic_auc", "static_auc", "cox_with_noulli", "cox_without_noulli"),#
      names_to = "model",#
      values_to = "auc"#
    ) %>%#
    mutate(#
      lower = case_when(#
        model == "one_year_auc" ~ one_year_lower,#
        model == "td_cox_auc" ~ td_cox_lower,#
        model == "dynamic_auc" ~ dynamic_lower,#
        model == "static_auc" ~ static_lower,#
        model == "cox_with_noulli" ~ cox_with_lower,#
        model == "cox_without_noulli" ~ cox_without_lower#
      ),#
      upper = case_when(#
        model == "one_year_auc" ~ one_year_upper,#
        model == "td_cox_auc" ~ td_cox_upper,#
        model == "dynamic_auc" ~ dynamic_upper,#
        model == "static_auc" ~ static_upper,#
        model == "cox_with_noulli" ~ cox_with_upper,#
        model == "cox_without_noulli" ~ cox_without_upper#
      ),#
      model = case_when(#
        model == "one_year_auc" ~ "Aladynoulli 1-year",#
        model == "td_cox_auc" ~ "Time-dependent Cox with Noulli",#
        model == "dynamic_auc" ~ "Aladynoulli Dynamic",#
        model == "static_auc" ~ "Aladynoulli Static",#
        model == "cox_with_noulli" ~ "Cox with Noulli",#
        model == "cox_without_noulli" ~ "Cox without Noulli"#
      )#
    ) %>%#
    select(Disease, Events, Rate, model, auc, lower, upper)#
  # Set the model order with 'Aladynoulli 1-year' as the far left#
  long_data$model <- factor(long_data$model, levels = c(#
    "Aladynoulli 1-year",#
    "Time-dependent Cox with Noulli",#
    "Aladynoulli Dynamic",#
    "Aladynoulli Static",#
    "Cox with Noulli",#
    "Cox without Noulli"#
  ))#
  # Make Disease a factor ordered by dynamic AUC#
  disease_order <- model_data %>%#
    arrange(desc(dynamic_auc)) %>%#
    pull(Disease)#
  long_data$Disease <- factor(long_data$Disease, levels = disease_order)#
  return(long_data)#
}#
#
# Create the forest plot#
create_forest_plot <- function(plot_data) {#
  # Define colors for models#
  model_colors <- c(#
    "Aladynoulli 1-year" = "#222222", # Black or dark gray#
    "Time-dependent Cox with Noulli" = "#8E44AD",   # Purple#
    "Aladynoulli Dynamic" = "#4285F4",              # Blue#
    "Aladynoulli Static" = "#34A853",               # Green#
    "Cox with Noulli" = "#EA4335",                  # Red#
    "Cox without Noulli" = "#FBBC05"                # Yellow/Orange#
  )#
  # Shape the disease names to be more readable#
  plot_data <- plot_data %>%#
    mutate(Disease = str_replace_all(Disease, "_", " "))#
#
  # Create the plot#
  p <- ggplot(plot_data, aes(x = auc, y = Disease, color = model)) +#
    geom_vline(xintercept = 0.5, linetype = "dashed", color = "gray70") +#
    geom_point(aes(shape = model), size = 2.5, position = position_dodge(width = 0.5)) +#
    geom_errorbarh(aes(xmin = lower, xmax = upper), height = 0.2, position = position_dodge(width = 0.5)) +#
    scale_color_manual(values = model_colors) +#
    scale_x_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Comparing performance of four prediction models across 28 diseases",#
      x = "AUC (95% CI)",#
      y = NULL,#
      color = "Model",#
      shape = "Model"#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      panel.grid.major.y = element_line(color = "gray90"),#
      panel.grid.minor.y = element_blank(),#
      axis.text.y = element_text(size = 10),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}#
#
# Main function to run the analysis#
create_multidisease_comparison <- function(data_path) {#
  # Parse the data#
  model_data <- parse_model_data(data_path)#
  # Prepare data for plotting#
  plot_data <- prepare_forest_plot_data(model_data)#
  # Create forest plot#
  forest_plot <- create_forest_plot(plot_data)#
  # Save the plot#
  ggsave("multidisease_forest_plot.png", forest_plot, width = 12, height = 14, dpi = 300)#
  # Print summary statistics#
  model_summary <- plot_data %>%#
    group_by(model) %>%#
    summarize(#
      mean_auc = mean(auc, na.rm = TRUE),#
      median_auc = median(auc, na.rm = TRUE),#
      min_auc = min(auc, na.rm = TRUE),#
      max_auc = max(auc, na.rm = TRUE)#
    )#
  print(model_summary)#
  return(forest_plot)#
}#
#
# Example usage:#
# forest_plot <- create_multidisease_comparison("model_comparison_everything.csv")#
# print(forest_plot)#
#
# Alternative approach with facet_wrap for separate panels by disease#
create_faceted_forest_plot <- function(plot_data) {#
  # Limit to top 16 diseases by dynamic AUC#
  top_diseases <- plot_data %>%#
    filter(model == "Aladynoulli Dynamic") %>%#
    arrange(desc(Events)) %>%#
    head(16) %>%#
    pull(Disease)#
  plot_data_subset <- plot_data %>%#
    filter(Disease %in% top_diseases)#
#
  plot_data_subset$Disease <- factor(plot_data_subset$Disease, levels = top_diseases)#
  plot_data_subset=plot_data%>%#
    filter(Disease %in% c("ASCVD","Diabetes","Breast_Cancer","COPD","Atrial_Fib","Prostate_Cancer","Osteoporosis",#
                          "Parkinsons","CKD","Heart_Failure","Rheumatoid_Arthritis","Stroke"))#
  # Define colors for models, now including TD Cox#
  model_colors <- c(#
    "Aladynoulli 1-year" = "#222222", # Black or dark gray#
    "Time-dependent Cox with Noulli" = "#8E44AD",   # Purple#
    "Aladynoulli Dynamic" = "#4285F4",              # Blue#
    "Aladynoulli Static" = "#34A853",               # Green#
    "Cox with Noulli" = "#EA4335",                  # Red#
    "Cox without Noulli" = "#FBBC05"                # Yellow/Orange#
  )#
  # Create the faceted plot#
  p <- ggplot(plot_data_subset, aes(x = model, y = auc, color = model)) +#
    geom_point(size = 2) +#
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +#
    facet_wrap(~ Disease, scales = "free_y", ncol = 4) +#
    geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +#
    scale_color_manual(values = model_colors) +#
    scale_y_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Performance across top 16 diseases",#
      y = "AUC (95% CI)",#
      x = NULL#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),#
      strip.text = element_text(face = "bold"),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}
model_data <- parse_model_data("all_model_comp_withtdcox2.csv")#
plot_data <- prepare_forest_plot_data(model_data)#
#
# Add this line to also generate the faceted plot#
faceted_plot <- create_faceted_forest_plot(plot_data)#
ggsave("multidisease_faceted_plot.pdf", faceted_plot, width = 12, height = 12, dpi = 300)#
# Function for time-dependent Cox modeling
# Load required libraries#
library(ggplot2)#
library(dplyr)#
library(tidyr)#
library(stringr)#
library(forcats)#
#
# Function to parse the data#
parse_model_data <- function(data_path) {#
  # Read the data#
  df <- read.csv(data_path)#
  # Extract confidence intervals from the formatted strings#
  extract_ci <- function(ci_str) {#
    # Matches format like "0.765 (0.748-0.782)"#
    pattern <- "(\\d+\\.\\d+)\\s*\\((\\d+\\.\\d+)-(\\d+\\.\\d+)\\)"#
    matches <- regexec(pattern, ci_str)#
    result <- regmatches(ci_str, matches)#
    if(length(result) > 0 && length(result[[1]]) >= 4) {#
      return(c(as.numeric(result[[1]][2]), #
               as.numeric(result[[1]][3]),#
               as.numeric(result[[1]][4])))#
    } else {#
      return(c(NA, NA, NA))#
    }#
  }#
  # Create a clean data frame#
  model_data <- data.frame(#
    Disease = df$Disease,#
    Events = df$Events,#
    Rate = df$Rate,#
    stringsAsFactors = FALSE#
  )#
  # Extract values for Aladynoulli Dynamic#
  dynamic_ci <- lapply(df$aladynoulli_auc_dynamic, extract_ci)#
  model_data$dynamic_auc <- sapply(dynamic_ci, function(x) x[1])#
  model_data$dynamic_lower <- sapply(dynamic_ci, function(x) x[2])#
  model_data$dynamic_upper <- sapply(dynamic_ci, function(x) x[3])#
  # Extract values for Aladynoulli Static#
  static_ci <- lapply(df$aladynoulli_auc_static, extract_ci)#
  model_data$static_auc <- sapply(static_ci, function(x) x[1])#
  model_data$static_lower <- sapply(static_ci, function(x) x[2])#
  model_data$static_upper <- sapply(static_ci, function(x) x[3])#
  # Add Cox values#
  model_data$cox_without_noulli <- df$cox_auc_without_noulli#
  model_data$cox_with_noulli <- df$cox_auc_with_noulli#
#
  # Add TD Cox AUC (as numeric)#
  model_data$td_cox_auc <- as.numeric(df$td_cox)#
  # Calculate CI for Cox values (using the formula SE = sqrt((AUC * (1-AUC)) / (n * prevalence)))#
  calc_cox_ci <- function(auc, events, total = 400000) {#
    prevalence <- events / total#
    prevalence <- max(0.01, prevalence)#
    se <- sqrt((auc * (1 - auc)) / (total * prevalence))#
    lower <- max(0, auc - 1.96 * se)#
    upper <- min(1, auc + 1.96 * se)#
    return(c(lower, upper))#
  }#
  # Add CI for Cox without Noulli#
  cox_without_ci <- mapply(calc_cox_ci, #
                           model_data$cox_without_noulli, #
                           model_data$Events, #
                           SIMPLIFY = FALSE)#
  model_data$cox_without_lower <- sapply(cox_without_ci, function(x) x[1])#
  model_data$cox_without_upper <- sapply(cox_without_ci, function(x) x[2])#
  # Add CI for Cox with Noulli#
  cox_with_ci <- mapply(calc_cox_ci, #
                        model_data$cox_with_noulli, #
                        model_data$Events, #
                        SIMPLIFY = FALSE)#
  model_data$cox_with_lower <- sapply(cox_with_ci, function(x) x[1])#
  model_data$cox_with_upper <- sapply(cox_with_ci, function(x) x[2])#
#
  # Add CI for TD Cox#
  td_cox_ci <- mapply(calc_cox_ci, #
                      model_data$td_cox_auc, #
                      model_data$Events, #
                      SIMPLIFY = FALSE)#
  model_data$td_cox_lower <- sapply(td_cox_ci, function(x) x[1])#
  model_data$td_cox_upper <- sapply(td_cox_ci, function(x) x[2])#
  # Calculate CI for Aladynoulli Dynamic using actual sample size (e.g., 400,000)#
  aladyn_dynamic_ci <- mapply(calc_cox_ci, #
                            model_data$dynamic_auc, #
                            model_data$Events, #
                            MoreArgs = list(total = 400000), #
                            SIMPLIFY = FALSE)#
  model_data$dynamic_lower <- sapply(aladyn_dynamic_ci, function(x) x[1])#
  model_data$dynamic_upper <- sapply(aladyn_dynamic_ci, function(x) x[2])#
#
  # Calculate CI for Aladynoulli Static using actual sample size (e.g., 400,000)#
  aladyn_static_ci <- mapply(calc_cox_ci, #
                           model_data$static_auc, #
                           model_data$Events, #
                           MoreArgs = list(total = 400000), #
                           SIMPLIFY = FALSE)#
  model_data$static_lower <- sapply(aladyn_static_ci, function(x) x[1])#
  model_data$static_upper <- sapply(aladyn_static_ci, function(x) x[2])#
  # Combine the two columns into one string#
  one_year_combined <- paste0(df$Dynamic1year, " ", trimws(df[[which(names(df) == "Dynamic1year") + 1]]))#
  one_year_ci <- lapply(one_year_combined, extract_ci)#
  model_data$one_year_auc <- sapply(one_year_ci, function(x) x[1])#
  model_data$one_year_lower <- sapply(one_year_ci, function(x) x[2])#
  model_data$one_year_upper <- sapply(one_year_ci, function(x) x[3])#
  # After extracting one_year_auc, one_year_lower, one_year_upper, add CI calculation for 1-year AUC using total=400000#
  one_year_ci_calc <- mapply(calc_cox_ci, #
                          model_data$one_year_auc, #
                          model_data$Events, #
                          MoreArgs = list(total = 400000), #
                          SIMPLIFY = FALSE)#
  model_data$one_year_lower <- sapply(one_year_ci_calc, function(x) x[1])#
  model_data$one_year_upper <- sapply(one_year_ci_calc, function(x) x[2])#
  return(model_data)#
}#
#
# Reshape data for plotting#
prepare_forest_plot_data <- function(model_data) {#
  # Transform to long format, now including TD Cox#
  long_data <- model_data %>%#
    pivot_longer(#
      cols = c("one_year_auc", "td_cox_auc", "dynamic_auc", "static_auc", "cox_with_noulli", "cox_without_noulli"),#
      names_to = "model",#
      values_to = "auc"#
    ) %>%#
    mutate(#
      lower = case_when(#
        model == "one_year_auc" ~ one_year_lower,#
        model == "td_cox_auc" ~ td_cox_lower,#
        model == "dynamic_auc" ~ dynamic_lower,#
        model == "static_auc" ~ static_lower,#
        model == "cox_with_noulli" ~ cox_with_lower,#
        model == "cox_without_noulli" ~ cox_without_lower#
      ),#
      upper = case_when(#
        model == "one_year_auc" ~ one_year_upper,#
        model == "td_cox_auc" ~ td_cox_upper,#
        model == "dynamic_auc" ~ dynamic_upper,#
        model == "static_auc" ~ static_upper,#
        model == "cox_with_noulli" ~ cox_with_upper,#
        model == "cox_without_noulli" ~ cox_without_upper#
      ),#
      model = case_when(#
        model == "one_year_auc" ~ "Aladynoulli 1-year",#
        model == "td_cox_auc" ~ "Time-dependent Cox with Noulli",#
        model == "dynamic_auc" ~ "Aladynoulli Dynamic",#
        model == "static_auc" ~ "Aladynoulli Static",#
        model == "cox_with_noulli" ~ "Cox with Noulli",#
        model == "cox_without_noulli" ~ "Cox without Noulli"#
      )#
    ) %>%#
    select(Disease, Events, Rate, model, auc, lower, upper)#
  # Set the model order with 'Aladynoulli 1-year' as the far left#
  long_data$model <- factor(long_data$model, levels = c(#
    "Aladynoulli 1-year",#
    "Time-dependent Cox with Noulli",#
    "Aladynoulli Dynamic",#
    "Aladynoulli Static",#
    "Cox with Noulli",#
    "Cox without Noulli"#
  ))#
  # Make Disease a factor ordered by dynamic AUC#
  disease_order <- model_data %>%#
    arrange(desc(dynamic_auc)) %>%#
    pull(Disease)#
  long_data$Disease <- factor(long_data$Disease, levels = disease_order)#
  return(long_data)#
}#
#
# Create the forest plot#
create_forest_plot <- function(plot_data) {#
  # Define colors for models#
  model_colors <- c(#
    "Aladynoulli 1-year" = "#222222", # Black or dark gray#
    "Time-dependent Cox with Noulli" = "#8E44AD",   # Purple#
    "Aladynoulli Dynamic" = "#4285F4",              # Blue#
    "Aladynoulli Static" = "#34A853",               # Green#
    "Cox with Noulli" = "#EA4335",                  # Red#
    "Cox without Noulli" = "#FBBC05"                # Yellow/Orange#
  )#
  # Shape the disease names to be more readable#
  plot_data <- plot_data %>%#
    mutate(Disease = str_replace_all(Disease, "_", " "))#
#
  # Create the plot#
  p <- ggplot(plot_data, aes(x = auc, y = Disease, color = model)) +#
    geom_vline(xintercept = 0.5, linetype = "dashed", color = "gray70") +#
    geom_point(aes(shape = model), size = 2.5, position = position_dodge(width = 0.5)) +#
    geom_errorbarh(aes(xmin = lower, xmax = upper), height = 0.2, position = position_dodge(width = 0.5)) +#
    scale_color_manual(values = model_colors) +#
    scale_x_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Comparing performance of four prediction models across 28 diseases",#
      x = "AUC (95% CI)",#
      y = NULL,#
      color = "Model",#
      shape = "Model"#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      panel.grid.major.y = element_line(color = "gray90"),#
      panel.grid.minor.y = element_blank(),#
      axis.text.y = element_text(size = 10),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}#
#
# Main function to run the analysis#
create_multidisease_comparison <- function(data_path) {#
  # Parse the data#
  model_data <- parse_model_data(data_path)#
  # Prepare data for plotting#
  plot_data <- prepare_forest_plot_data(model_data)#
  # Create forest plot#
  forest_plot <- create_forest_plot(plot_data)#
  # Save the plot#
  ggsave("multidisease_forest_plot.png", forest_plot, width = 12, height = 14, dpi = 300)#
  # Print summary statistics#
  model_summary <- plot_data %>%#
    group_by(model) %>%#
    summarize(#
      mean_auc = mean(auc, na.rm = TRUE),#
      median_auc = median(auc, na.rm = TRUE),#
      min_auc = min(auc, na.rm = TRUE),#
      max_auc = max(auc, na.rm = TRUE)#
    )#
  print(model_summary)#
  return(forest_plot)#
}#
#
# Example usage:#
# forest_plot <- create_multidisease_comparison("model_comparison_everything.csv")#
# print(forest_plot)#
#
# Alternative approach with facet_wrap for separate panels by disease#
create_faceted_forest_plot <- function(plot_data) {#
  # Limit to top 16 diseases by dynamic AUC#
  top_diseases <- plot_data %>%#
    filter(model == "Aladynoulli Dynamic") %>%#
    arrange(desc(Events)) %>%#
    head(16) %>%#
    pull(Disease)#
  plot_data_subset <- plot_data %>%#
    filter(Disease %in% top_diseases)#
#
  plot_data_subset$Disease <- factor(plot_data_subset$Disease, levels = top_diseases)#
plot_data_subset=plot_data%>%#
 filter(Disease %in% c("ASCVD","Diabetes","Breast_Cancer","COPD","Atrial_Fib","Prostate_Cancer","Osteoporosis",#
                          "Parkinsons","CKD","Heart_Failure","Rheumatoid_Arthritis","Colorectal_Cancer"))#
  # Define colors for models, now including TD Cox#
  model_colors <- c(#
    "Aladynoulli 1-year" = "#222222", # Black or dark gray#
    "Time-dependent Cox with Noulli" = "#8E44AD",   # Purple#
    "Aladynoulli Dynamic" = "#4285F4",              # Blue#
    "Aladynoulli Static" = "#34A853",               # Green#
    "Cox with Noulli" = "#EA4335",                  # Red#
    "Cox without Noulli" = "#FBBC05"                # Yellow/Orange#
  )#
  # Create the faceted plot#
  p <- ggplot(plot_data_subset, aes(x = model, y = auc, color = model)) +#
    geom_point(size = 2) +#
    geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.1) +#
    facet_wrap(~ Disease, scales = "free_y", ncol = 4) +#
    geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +#
    scale_color_manual(values = model_colors) +#
    scale_y_continuous(limits = c(0.3, 1), breaks = seq(0.3, 1, by = 0.1)) +#
    labs(#
      title = "Multi-Disease AUC Comparison",#
      subtitle = "Performance across top 16 diseases",#
      y = "AUC (95% CI)",#
      x = NULL#
    ) +#
    theme_minimal() +#
    theme(#
      legend.position = "top",#
      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),#
      strip.text = element_text(face = "bold"),#
      plot.title = element_text(size = 14, face = "bold"),#
      plot.subtitle = element_text(size = 12)#
    )#
  return(p)#
}
model_data <- parse_model_data("all_model_comp_withtdcox2.csv")#
plot_data <- prepare_forest_plot_data(model_data)#
#
# Add this line to also generate the faceted plot#
faceted_plot <- create_faceted_forest_plot(plot_data)#
ggsave("multidisease_faceted_plot.pdf", faceted_plot, width = 12, height = 12, dpi = 300)#
# Function for time-dependent Cox modeling
head(model_data)
faceted_plot
df=read.csv("all_model_comp_withtdcox2.csv")
head(df)
one_year_combined <- paste0(df$Dynamic1year, " ", trimws(df[[which(names(df) == "Dynamic1year") + 1]]))
head(one_year_combined)
one_year_ci <- lapply(one_year_combined, extract_ci)#
  model_data$one_year_auc <- sapply(one_year_ci, function(x) x[1])#
  model_data$one_year_lower <- sapply(one_year_ci, function(x) x[2])#
  model_data$one_year_upper <- sapply(one_year_ci, function(x) x[3])
# Extract confidence intervals from the formatted strings#
  extract_ci <- function(ci_str) {#
    # Matches format like "0.765 (0.748-0.782)"#
    pattern <- "(\\d+\\.\\d+)\\s*\\((\\d+\\.\\d+)-(\\d+\\.\\d+)\\)"#
    matches <- regexec(pattern, ci_str)#
    result <- regmatches(ci_str, matches)#
    if(length(result) > 0 && length(result[[1]]) >= 4) {#
      return(c(as.numeric(result[[1]][2]), #
               as.numeric(result[[1]][3]),#
               as.numeric(result[[1]][4])))#
    } else {#
      return(c(NA, NA, NA))#
    }#
  }
one_year_ci <- lapply(one_year_combined, extract_ci)
one_year_ci
one_year_combined
one_year_ci
head(df$Dynamic1year)
df
one_year_str <- gsub('[]', '-', as.character(df$Dynamic1year))#
  one_year_ci <- lapply(one_year_str, extract_ci)#
  model_data$one_year_auc <- sapply(one_year_ci, function(x) x[1])#
  model_data$one_year_lower <- sapply(one_year_ci, function(x) x[2])#
  model_data$one_year_upper <- sapply(one_year_ci, function(x) x[3])
one_year_str
head(df)
one_year_ci_str <- gsub("[\u2013\u2014]", "-", as.character(df$X.2))#
  extract_ci <- function(ci_str) {#
    pattern <- "\\((\\d+\\.\\d+)-(\\d+\\.\\d+)\\)"#
    matches <- regexec(pattern, ci_str)#
    result <- regmatches(ci_str, matches)#
    if(length(result) > 0 && length(result[[1]]) >= 3) {#
      return(c(as.numeric(result[[1]][2]), as.numeric(result[[1]][3])))#
    } else {#
      return(c(NA, NA))#
    }#
  }
