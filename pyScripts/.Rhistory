)
p1 <- ggplot(df_indiv, aes(x = Age, y = Theta, color = Patient, group = Patient)) +
geom_line(size = 1.1) +
geom_vline(aes(xintercept = Event, color = Patient), linetype = "solid", size = 1) +
geom_vline(aes(xintercept = Event-2, color = Patient), linetype = "dashed", size = 1) +
labs(title = "Softmax Trajectories (Individual Patients)", y = paste0("Theta (K=", k_idx, ")"), x = "Age") +
theme_minimal(base_size = 15) +
theme(legend.position = "bottom")
# --- Panel 2: Case vs Control means ---
case_thetas = colMeans(all_thetas[which(E != 81), k_idx, ])
control_thetas = colMeans(all_thetas[, k_idx, ])
df_mean <- data.frame(
Age = rep(ages, 2),
Theta = c(case_thetas, control_thetas),
Group = rep(c("Case", "Control"), each = length(ages))
)
p2 <- ggplot(df_mean, aes(x = Age, y = Theta, color = Group)) +
geom_line(size = 1.2) +
labs(title = "Mean Softmax Trajectories", y = paste0("Theta (K=", k_idx, ")"), x = "Age") +
scale_color_manual(values = c("Case" = "red", "Control" = "blue")) +
theme_minimal(base_size = 15) +
theme(legend.position = "bottom")
g=p1 + p2 + plot_layout(ncol = 1)
g
g
g
ggsave(plot =g,filename = "sofmaxtraj.pdf",width=10,height = 20 )
# --- Combine panels ---
g=p1 + p2 + plot_layout(ncol = 1)
ggsave(plot =g,filename = "sofmaxtraj.pdf",width=10,height = 15 )
set.seed(4)
idxs <- sample(which(E != 81),size = 4)
df_indiv <- data.frame(
Age = rep(ages, length(idxs)),
Theta = as.vector(t(all_thetas[idxs, k_idx, ])),
Patient = factor(rep(idxs, each = length(ages))),
Event = rep(E[idxs], each = length(ages))
)
p1 <- ggplot(df_indiv, aes(x = Age, y = Theta, color = Patient, group = Patient)) +
geom_line(size = 1.1) +
geom_vline(aes(xintercept = Event, color = Patient), linetype = "solid", size = 1) +
geom_vline(aes(xintercept = Event-2, color = Patient), linetype = "dashed", size = 1) +
labs(title = "Softmax Trajectories (Individual Patients)", y = paste0("Theta (K=", k_idx, ")"), x = "Age") +
theme_minimal(base_size = 15) +
theme(legend.position = "bottom")
p1
set.seed(7)
idxs <- sample(which(E != 81),size = 5)
df_indiv <- data.frame(
Age = rep(ages, length(idxs)),
Theta = as.vector(t(all_thetas[idxs, k_idx, ])),
Patient = factor(rep(idxs, each = length(ages))),
Event = rep(E[idxs], each = length(ages))
)
p1 <- ggplot(df_indiv, aes(x = Age, y = Theta, color = Patient, group = Patient)) +
geom_line(size = 1.1) +
geom_vline(aes(xintercept = Event, color = Patient), linetype = "solid", size = 1) +
geom_vline(aes(xintercept = Event-2, color = Patient), linetype = "dashed", size = 1) +
labs(title = "Softmax Trajectories (Individual Patients)", y = paste0("Theta (K=", k_idx, ")"), x = "Age") +
theme_minimal(base_size = 15) +
theme(legend.position = "bottom")
p1
# --- Panel 2: Case vs Control means ---
case_thetas = colMeans(all_thetas[which(E != 81), k_idx, ])
control_thetas = colMeans(all_thetas[, k_idx, ])
df_mean <- data.frame(
Age = rep(ages, 2),
Theta = c(case_thetas, control_thetas),
Group = rep(c("Case", "Control"), each = length(ages))
)
p2 <- ggplot(df_mean, aes(x = Age, y = Theta, color = Group)) +
geom_line(size = 1.2) +
labs(title = "Mean Softmax Trajectories", y = paste0("Theta (K=", k_idx, ")"), x = "Age") +
scale_color_manual(values = c("Case" = "red", "Control" = "blue")) +
theme_minimal(base_size = 15) +
theme(legend.position = "bottom")
# --- Combine panels ---
g=p1 + p2 + plot_layout(ncol = 1)
g
g=p1 + p2 + plot_layout(ncol = 1)
ggsave(plot =g,filename = "sofmaxtraj.pdf",width=10,height = 12 )
g=p1 + p2 + plot_layout(ncol = 1)
ggsave(plot =g,filename = "sofmaxtraj.pdf",width=10,height = 10 )
library(data.table)
library(dplyr)
library(tidyr)
library(ggplot2)
library(stats)
library(logistf)  # For more stable logistic regression
library(pheatmap)
analyze_signature_snp_associations <- function(
genotype_file_default = "/Users/sarahurbut/Dropbox/genotype_raw/genotype_dosage_20250416.raw",
genotype_file_sig5 = "/Users/sarahurbut/Dropbox/genotype_raw/genotype_dosage_20250415.raw",
covariate_file = "/Users/sarahurbut/Dropbox/for_regenie/ukbb_covariates_400k.txt",
snp_list_dir = "/Users/sarahurbut/Dropbox/snp_lists",
phenotype_dir = "/Users/sarahurbut/Dropbox/for_regenie/case_control_phenotypes",
sig_stats_dir = "/Users/sarahurbut/Dropbox/result326/10_loci",
signatures_to_analyze = c(4),
output_dir = NULL
) {
# Initialize results list
results_list <- list()
for (sig in signatures_to_analyze) {
message(sprintf("\nAnalyzing Signature %d", sig))
# Read signature summary statistics
sig_stats_file <- file.path(sig_stats_dir,
sprintf("SIG%d_AUC_ukb_eur_regenie_af1.sig.lead.sumstats.txt", sig))
tryCatch({
# Read and process signature statistics
sig_stats <- fread(sig_stats_file)
message(sprintf("Loaded signature statistics with %d rows", nrow(sig_stats)))
# Create SNP to Z-stat mapping
sig_z_stats <- setNames(sig_stats[[17]], sig_stats[[13]])  # Adjust column indices as needed
message(sprintf("Created Z-stat mapping for %d SNPs", length(sig_z_stats)))
}, error = function(e) {
message(sprintf("Error reading signature statistics: %s", e$message))
return(NULL)
})
# Select appropriate genotype file
genotype_file <- if(sig == 5) genotype_file_sig5 else genotype_file_default
message(sprintf("Using genotype file: %s", genotype_file))
# Read significant SNPs
snp_file <- file.path(snp_list_dir, sprintf("snp_list_sig%d.txt", sig))
tryCatch({
sig_snps <- fread(snp_file, col.names = c("idx", "rsid"))$rsid
message(sprintf("Found %d significant SNPs", length(sig_snps)))
}, error = function(e) {
message(sprintf("Error reading SNP file: %s", e$message))
return(NULL)
})
# Read phenotypes
pheno_file <- file.path(phenotype_dir, sprintf("case_control_sig%d.tsv", sig))
tryCatch({
phenotypes <- fread(pheno_file)
message(sprintf("Loaded phenotypes with dimensions %d x %d",
nrow(phenotypes), ncol(phenotypes)))
}, error = function(e) {
message(sprintf("Error reading phenotype file: %s", e$message))
return(NULL)
})
# Read genotypes
tryCatch({
genotypes <- fread(genotype_file)
# Process column names to match SNPs
geno_cols <- colnames(genotypes)
snp_cols <- geno_cols[!geno_cols %in% c("FID", "IID", "PAT", "MAT", "SEX", "PHENOTYPE")]
# Create column mapping
col_to_snp <- sapply(snp_cols, function(x) strsplit(x, "_")[[1]][1])
# Find matching columns for significant SNPs
snp_to_col <- sapply(sig_snps, function(snp) {
matching_cols <- names(col_to_snp)[col_to_snp == snp]
if(length(matching_cols) > 0) matching_cols[1] else NA
})
# Remove NA mappings
snp_to_col <- snp_to_col[!is.na(snp_to_col)]
if(length(snp_to_col) == 0) {
message("No matching SNPs found in genotype file")
return(NULL)
}
# Select and rename columns
selected_cols <- c("FID", unname(snp_to_col))
genotypes <- genotypes[, ..selected_cols]  # Using data.table syntax
setnames(genotypes, unname(snp_to_col), names(snp_to_col))
}, error = function(e) {
message(sprintf("Error reading genotype file: %s", e$message))
return(NULL)
})
# Read covariates
tryCatch({
covariates <- fread(covariate_file)
pc_cols <- grep("^PC", colnames(covariates), value = TRUE)
covariates <- covariates[, c("identifier", "sex", pc_cols), with = FALSE]
setnames(covariates, "identifier", "FID")
}, error = function(e) {
message(sprintf("Error processing covariates: %s", e$message))
return(NULL)
})
# Merge data
merged_data <- Reduce(function(x, y) merge(x, y, by = "FID"),
list(genotypes, covariates, phenotypes))
# Initialize results storage
snp_results <- data.frame()
# Analyze each SNP
for(snp in names(snp_to_col)) {
message(sprintf("Analyzing %s", snp))
pheno_cols <- setdiff(colnames(phenotypes), "FID")
# Test SNP against each phenotype
for(pheno in pheno_cols) {
# Prepare data for model
check_cols <- c(snp, pheno, "sex", pc_cols)
model_data <- merged_data[complete.cases(merged_data[, ..check_cols]), ]
if(nrow(model_data) < 10) next
tryCatch({
# Fit logistic regression using logistf for better stability
formula_str <- sprintf("%s ~ %s + sex + %s",
pheno, snp, paste(pc_cols, collapse = " + "))
model <- glm(formula = as.formula(formula_str),data = model_data,family="binomial")
# Extract results
beta <- coef(model)[snp]
z_stat <- beta / sqrt(diag(vcov(model)))[snp]
p_val <- model$prob[snp]
# Add to results
snp_results <- rbind(snp_results, data.frame(
SNP = snp,
Phenotype = pheno,
Beta = beta,
Z_statistic = z_stat,
P_value = p_val,
N = nrow(model_data)
))
}, error = function(e) {
message(sprintf("Error in regression for %s-%s: %s", snp, pheno, e$message))
})
}
}
if(nrow(snp_results) == 0) {
message(sprintf("No results generated for signature %d", sig))
next
}
# Add signature Z-statistics
snp_results$Signature_Z <- sig_z_stats[snp_results$SNP]
# Find interesting SNPs
sig_threshold <- 5e-8
interesting_snps <- snp_results %>%
group_by(SNP) %>%
summarise(
all_nonsig = all(P_value > sig_threshold),
mean_abs_z = mean(abs(Z_statistic)),
Signature_Z = first(Signature_Z),
N = mean(N)
) %>%
filter(all_nonsig) %>%
arrange(desc(mean_abs_z))
# Store results
results_list[[as.character(sig)]] <- list(
full_results = snp_results,
interesting_snps = interesting_snps
)
# Create visualization
if(nrow(interesting_snps) > 0) {
# Get top SNPs
top_snps <- head(interesting_snps$SNP, 10)
plot_data <- snp_results %>%
filter(SNP %in% top_snps) %>%
select(SNP, Phenotype, Z_statistic, Signature_Z)
# Create matrix for heatmap
heatmap_data <- plot_data %>%
pivot_wider(
names_from = Phenotype,
values_from = Z_statistic,
id_cols = c(SNP, Signature_Z)
) %>%
as.data.frame()
rownames(heatmap_data) <- heatmap_data$SNP
heatmap_data$SNP <- NULL
sig_z <- heatmap_data$Signature_Z
heatmap_data$Signature_Z <- NULL
# Create heatmap
if(!is.null(output_dir)) {
pdf(file.path(output_dir, sprintf("signature_%d_snp_heatmap.pdf", sig)),
width = 12, height = 8)
}
pheatmap(
heatmap_data,
main = sprintf("Signature %d: SNPs with No Individual Disease Associations", sig),
scale = "none",
cluster_rows = FALSE,
cluster_cols = FALSE,
display_numbers = TRUE,
number_format = "%.2f",
fontsize_number = 8
)
if(!is.null(output_dir)) dev.off()
# Print summary
message("\nTop SNPs summary:")
print(head(interesting_snps, 10))
}
}
return(results_list)
}
# Run the analysis
results <- analyze_signature_snp_associations(
signatures_to_analyze = c(5),
output_dir = "output"
)
genotype_file_default="/Users/sarahurbut/Dropbox/genotype_raw/genotype_dosage_20250416.raw";
library(data.table)
genotype_file_sig5="/Users/sarahurbut/Dropbox/genotype_raw/genotype_dosage_20250415.raw";
covariate_file="/Users/sarahurbut/Dropbox/for_regenie/ukbb_covariates_400k.txt";
snp_list_dir="/Users/sarahurbut/Dropbox/snp_lists";
phenotype_dir="/Users/sarahurbut/Dropbox/for_regenie/case_control_phenotypes";
sig_stats_dir="~/Dropbox/result326/10_loci";
library(broom)
signatures_to_analyze=c(0,5,7,14,15,18)
sigs_list=vector("list", length(signatures_to_analyze))
names(sigs_list)=as.character(signatures_to_analyze)
for (sig in signatures_to_analyze){
print(paste("analysing sig",sig))
# Read signature summary statistics
sig_stats_file = paste0(sig_stats_dir,"/SIG",sig,"_AUC_ukb_eur_regenie_af1.sig.lead.sumstats.txt")
# Read the file with headers
sig_stats =fread(sig_stats_file)
colnames(sig_stats)
# Create mapping of SNP ID to signature z-stat
# Select appropriate genotype file based on signature
genotype_file = ifelse(sig==5,genotype_file_sig5,genotype_file_default)
# Read significant SNPs for this signature
snp_file = fread(paste0("~/Dropbox/snp_lists/snp_list_sig",sig,".txt"))
sig_snps_vec <- as.character(snp_file$V2)
# Read case-control status
phenotypes = fread(paste0("~/Dropbox/for_regenie/case_control_phenotypes/case_control_sig",sig,".tsv"))
# Read genotypes (only for significant SNPs)
genotypes = fread(genotype_file)
# Create mapping from column names to base SNP IDs
geno_cols = colnames(genotypes)
col_to_snp = geno_cols[-c(1:6)]
# Extract base SNP ID by removing allele suffix
base_snp = stringr::str_split_fixed(col_to_snp,"_",n=2)[,1] # Split on underscore for rsIDs
colnames(genotypes)[-c(1:6)]=base_snp
snps_present <- intersect(sig_snps_vec, colnames(genotypes))
genotypes_subset <- genotypes[, .SD, .SDcols = c("FID", snps_present)]
# Find matching columns for our SNPs of interest
covariates = fread("~/Dropbox/for_regenie/ukbb_covariates_400k.txt")
# Keep only needed columns and rename 'identifier' to match merge
covariates=data.frame(covariates)
covariates = covariates[,c(1,2,5:24)]
colnames(covariates)[1]="FID"
merged_data = merge(genotypes_subset,covariates,by="FID")
merged_data=merge(merged_data,phenotypes)
pheno_cols <- setdiff(colnames(merged_data), c("FID", snps_present, "sex", paste0("PC", 1:20)))
pc_cols <- paste0("PC", 1:20)
# Initialize results storage
results_list <- list()
for (snp in snps_present) {
sum_data=sig_stats[sig_stats$rsid==snp,]
for (pheno in pheno_cols) {
# Prepare data
model_data <- merged_data[, .SD,.SDcols=c(snp, pheno, "sex", pc_cols)]
model_data <- na.omit(model_data)
if (nrow(model_data) < 10) next
# Fit logistic regression
formula_str <- paste(pheno, "~", snp, "+ sex +", paste(pc_cols, collapse = " + "))
fit <- try(glm(as.formula(formula_str), data = model_data, family = binomial()), silent = TRUE)
if (inherits(fit, "try-error")) next
# Extract results for the SNP
tidy_fit <- tidy(fit)
snp_row <- tidy_fit[tidy_fit$term == snp, ]
if (nrow(snp_row) == 1) {
results_list[[length(results_list) + 1]] <- data.frame(
SNP = snp,
Phenotype = pheno,
Beta = snp_row$estimate,
Z_statistic = snp_row$statistic,
P_value = snp_row$p.value,
N = nrow(model_data),
sig_snp_beta=sum_data$BETA,
sig_snp_se=sum_data$SE,
sig_snp_p=sum_data$LOG10P
)
}
}
}
sigs_list[[as.character(sig)]]=results_list
}
list_final=lapply(1:length(sigs_list),function(x){
r=do.call(rbind,sigs_list[[x]])
r$sig=names(sigs_list)[x]
return(r)})
r=do.call(rbind,list_final)
library(data.table)
# Directory containing your case_control files
phenotype_dir <- "~/Dropbox/for_regenie/case_control_phenotypes"
# List all files
case_files <- list.files(phenotype_dir, pattern = "^case_control_sig\\d+\\.tsv$", full.names = TRUE)
# Create a named list mapping signature number to phenotype names
sig_to_phenos <- setNames(vector("list", length(case_files)), nm = gsub(".*sig(\\d+)\\.tsv$", "\\1", case_files))
for (f in case_files) {
sig_num <- gsub(".*sig(\\d+)\\.tsv$", "\\1", f)
dt <- fread(f, nrows = 0) # Only read header
phenos <- setdiff(colnames(dt), "FID")
sig_to_phenos[[sig_num]] <- phenos
}
library(dplyr)
library(ggplot2)
library(dplyr)
# Add signature log10P column
r$Signature_log10P <- r$sig_snp_p
# Shorten phenotype names (optional)
r$Phenotype_short <- gsub("_", " ", r$Phenotype) # or use a mapping for even shorter names
# For each signature, add a row for the signature p-value
signature_rows <- r %>%
group_by(sig, SNP) %>%
summarise(
Phenotype = "Signature",
P_value = 10^(-unique(sig_snp_p)),  # Convert log10P to P
sig = unique(sig)
) %>%
ungroup()
# Combine with the original data
r_augmented <- bind_rows(r, signature_rows)
r_augmented <- r_augmented %>%
mutate(Significant = P_value < 5e-8)
library(ggplot2)
saveRDS(r_augmented,"r_augmented.rds")
p=ggplot(r_augmented, aes(x = Phenotype, y = SNP, fill = -log10(P_value))) +
geom_tile(color = "white") +
geom_tile(data = subset(r_augmented, Significant), fill = NA, color = "black", size = 1.2) + # bold border for sig
geom_text(aes(label = ifelse(Significant, "*", "")), color = "black", size = 5, vjust = 0.5) +
facet_wrap(~as.factor(sig), scales = "free", ncol = 2) +
scale_fill_gradient(low = "#eeeeee", high = "#2c3e50", name = "-log10(p)") +
theme_minimal(base_size = 5) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1, size = 5),
axis.text.y = element_text(size = 5)
) +
labs(
title = "SNP-Phenotype Association Heatmap by Signature",
x = "Phenotype",
y = "SNP"
)
p
p = ggplot(r_augmented, aes(x = Phenotype, y = SNP, fill = -log10(P_value))) +
geom_tile(color = "white") +
geom_tile(data = subset(r_augmented, Significant), fill = NA, color = "black", size = 1.2) + # bold border for sig
geom_text(aes(label = ifelse(Significant, "*", "")), color = "black", size = 5, vjust = 0.5) +
facet_grid(rows = vars(sig), scales = "free_y", space = "free_y") +
scale_fill_gradient(low = "#eeeeee", high = "#2c3e50", name = "-log10(p)") +
theme_minimal(base_size = 5) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1, size = 5),
axis.text.y = element_text(size = 5),
strip.text.y = element_text(angle = 0, size = 7)
) +
labs(
title = "SNP-Phenotype Association Heatmap by Signature",
x = "Phenotype",
y = "SNP"
)
p
p = ggplot(r_augmented, aes(x = Phenotype, y = SNP, fill = -log10(P_value))) +
geom_tile(color = "white") +
geom_tile(
data = subset(r_augmented, Significant),
aes(color = as.factor(sig)), fill = NA, size = 1.2
) + # colored border for sig
geom_text(aes(label = ifelse(Significant, "*", "")), color = "black", size = 5, vjust = 0.5) +
facet_grid(rows = vars(sig), scales = "free_y", space = "free_y") +
scale_fill_gradient(low = "#eeeeee", high = "#2c3e50", name = "-log10(p)") +
scale_color_brewer(palette = "Set1", name = "Signature") +
theme_minimal(base_size = 5) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1, size = 5),
axis.text.y = element_text(size = 5),
strip.text.y = element_text(angle = 0, size = 7),
legend.position = "right"
) +
labs(
title = "SNP-Phenotype Association Heatmap by Signature",
x = "Phenotype",
y = "SNP"
)
p
p = ggplot(r_augmented, aes(x = Phenotype, y = SNP, fill = as.factor(sig))) +
geom_tile(color = "white") +
geom_tile(
data = subset(r_augmented, Significant),
color = "black", fill = NA, size = 1.2
) +
geom_text(aes(label = ifelse(Significant, "*", "")), color = "black", size = 5, vjust = 0.5) +
facet_grid(rows = vars(sig), scales = "free_y", space = "free_y") +
scale_fill_brewer(palette = "Set1", name = "Signature") +
theme_minimal(base_size = 5) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1, size = 5),
axis.text.y = element_text(size = 5),
strip.text.y = element_text(angle = 0, size = 7),
legend.position = "right"
) +
labs(
title = "SNP-Phenotype Association Heatmap by Signature",
x = "Phenotype",
y = "SNP"
)
p
p = ggplot(r_augmented, aes(x = Phenotype, y = SNP, fill = as.factor(sig))) +
geom_tile(color = "white") +
geom_tile(
data = subset(r_augmented, Significant),
color = "black", fill = NA, size = 0.8
) +
geom_text(aes(label = ifelse(Significant, "*", "")), color = "black", size = 5, vjust = 0.5) +
facet_grid(rows = vars(sig), scales = "free_y", space = "free_y") +
scale_fill_brewer(palette = "Set1", name = "Signature") +
theme_minimal(base_size = 5) +
theme(
axis.text.x = element_text(angle = 45, hjust = 1, size = 5),
axis.text.y = element_text(size = 5),
strip.text.y = element_text(angle = 0, size = 7),
legend.position = "right"
) +
labs(
title = "SNP-Phenotype Association Heatmap by Signature",
x = "Phenotype",
y = "SNP"
)
p
ggsave(plot = p,filename = "SNP-Phenotype Association Heatmap by Signature.pdf",dpi=300,width = 10,height = 10)
ls()
rm(list=ls())
ukb_params=readRDS("/Users/sarahurbut/aladynoulli2/pyScripts/big_stuff/ukb_params_enrollment.rds")
model_params=ukb_params
all_thetas <- softmax_by_k(model_params$lambda)
