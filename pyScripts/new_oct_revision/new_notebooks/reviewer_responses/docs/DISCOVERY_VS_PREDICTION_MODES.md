# Discovery vs Prediction Modes

## Two Modes of Aladynoulli

Aladynoulli has **two distinct modes** for different purposes:

---

## ðŸ”¬ Discovery Mode: Joint Phi Fitting

**Purpose**: Learn disease signatures (phi) from data to understand disease connections

**How it works**:
- **Phi is learned** from the data (joint estimation)
- Model learns which diseases cluster together into signatures
- Used for understanding disease biology and relationships

**Location**: `/Dropbox/enrollment_retrospective_full/`
- Generated by: `run_full_retrospective.sh` â†’ `run_aladyn_batch.py`
- Outputs: `enrollment_model_W0.0001_batch_*_*.pt` (contains learned phi)

**Used by**:
- âœ… FH Analysis (`fh_analysis_summary.ipynb`, `R1_Q3_Clinical_Meaning.ipynb`)
  - Uses: `thetas_with_pcs_retrospective.pt` (derived from joint fitting)
- âœ… IPW Analysis (`ipw_analysis_summary.ipynb`, `R1_Q1_Selection_Bias.ipynb`)
  - Uses: Weighted phi from joint fitting
- âœ… Heritability Analysis (`heritability_analysis_summary.ipynb`, `R1_Q7_Heritability.ipynb`)
  - Uses: GWAS results from signatures (phi/theta from joint fitting)
- âœ… Heterogeneity/Pathway Analysis (`heterogeneity_analysis_summary.ipynb`, `R3_Q8_Heterogeneity.ipynb`)
  - Uses: `thetas_with_pcs_retrospective.pt` (from joint fitting)

**Status**: âœ… **Already done** - No rerun needed

---

## ðŸŽ¯ Prediction Mode: Fixed Phi

**Purpose**: Make predictions using pre-learned signatures (stable, generalizable)

**How it works**:
- **Phi is fixed** from master checkpoints (pre-learned signatures)
- Only **lambda** (individual signature loadings) is estimated
- Used for clinical prediction and performance evaluation

**Location**: `/Dropbox/models_fromAWS_enrollment_predictions_fixedphi_RETROSPECTIVE_pooled/`
- Generated by: `run_aladyn_predict_with_master.py` (on AWS)
- Outputs: `pi_enroll_fixedphi_sex_*.pt` (pi tensors for predictions)

**Used by**:
- ðŸ”„ Washout Analyses (`R2_Temporal_Leakage.ipynb`)
  - Uses: `pi_enroll_fixedphi_sex_*.pt` (washout predictions)
- ðŸ”„ Age Offset Analyses (`R1_Q2_Lifetime_Risk.ipynb`, `R1_Q10_Age_Specific.ipynb`)
  - Uses: `pi_enroll_fixedphi_age_offset_*_sex_*.pt`
- ðŸ”„ AUC Comparisons (`R1_Q9_AUC_Comparisons.ipynb`)
  - Uses: `pi_enroll_fixedphi_sex_*.pt` or `pi_full_400k.pt`
- ðŸ”„ Prediction Drops Analysis
  - Uses: `pi_enroll_fixedphi_sex_*.pt` (washout comparisons)

**Status**: ðŸ”„ **Needs rerun** if using new master checkpoints

---

## ðŸ“Š Summary Table

| Mode | Phi Status | Purpose | Location | Status |
|------|-----------|---------|----------|--------|
| **Discovery** | Learned (joint) | Understand disease biology | `/Dropbox/enrollment_retrospective_full/` | âœ… Done |
| **Prediction** | Fixed (from master) | Clinical predictions | `/Dropbox/models_fromAWS_.../` | ðŸ”„ Rerun if new |

---

## ðŸ”„ Workflow

1. **Discovery Phase** (Already done):
   ```bash
   ./run_full_retrospective.sh  # Runs on all 40 batches
   # Outputs: /Dropbox/enrollment_retrospective_full/
   # Contains: Learned phi, theta
   ```

2. **Prediction Phase** (On AWS):
   ```bash
   # On AWS
   python run_aladyn_predict_with_master.py  # Uses fixed phi
   # Outputs: pi_enroll_fixedphi_sex_*.pt
   ```

3. **Analysis Phase** (Local):
   - Discovery analyses use outputs from step 1 âœ…
   - Prediction analyses use outputs from step 2 ðŸ”„

---

## ðŸŽ¯ Key Insight

- **Discovery analyses** (FH, IPW, heritability, heterogeneity) use **joint phi** outputs
  - These are **already done** and don't need rerun
  - They use phi/theta from `/Dropbox/enrollment_retrospective_full/`

- **Prediction analyses** (washout, age offset, AUC) use **fixed phi** outputs  
  - These **need rerun** if you regenerate pi tensors with new master checkpoints
  - They use pi tensors from AWS synced to local

---

**Bottom Line**: Discovery = joint phi (done), Prediction = fixed phi (rerun if new pi tensors)

