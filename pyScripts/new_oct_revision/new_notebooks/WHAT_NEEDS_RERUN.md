# What Needs Rerun After Master Checkpoint Predictions

## ‚úÖ Already Done (Discovery - Joint Phi Fitting)

These analyses use **phi** and **theta** from the **joint phi** approach (discovery mode):
- **Location**: `/Dropbox/enrollment_retrospective_full/`
- **Generated by**: `run_full_retrospective.sh` ‚Üí `run_aladyn_batch.py` (joint phi fitting)
- **Mode**: Discovery - phi is learned from data
- **FH Analysis** (`fh_analysis_summary.ipynb`, `R1_Q3_Clinical_Meaning.ipynb`)
  - Uses: `thetas_with_pcs_retrospective.pt` (from joint fitting)
  - **Status**: ‚úÖ No rerun needed
  
- **IPW Analysis** (`ipw_analysis_summary.ipynb`, `R1_Q1_Selection_Bias.ipynb`)
  - Uses: Weighted phi from joint fitting
  - **Status**: ‚úÖ No rerun needed
  
- **Heritability Analysis** (`heritability_analysis_summary.ipynb`, `R1_Q7_Heritability.ipynb`)
  - Uses: GWAS results from signatures (phi/theta)
  - **Status**: ‚úÖ No rerun needed
  
- **Heterogeneity/Pathway Analysis** (`heterogeneity_analysis_summary.ipynb`, `R3_Q8_Heterogeneity.ipynb`)
  - Uses: `thetas_with_pcs_retrospective.pt` (from joint fitting)
  - **Status**: ‚úÖ No rerun needed

---

## üîÑ Needs Rerun (Prediction - Fixed Phi)

**IMPORTANT**: Only **age offset** batches are being regenerated due to **gamma initialization fix**.

### 1. **Washout Analyses** (`R2_Temporal_Leakage.ipynb`)
- **Scripts**: 
  - `generate_washout_predictions.py`
  - `generate_washout_time_horizons.py`
- **Uses**: `pi_enroll_fixedphi_sex_*.pt` (from `run_aladyn_predict_with_master.py`)
- **Status**: ‚úÖ **NO RERUN NEEDED** - Already had correct gamma initialization

### 2. **Age Offset Analyses** (`R1_Q2_Lifetime_Risk.ipynb`, `R1_Q10_Age_Specific.ipynb`) ‚ö†Ô∏è
- **Scripts**:
  - `generate_age_offset_predictions.py`
  - `analyze_age_offset_signatures.py`
- **Uses**: `pi_enroll_fixedphi_age_offset_*_sex_*.pt` (from `forAWS_offsetmasterfix.py`)
- **Status**: üîÑ **NEEDS RERUN** - Gamma initialization fix applied
- **Reason**: Added `model.initialize_params(init_psi=...)` to match `run_aladyn_predict_with_master.py`

### 3. **AUC Comparisons** (`R1_Q9_AUC_Comparisons.ipynb`)
- **Scripts**:
  - `compare_with_external_scores.py` (PCE, PREVENT, QRISK3)
  - `compare_with_cox_baseline.py`
- **Uses**: `pi_enroll_fixedphi_sex_*.pt` or `pi_full_400k.pt`
- **Status**: ‚úÖ **NO RERUN NEEDED** - Uses washout pi tensors (unchanged)

### 4. **Prediction Drops Analysis**
- **Scripts**:
  - `analyze_prediction_drops.py`
  - `visualize_prediction_drops.py`
- **Uses**: `pi_enroll_fixedphi_sex_*.pt` (washout comparisons)
- **Status**: ‚úÖ **NO RERUN NEEDED** - Uses washout pi tensors (unchanged)

### 5. **Time Horizon Predictions**
- **Scripts**:
  - `generate_time_horizon_predictions.py`
- **Uses**: `pi_enroll_fixedphi_sex_*.pt`
- **Status**: ‚úÖ **NO RERUN NEEDED** - Uses washout pi tensors (unchanged)

---

## üìã Summary

| Analysis Type | Uses | Mode | Location | Needs Rerun? | Reason |
|---------------|------|------|----------|--------------|--------|
| **Discovery** (FH, IPW, Heritability, Heterogeneity) | phi, theta | Joint phi (learned) | `/Dropbox/enrollment_retrospective_full/` | ‚ùå No | Already fit with `run_full_retrospective.sh` |
| **Washout Predictions** | pi tensors | Fixed phi (from master) | `/Dropbox/models_fromAWS_.../` | ‚ùå No | Already had correct gamma initialization |
| **Age Offset Predictions** | pi tensors | Fixed phi (from master) | `/Dropbox/models_fromAWS_.../` | ‚úÖ **YES** | **Gamma initialization fix applied** |
| **AUC Comparisons** | pi tensors | Fixed phi (from master) | `/Dropbox/models_fromAWS_.../` | ‚ùå No | Uses washout pi tensors (unchanged) |

---

## üéØ What You're Regenerating

**Only age offset batches** are being regenerated due to **gamma initialization fix**:

- ‚úÖ **Washout pi tensors**: Already correct (no rerun)
  - `pi_enroll_fixedphi_sex_*.pt` (from `run_aladyn_predict_with_master.py`)
  - Already had correct gamma initialization
  
- üîÑ **Age offset pi tensors**: Being regenerated (gamma fix)
  - `pi_enroll_fixedphi_age_offset_*_sex_*.pt` (from `forAWS_offsetmasterfix.py`)
  - **Fix applied**: Added `model.initialize_params(init_psi=...)` to match washout script
  - **Reason**: Ensures consistent gamma initialization between age offset and washout predictions

---

## ‚úÖ Next Steps

1. **Verify new pi tensors exist**:
   ```bash
   ls -lh /path/to/pi_enroll_fixedphi_sex_*.pt
   ls -lh /path/to/pi_enroll_fixedphi_age_offset_*_sex_*.pt
   ```

2. **Rerun age offset analyses** (only these need rerun):
   - Age offset predictions (being regenerated on AWS/local)
   - Age offset signature analyses (`analyze_age_offset_signatures.py`)
   - Any comparisons using age offset pi tensors
   
   **Note**: Washout, AUC comparisons, and prediction drops don't need rerun (they use unchanged washout pi tensors)

3. **Update notebooks** that reference old pi tensor paths

---

## üîç How to Check What Uses What

**Discovery analyses** (no rerun - uses joint phi):
- **Location**: `/Dropbox/enrollment_retrospective_full/`
- **Files**: `enrollment_model_W0.0001_batch_*_*.pt` (contains learned phi)
- **Outputs**: `thetas_with_pcs_retrospective.pt` (derived from joint fitting)
- **Scripts**: `analyze_fh_carriers_signature.py`, `analyze_chip_carriers_signature.py`
- **Mode**: Joint phi - phi is learned from data

**Prediction analyses** (needs rerun - uses fixed phi):
- **Location**: `/Dropbox/models_fromAWS_enrollment_predictions_fixedphi_RETROSPECTIVE_pooled/`
- **Files**: `pi_enroll_fixedphi_sex_*.pt`, `pi_enroll_fixedphi_age_offset_*_sex_*.pt`
- **Scripts**: `generate_washout_predictions.py`, `generate_age_offset_predictions.py`
- **Mode**: Fixed phi - phi is fixed from master checkpoints, only lambda estimated
- Scripts: `generate_washout_predictions.py`, `generate_age_offset_predictions.py`, `compare_with_external_scores.py`

