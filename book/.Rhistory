icdlab=readRDS("~/Library/CloudStorage/Dropbox-Personal/")
# load UK Biobank date of death and loss-to-follow-up
# data to define follow-up time
message("###load UK Biobank censor and HES data up to Spring 2020###")
#####################################################
dfukb_baseline_pheno=data.frame(readRDS("~/Library/CloudStorage/Dropbox-Personal/pheno_dir/output/dfukb_baseline_pheno.rds"))
england<-c("10003","11001","11002","11007","11008","11009","11010","11011","11012","11013","11014","11016","11017","11018","11019","11020","11021")
scotland<-c("11004","11005")
wales<-c("11003","11022", "11006","11023")
# from https://biobank.ndph.ox.ac.uk/ukb/exinfo.cgi?src=Data_providers_and_dates
dfukb_baseline_pheno[dfukb_baseline_pheno$f.54.0.0 %in% england,"censordateHES"]<-as.Date("2022-10-31")
dfukb_baseline_pheno[dfukb_baseline_pheno$f.54.0.0 %in% scotland,"censordateHES"]<-as.Date("2022-08-31")
dfukb_baseline_pheno[dfukb_baseline_pheno$f.54.0.0 %in% wales,"censordateHES"]<-as.Date("2022-05-31")
dfukb_baseline_pheno$death_censor_date=as.Date("2022-11-30")
bd.censor=dfukb_baseline_pheno %>%
dplyr::rename(f.eid = identifier) %>%
dplyr::select(f.eid, f.53.0.0, censordateHES, death_censor_date,reference_date)
library(dplyr)
bd.censor=dfukb_baseline_pheno %>%
dplyr::rename(f.eid = identifier) %>%
dplyr::select(f.eid, f.53.0.0, censordateHES, death_censor_date,reference_date)
colnames(bd.censor)=c("f.eid","enroll_date","phenotype_censor_date","death_censor_date","birthdate")
bd.censor$phenotype_censor_date <- ymd(bd.censor$phenotype_censor_date)
library(PheWAS)
library(data.table)
library(stringr)
library(stringi)
library(lubridate)
library(AgeTopicModels)
library(dplyr)
library(tidyr)
bd.censor=dfukb_baseline_pheno %>%
dplyr::rename(f.eid = identifier) %>%
dplyr::select(f.eid, f.53.0.0, censordateHES, death_censor_date,reference_date)
colnames(bd.censor)=c("f.eid","enroll_date","phenotype_censor_date","death_censor_date","birthdate")
bd.censor$phenotype_censor_date <- ymd(bd.censor$phenotype_censor_date)
bd.censor$enroll_date <- ymd(bd.censor$enroll_date)
bd_diag <- fread("~/Documents/hesin_May2023//hesin_diag.txt.gz")
bd_diag <- bd_diag %>%
rename(f.eid = eid)
bd_diag[bd_diag == ""] <- NA
bd_hes <- fread("~/Documents/hesin_May2023/hesin.txt.gz")
bd_hes[bd_hes == ""] <- NA
bd_hes <- bd_hes %>%
dplyr::select(eid, ins_index, epistart, admidate) %>%
mutate(event_start = case_when(!is.na(epistart) ~ epistart,
is.na(epistart) ~ admidate)) %>%
dplyr::select(-epistart, -admidate) %>%
rename(f.eid = eid)
bd_hes$event_start <- dmy(bd_hes$event_start)
bd_hes <- bd_hes %>%
filter(!is.na(event_start)) %>%
filter(event_start <= as.Date("2022-10-31")) ## use dates here https://biobank.ndph.ox.ac.uk/ukb/exinfo.cgi?src=Data_providers_and_dates
bd_hes <- bd_hes %>%
left_join(bd_diag, by = c("f.eid", "ins_index")) %>%
mutate(vocabulary_id = case_when(!is.na(diag_icd10) ~ "ICD10CM",
is.na(diag_icd10) &
!is.na(diag_icd10_nb) ~ "ICD10CM",
is.na(diag_icd10) & is.na(diag_icd10_nb) &
!is.na(diag_icd9) ~ "ICD9CM")) %>%
mutate(code = case_when(!is.na(diag_icd10) ~ as.character(diag_icd10),
is.na(diag_icd10) &
!is.na(diag_icd10_nb) ~ as.character(diag_icd10_nb),
is.na(diag_icd10) & is.na(diag_icd10_nb) &
!is.na(diag_icd9) ~
as.character(diag_icd9)))
# subset and annotate ICD10 data
icd10 <- bd_hes %>%
filter(vocabulary_id == "ICD10CM") %>%
dplyr::select(f.eid, event_start, ins_index, arr_index, level,
vocabulary_id, code) %>%
filter(!str_detect(code, "^S")) %>% # remove XIX Injury, poisoning and certain other consequences of external causes
filter(!str_detect(code, "^T")) %>% # remove XIX Injury, poisoning and certain other consequences of external causes
filter(!str_detect(code, "^V")) %>% # remove Chapter XX External causes of morbidity and mortality
filter(!str_detect(code, "^W")) %>% # remove Chapter XX External causes of morbidity and mortality
filter(!str_detect(code, "^X")) %>% # remove Chapter XX External causes of morbidity and mortality
filter(!str_detect(code, "^Y")) %>% # remove Chapter XX External causes of morbidity and mortality
filter(!str_detect(code, "^Z")) %>% # remove Chapter XXI Factors influencing health status and contact with health services
filter(!str_detect(code, "^U")) %>% # remove Chapter XXII Codes for special purposes
mutate(code_char = nchar(code))
#
## to use with atm
###
## we don't want the period
d=dplyr::right_join(bd.censor[,c("f.eid","birthdate")],icd10,by="f.eid")
d$age=round(as.numeric(difftime(d$event_start,d$birthdate,units="days")/365.25),1)
head(d)
head(dfukb_baseline_pheno)
head(d)
merge(d,dfukb_baseline_pheno[,c("identifier","f.53.0.0")])
dm=merge(d,dfukb_baseline_pheno[,c("identifier","f.53.0.0")])
AgeTopicModels::icd2phecode()
AgeTopicModels::icd2phecode
bd.censor=dfukb_baseline_pheno %>%
dplyr::rename(f.eid = identifier) %>%
dplyr::select(f.eid, f.53.0.0, censordateHES, death_censor_date,reference_date)
colnames(bd.censor)=c("f.eid","enroll_date","phenotype_censor_date","death_censor_date","birthdate")
bd.censor$phenotype_censor_date <- ymd(bd.censor$phenotype_censor_date)
bd.censor$enroll_date <- ymd(bd.censor$enroll_date)
# Save bd.censor for Python
write.csv(bd.censor, "~/Library/CloudStorage/Dropbox-Personal/bd_censor.csv", row.names=FALSE)
## we don't want the period
d=dplyr::right_join(bd.censor[,c("f.eid","birthdate")],icd10,by="f.eid")
d$age=round(as.numeric(difftime(d$event_start,d$birthdate,units="days")/365.25),1)
hes_for_atm=d[,c("f.eid","code","age")]
names(hes_for_atm)=names(HES_icd10_example)
i=icd2phecode(hes_for_atm)
iload=readRDS("~/Dropbox-Personal/icd10phe_lab.rds")
all.equal(iload,i)
icdlab$age_diag=round(icdlab$age_diag)
icdlab=readRDS("~/Dropbox-Personal/icd10phe_lab.rds")
icdlab$age_diag=round(icdlab$age_diag)
dim(icdlab)
icdlab=icdlab[icdlab$diag_icd10%in%AgeTopicModels::UKB_349_disease$diag_icd10,]
length(unique(icdlab$diag_icd10))
dim(icdlab)
head(icdlab)
prs=readRDS("~/Library/CloudStorage//Dropbox-Personal//pheno_dir/prs_subset.rds")
# Intersect ICD data with PRS first
person_ids=intersect(prs$Identifier,icdlab$eid)
# Store the actual IDs and ICD codes in order
prs=prs[prs$Identifier%in%person_ids,]
all.equal(as.character(rownames(prs)),as.character(person_ids))
G=prs[,-37]
id_map <- setNames(seq_len(length(person_ids)), person_ids)
disease_map <- setNames(seq_len(length(disease_codes)), disease_codes)
AgeTopicModels::UKB_349_disease
head(AgeTopicModels::UKB_349_disease)
dc=readRDS("~/Library/CloudStorage/Dropbox-Personal/sparse_array.rds")
dc=readRDS("~/Downloads//sparse_array.rds")
head(dc)
names(dc)
names(dc[[1]])
dc[[1]][1]
str(dc)
dc[[1]]
dim(dc[[1]])
colnames(dc[[1]])
AgeTopicModels::UKB_349_disease
diags=AgeTopicModels::UKB_349_disease$diag_icd10
colnames(dc[[1]])
all.equal(colnames(dc[[1]]),diags[1:348,1]
)
str(diags)
all.equal(colnames(dc[[1]]),diags)
all.equal(colnames(dc[[1]]),diags[1:348])
all.equal(as.numeric(colnames(dc[[1]])(),diags[1:348])
all.equal(as.numeric(colnames(dc[[1]]),diags[1:348])
)
all.equal(as.numeric(colnames(dc[[1]])),diags[1:348])
disease_codes=AgeTopicModels::UKB_349_disease$diag_icd10[1:348
]
all.equal(as.character(disease_codes),colnames(dc[[1]]))
person_ids=intersect(prs$Identifier,icdlab$eid)
# Store the actual IDs and ICD codes in order
# Create mapping dictionaries with names preserved
id_map <- setNames(seq_len(length(person_ids)), person_ids)
disease_map <- setNames(seq_len(length(disease_codes)), disease_codes)
icdlab=icdlab[icdlab$eid%in%person_ids,]
saveRDS(icdlab,"~/Dropbox-Personal/icdlab_personidint.rds")
ci=fread("~/Library/CloudStorage/Dropbox-Personal/data_for_running/baselinagefamh.csv")
head(ci)
head(bd_hes)
head(bd.censor)
bd_diag <- fread("~/Documents/hesin_May2023//hesin_diag.txt.gz")
bd_diag <- bd_diag %>%
rename(f.eid = eid)
bd_diag[bd_diag == ""] <- NA
bd_hes <- fread("~/Documents/hesin_May2023/hesin.txt.gz")
bd_hes[bd_hes == ""] <- NA
bd_hes <- bd_hes %>%
dplyr::select(eid, ins_index, epistart, admidate) %>%
mutate(event_start = case_when(!is.na(epistart) ~ epistart,
is.na(epistart) ~ admidate)) %>%
dplyr::select(-epistart, -admidate) %>%
rename(f.eid = eid)
bd_hes$event_start <- dmy(bd_hes$event_start)
bd_hes <- bd_hes %>%
filter(!is.na(event_start)) %>%
filter(event_start <= as.Date("2022-10-31")) ## use dates here https://biobank.ndph.ox.ac.uk/ukb/exinfo.cgi?src=Data_providers_and_dates
bd_hes <- bd_hes %>%
left_join(bd_diag, by = c("f.eid", "ins_index")) %>%
mutate(vocabulary_id = case_when(!is.na(diag_icd10) ~ "ICD10CM",
is.na(diag_icd10) &
!is.na(diag_icd10_nb) ~ "ICD10CM",
is.na(diag_icd10) & is.na(diag_icd10_nb) &
!is.na(diag_icd9) ~ "ICD9CM")) %>%
mutate(code = case_when(!is.na(diag_icd10) ~ as.character(diag_icd10),
is.na(diag_icd10) &
!is.na(diag_icd10_nb) ~ as.character(diag_icd10_nb),
is.na(diag_icd10) & is.na(diag_icd10_nb) &
!is.na(diag_icd9) ~
as.character(diag_icd9)))
# subset and annotate ICD10 data
icd10 <- bd_hes %>%
filter(vocabulary_id == "ICD10CM") %>%
dplyr::select(f.eid, event_start, ins_index, arr_index, level,
vocabulary_id, code) %>%
filter(!str_detect(code, "^S")) %>% # remove XIX Injury, poisoning and certain other consequences of external causes
filter(!str_detect(code, "^T")) %>% # remove XIX Injury, poisoning and certain other consequences of external causes
filter(!str_detect(code, "^V")) %>% # remove Chapter XX External causes of morbidity and mortality
filter(!str_detect(code, "^W")) %>% # remove Chapter XX External causes of morbidity and mortality
filter(!str_detect(code, "^X")) %>% # remove Chapter XX External causes of morbidity and mortality
filter(!str_detect(code, "^Y")) %>% # remove Chapter XX External causes of morbidity and mortality
filter(!str_detect(code, "^Z")) %>% # remove Chapter XXI Factors influencing health status and contact with health services
filter(!str_detect(code, "^U")) %>% # remove Chapter XXII Codes for special purposes
mutate(code_char = nchar(code))
#
## to use with atm
###
## we don't want the period
d=dplyr::right_join(bd.censor[,c("f.eid","birthdate")],icd10,by="f.eid")
d$age=round(as.numeric(difftime(d$event_start,d$birthdate,units="days")/365.25),1)
hes_for_atm=d[,c("f.eid","code","age")]
names(hes_for_atm)=names(HES_icd10_example)
head(d)
head(bd.censor)
saveRDS(d, "~/Library/CloudStorage//Dropbox-Personal/hesin_with_dates.rds")
icdlab=readRDS("~/Dropbox-Personal/icd10phe_lab.rds")
icdlab$age_diag=round(icdlab$age_diag)
dim(icdlab)
icdlab=icdlab[icdlab$diag_icd10%in%AgeTopicModels::UKB_349_disease$diag_icd10,]
length(unique(icdlab$diag_icd10))
dim(icdlab)
head(icdlab)
disease_codes=AgeTopicModels::UKB_349_disease$diag_icd10[1:348]
person_ids=intersect(prs$Identifier,icdlab$eid)
# Store the actual IDs and ICD codes in order
id_map <- setNames(seq_len(length(person_ids)), person_ids)
disease_map <- setNames(seq_len(length(disease_codes)), disease_codes)
icdlab=icdlab[icdlab$eid%in%person_ids,]
saveRDS(icdlab, "~/Library/CloudStorage//Dropbox-Personal/hesin_phecoded.rds")
head(icdlab[icdlab$eid%in%1000833,])
head(icdlab[icdlab$eid%in%1001140,])
icdlab[icdlab$eid%in%1001140,]
icdlab[icdlab$eid%in%1001140&icdlab$diag_icd10%in%530.11,]
npm=readRS("~/aladynoulli2/noulli_mapped_phecode_icd10cm.rds")
npm=readRDS("~/aladynoulli2/noulli_mapped_phecode_icd10cm.rds")
head(npm)
dim(npm)
length(unique(npm$phenotype))
write.csv(npm,"~/aladynoulli2/icd10cm_phecode_mapp.csv",quote = FALSE,row.names = FALSE)
write.csv(npm,"~/aladynoulli2/icd10cm_phecode_map.csv",row.names = FALSE)
icdlab=readRDS("~/Dropbox-Personal/icd10phe_lab.rds")
head(icdlab)
length(unique(icdlab$diag_icd10))
a=readRDS("/Users/sarahurbut/aladynoulli2/noulli_mapped_phecode_icd10cm.rds")
head(a)
library(AgeTopicModels)
AgeTopicModels::phecode_icd10cm
length(unique(a$phecode))
length(unique(AgeTopicModels::phecode_icd10cm$phecode))
length(unique(AgeTopicModels::phecode_icd10cm$ICD10))
b=AgeTopicModels::phecode_icd10cm[AgeTopicModels::phecode_icd10cm$phecode%in%AgeTopicModels::UKB_349_disease$diag_icd10,]
dim(b)
dim(a)
head(a)
head(b)
clear
dx=fread("/Users/sarahurbut/Downloads/swc51_010326185100580905_6390319843947805791-1_Dia.txt")
library(data.table)
dx=fread("/Users/sarahurbut/Downloads/swc51_010326185100580905_6390319843947805791-1_Dia.txt")
head(dx)
dim(dx)
grep(x = dx$Diagnosis_Name,pattern = "Anorexia")
dx[grep(x = dx$Diagnosis_Name,pattern = "Anorexia"),]
dx[grep(x = dx$Diagnosis_Name,pattern = "Anorexia nervosa"),]
an=dx[grep(x = dx$Diagnosis_Name,pattern = "Anorexia nervosa"),]
dem=fread("~/Downloads/swc51_010326185100580905_6390319843947805791-1_Dem.txt")
head(dem)
m=merge(an,dem,by="EMPI",all.x = TRUE)
head(m)
dim(m)
summary(m$Age)
m[m$Age<50]
m[m$Age<50,]
m=m[m$Age<50,]
dim(m)
length(unique(m$EMPI))
m[m$EMPI%in%unique(m$EMPI),]
m95=m[m$EMPI%in%unique(m$EMPI),]
m95
unique(m95)
dem[dem$EMPI%in%unique(m95$EMPI),]
g=readRDS(""~/Library/CloudStorage/Dropbox-Personal/mgbbtopic/G_sub.rds"")
g=readRDS("~/Library/CloudStorage/Dropbox-Personal/mgbbtopic/G_sub.rds")
head(g)
dim(g)
p=readRDS("~/Library/CloudStorage/Dropbox-Personal/mgbbtopic/peoplenames.rds")
head(p)
dim(p)
length(p)
prs=readRDS("~/Library/CloudStorage/Dropbox-Personal/mgbbtopic/prs_names.rds")
dim(prs)
prs
y=readRDS("~/Library/CloudStorage/Dropbox-Personal/mgbbtopic/Y_sub.rds")
dim(y)
names(y)
y
rownames(g)=names(Y[1,,])
dim(y)
rownames(y)
rownames(g)=rownames(y)
head(g)
g$EMPI=rownames(y)
g[g$EMPI%in%unique(m95$EMPI)]
g95=g[g$EMPI%in%unique(m95$EMPI),]
head(g95)
dim(g95)
summary(g95)
dim(g)
summary(g)
gnorm=apply(g,2,scale)
class(g)
gnorm=apply(g[,-37],2,scale)
head(gnrom)
head(gnrom)
head(gnorm)
g95=gnorm[gnorm$EMPI%in%unique(m95$EMPI),]
gnorm$EMPI=g$EMPI
gnorm
gnorm=data.frame(apply(g,2,scale))
gnorm=data.frame(apply(g[,-37],2,scale))
gnorm$EMPI=g$EMPI
g95=gnorm[gnorm$EMPI%in%unique(m95$EMPI),]
summary(g95)
install.packages("mcmcpack")
install.packages("MCMCpack")
names(hes_for_atm)=names(HES_icd10_exampl
sig=fread("~/Downloads/signature_auc_phenotypes.txt")
head(sig)
hist(sig$SIG5_AUC)
hist(sig$SIG5_AUC,nclass = 100)
# In R
setwd("/Users/sarahurbut/aladynoulli2/book")
bookdown::render_book("index.Rmd", "bookdown::gitbook")
install.packages("bookdown")
# In R
setwd("/Users/sarahurbut/aladynoulli2/book")
bookdown::render_book("index.Rmd", "bookdown::gitbook")
# In R
setwd("/Users/sarahurbut/aladynoulli2/book")
bookdown::render_book("index.Rmd", "bookdown::gitbook")
# In R
setwd("/Users/sarahurbut/aladynoulli2/book")
bookdown::render_book("index.Rmd", "bookdown::gitbook")
#install.packages("devtools")
#It may be necessary to install required as not all package dependencies are installed by devtools:
#install.packages(c("dplyr","tidyr","ggplot2","MASS","meta","ggrepel","DT"))
#devtools::install_github("PheWAS/PheWAS")
library(PheWAS)
library(data.table)
library(stringr)
library(stringi)
library(lubridate)
library(AgeTopicModels)
library(dplyr)
library(tidyr)
#####################################################
# load UK Biobank date of death and loss-to-follow-up
# data to define follow-up time
message("###load UK Biobank censor and HES data up to Spring 2020###")
#####################################################
dfukb_baseline_pheno=data.frame(readRDS("~/Library/CloudStorage/Dropbox-Personal/pheno_dir/output/dfukb_baseline_pheno.rds"))
england<-c("10003","11001","11002","11007","11008","11009","11010","11011","11012","11013","11014","11016","11017","11018","11019","11020","11021")
scotland<-c("11004","11005")
wales<-c("11003","11022", "11006","11023")
# from https://biobank.ndph.ox.ac.uk/ukb/exinfo.cgi?src=Data_providers_and_dates
dfukb_baseline_pheno[dfukb_baseline_pheno$f.54.0.0 %in% england,"censordateHES"]<-as.Date("2022-10-31")
dfukb_baseline_pheno[dfukb_baseline_pheno$f.54.0.0 %in% scotland,"censordateHES"]<-as.Date("2022-08-31")
dfukb_baseline_pheno[dfukb_baseline_pheno$f.54.0.0 %in% wales,"censordateHES"]<-as.Date("2022-05-31")
dfukb_baseline_pheno$death_censor_date=as.Date("2022-11-30")
bd.censor=dfukb_baseline_pheno %>%
dplyr::rename(f.eid = identifier) %>%
dplyr::select(f.eid, f.53.0.0, censordateHES, death_censor_date,reference_date)
colnames(bd.censor)=c("f.eid","enroll_date","phenotype_censor_date","death_censor_date","birthdate")
bd.censor$phenotype_censor_date <- ymd(bd.censor$phenotype_censor_date)
bd.censor$enroll_date <- ymd(bd.censor$enroll_date)
hesin_with_dates=readRDS("~/Library/CloudStorage//Dropbox-Personal/hesin_with_dates.rds")
head(hesin_with_dates)
length(uniqeu(hesin_with_dates))
library(AgeTopicModels)
m=merge(hesin_with_dates,AgeTopicModels::disease_info_phecode_icd10m,by.x=code,all.x=T)
m=merge(hesin_with_dates,AgeTopicModels::phecode_icd10cm,by.x=code,all.x=T)
m=merge(hesin_with_dates,AgeTopicModels::phecode_icd10cm,by.x="code",by.y="ICD10",all.x=T)
head(M)
head(m)
library(dplyr)
m%>%group_by(phecode)%>%summarise(l=length(unique(f.eid)))
t=m%>%group_by(phecode)%>%summarise(l=length(unique(f.eid)))
head(t)
sum(t$l>100)
sum(t$l>1000)
sum(t$l>1100)
head(m)
m=m[m$age<80&m$age>30,]
t=m%>%group_by(phecode)%>%summarise(l=length(unique(f.eid)))
sum(t$l>1100)
sum(t$l>1000)
